# 매수 쿼리 가이드

## 📋 목차
1. [개요](#개요)
2. [테이블별 쿼리](#테이블별-쿼리)
3. [통합 매수 추천 쿼리](#통합-매수-추천-쿼리)
4. [쿼리 사용 방법](#쿼리-사용-방법)
5. [매수 조건 상세 설명](#매수-조건-상세-설명)

---

## 개요

주식 자동 매매 시스템에서 사용하는 매수 추천 쿼리를 테이블별로 정리한 문서입니다.
각 테이블은 서로 다른 분석 기준을 제공하며, 이를 통합하여 최종 매수 결정을 내립니다.

### 주요 테이블
| 테이블명 | 역할 | 쿼리 파일 |
|---------|------|----------|
| `stock_recommendations` | 기술적 지표 분석 | `stock_recommendations_query.sql` |
| `stock_analysis_results` | AI 주가 예측 | `stock_analysis_results_query.sql` |
| `ticker_sentiment_analysis` | 뉴스 감정 분석 | `ticker_sentiment_analysis_query.sql` |
| **통합 쿼리** | **전체 데이터 통합** | **`combined_buy_recommendation_query.sql`** |

---

## 테이블별 쿼리

### 1️⃣ stock_recommendations (기술적 지표)
**파일**: `queries/stock_recommendations_query.sql`

#### 조건
- **골든크로스** = true (SMA20 > SMA50) → 가중치 **1.5점**
- **RSI** < 50 (과매도 구간) → 가중치 **1.0점**
- **MACD 매수신호** = true (MACD > Signal) → 가중치 **1.0점**

#### 매수 기준
- 기술적 신호 점수 **≥ 2.0점** (3개 중 2개 이상 충족)

#### 주요 컬럼
```sql
- 종목, 날짜
- SMA20, SMA50, 골든_크로스
- RSI, MACD, Signal, MACD_매수_신호
- total_tech_score (기술적 점수)
- recommendation_level (추천 등급)
```

#### 추천 등급
| 등급 | 조건 |
|-----|------|
| 🔥 강력 매수 | 3개 모두 충족 (3.5점) |
| ✅ 매수 추천 | 골든크로스 포함 2.5점 이상 |
| ⚠️ 매수 고려 | 2.0~2.5점 |
| 📊 관망 | 2.0점 미만 |

---

### 2️⃣ stock_analysis_results (주가 예측)
**파일**: `queries/stock_analysis_results_query.sql`

#### 조건
- **정확도(Accuracy)** ≥ **80%**
- **상승확률(Rise Probability)** ≥ **3%**
- **Predicted Rise** = TRUE
- **예측 가격** > **현재 가격**

#### 매수 기준
- 정확도와 상승확률 모두 충족

#### 주요 컬럼
```sql
- Stock, Accuracy (%), Rise Probability (%)
- Last Actual Price, Predicted Future Price
- expected_return_pct (기대수익률)
- confidence_score (신뢰도 점수)
- prediction_level (예측 등급)
```

#### 예측 등급
| 등급 | 조건 |
|-----|------|
| 🔥 강력 매수 | 정확도 ≥ 90%, 상승확률 ≥ 10% |
| ✅ 매수 추천 | 정확도 ≥ 85%, 상승확률 ≥ 5% |
| ⚠️ 매수 고려 | 정확도 ≥ 80%, 상승확률 ≥ 3% |

---

### 3️⃣ ticker_sentiment_analysis (감정 분석)
**파일**: `queries/ticker_sentiment_analysis_query.sql`

#### 조건
- **평균 감정 점수** ≥ **0.15** (긍정적)
- **기사 수** ≥ **5개** (신뢰도 확보)

#### 매수 기준
- 긍정적 감정 + 충분한 기사 수

#### 주요 컬럼
```sql
- ticker, stock_name
- average_sentiment_score (감정 점수)
- article_count (기사 수)
- weighted_sentiment (가중 감정 점수)
- sentiment_level (감정 등급)
- reliability_level (신뢰도 등급)
```

#### 감정 등급
| 등급 | 감정 점수 범위 |
|-----|---------------|
| 🌟 매우 긍정적 | ≥ 0.30 |
| 😊 긍정적 | 0.20 ~ 0.29 |
| 🙂 다소 긍정적 | 0.15 ~ 0.19 |
| 😐 중립 | 0 ~ 0.14 |
| 😟 다소 부정적 | -0.15 ~ -0.01 |
| 😞 부정적 | -0.30 ~ -0.16 |
| 💀 매우 부정적 | < -0.30 |

#### 신뢰도 등급
| 등급 | 기사 수 |
|-----|---------|
| 매우 높음 | ≥ 20개 |
| 높음 | 10~19개 |
| 보통 | 5~9개 |
| 낮음 | < 5개 |

---

## 통합 매수 추천 쿼리

**파일**: `queries/combined_buy_recommendation_query.sql`

### 🎯 최종 매수 조건

#### 조건 1: 긍정적 감정 + 기술적 신호
```
감정 점수 ≥ 0.15 AND 기술적 신호 ≥ 2.0점
```
→ ✅ **매수 추천**

#### 조건 2: 강력한 기술적 신호
```
감정 점수 < 0.15 AND 기술적 신호 ≥ 3.5점 (3개 모두)
```
→ ✅ **매수 추천**

### 📊 종합 점수 계산

```
종합 점수 = 상승확률(30%) + 기술적지표(40%) + 감정점수(30%)
```

| 요소 | 가중치 | 계산 방식 |
|-----|-------|----------|
| 상승확률 | 30% | Rise Probability (%) × 0.3 |
| 기술적지표 | 40% | tech_signal_score × 10 × 0.4 |
| 감정점수 | 30% | sentiment_score × 100 × 0.3 |

### 🏆 매수 우선순위

| 우선순위 | 조건 | 설명 |
|---------|------|------|
| 1 (최우선) | 감정 ≥ 0.15 + 기술 ≥ 3.5 | 모든 조건 완벽 |
| 2 (높음) | 감정 ≥ 0.15 + 기술 ≥ 2.5 | 강한 긍정 신호 |
| 3 (보통) | 감정 ≥ 0.15 + 기술 ≥ 2.0 | 기본 매수 조건 |
| 4 (기술적) | 기술 ≥ 3.5 | 기술적 강세 |
| 5 (낮음) | 기타 | 관망 |

### 주요 출력 컬럼

```sql
-- 주식 정보
ticker, stock_name

-- 주가 예측 정보
accuracy, rise_probability, expected_return_pct

-- 기술적 지표 정보
golden_cross, rsi, macd_buy_signal, tech_signal_score

-- 감정 분석 정보
sentiment_score, article_count

-- 종합 분석
composite_score (종합 점수)
buy_decision (매수 결정)
priority (우선순위)
```

---

## 쿼리 사용 방법

### 1단계: 개별 테이블 확인

각 테이블의 상태를 개별적으로 확인합니다.

```bash
# 기술적 지표 확인
psql -f queries/stock_recommendations_query.sql

# 주가 예측 확인
psql -f queries/stock_analysis_results_query.sql

# 감정 분석 확인
psql -f queries/ticker_sentiment_analysis_query.sql
```

### 2단계: 통합 매수 추천 확인

모든 조건을 통합하여 최종 매수 추천 종목을 확인합니다.

```bash
# 최종 매수 추천 리스트
psql -f queries/combined_buy_recommendation_query.sql
```

### Supabase에서 실행

```python
from app.db.supabase import supabase

# 쿼리 파일 읽기
with open('queries/combined_buy_recommendation_query.sql', 'r') as f:
    query = f.read()

# 실행 (Supabase는 RPC 함수 필요)
# 직접 SQL 실행이 제한적이므로 Python 로직 사용 권장
```

### Python 코드에서 사용

```python
from app.services.stock_recommendation_service import StockRecommendationService

service = StockRecommendationService()

# 통합 매수 추천 (기존 메서드 사용)
result = service.get_combined_recommendations_with_technical_and_sentiment()

print(f"매수 추천: {result['message']}")
for stock in result['results']:
    print(f"{stock['stock_name']}: 종합 점수 {stock['composite_score']}")
```

---

## 매수 조건 상세 설명

### 🔍 기술적 지표 (Technical Indicators)

#### 1. 골든크로스 (Golden Cross)
- **정의**: 단기 이동평균(SMA20)이 장기 이동평균(SMA50)을 상향 돌파
- **의미**: 상승 추세 전환 신호
- **가중치**: 1.5점 (가장 중요한 신호)

#### 2. RSI (Relative Strength Index)
- **정의**: 상대강도지수, 과매수/과매도 판단
- **조건**: RSI < 50
- **의미**: 과매도 구간 진입, 반등 가능성
- **가중치**: 1.0점

#### 3. MACD (Moving Average Convergence Divergence)
- **정의**: MACD 선이 Signal 선을 상향 돌파
- **의미**: 매수 타이밍 신호
- **가중치**: 1.0점

### 📈 주가 예측 (Price Prediction)

#### 정확도 (Accuracy)
- **정의**: AI 모델의 예측 정확도
- **조건**: ≥ 80%
- **의미**: 예측 신뢰도가 높음

#### 상승확률 (Rise Probability)
- **정의**: 주가 상승 예측 확률
- **조건**: ≥ 3%
- **의미**: 상승 가능성이 충분함

### 💬 감정 분석 (Sentiment Analysis)

#### 평균 감정 점수
- **정의**: 뉴스 기사의 평균 감정 점수
- **범위**: -1.0 (매우 부정) ~ +1.0 (매우 긍정)
- **조건**: ≥ 0.15
- **의미**: 시장 심리가 긍정적

#### 기사 수
- **정의**: 분석된 뉴스 기사 개수
- **조건**: ≥ 5개
- **의미**: 충분한 데이터로 신뢰도 확보

---

## 📊 데이터 흐름도

```
┌─────────────────────────────┐
│  stock_analysis_results     │
│  (AI 주가 예측)              │
│  - 정확도 ≥ 80%             │
│  - 상승확률 ≥ 3%            │
└──────────┬──────────────────┘
           │
           ▼
┌─────────────────────────────┐
│  stock_recommendations      │
│  (기술적 지표)               │
│  - 골든크로스               │
│  - RSI < 50                 │
│  - MACD 매수신호            │
└──────────┬──────────────────┘
           │
           ▼
┌─────────────────────────────┐
│  ticker_sentiment_analysis  │
│  (감정 분석)                 │
│  - 감정 점수 ≥ 0.15         │
│  - 기사 수 ≥ 5              │
└──────────┬──────────────────┘
           │
           ▼
┌─────────────────────────────┐
│  stock_ticker_mapping       │
│  (티커 매핑)                 │
│  - 활성화된 주식만          │
│  - ETF 제외                 │
└──────────┬──────────────────┘
           │
           ▼
    ═══════════════
    ║  통합 분석  ║
    ═══════════════
           │
           ▼
┌─────────────────────────────┐
│  종합 점수 계산              │
│  - 상승확률 30%             │
│  - 기술적지표 40%           │
│  - 감정점수 30%             │
└──────────┬──────────────────┘
           │
           ▼
┌─────────────────────────────┐
│  최종 매수 추천 리스트      │
│  - 우선순위별 정렬          │
│  - 종합 점수순 정렬         │
└─────────────────────────────┘
```

---

## 🎯 실전 활용 가이드

### 시나리오 1: 빠른 매수 추천
```sql
-- combined_buy_recommendation_query.sql 실행
-- 우선순위 1~3만 확인
```
→ 종합 점수가 가장 높은 종목에 투자

### 시나리오 2: 기술적 분석 중심
```sql
-- stock_recommendations_query.sql 실행
-- total_tech_score >= 3.0 이상만 필터링
```
→ 기술적으로 강한 종목에 투자

### 시나리오 3: AI 예측 중심
```sql
-- stock_analysis_results_query.sql 실행
-- rise_probability >= 10% 이상만 필터링
```
→ 상승 확률이 매우 높은 종목에 투자

### 시나리오 4: 감정 분석 중심
```sql
-- ticker_sentiment_analysis_query.sql 실행
-- average_sentiment_score >= 0.25 이상만 필터링
```
→ 시장 심리가 매우 긍정적인 종목에 투자

---

## ⚠️ 주의사항

1. **데이터 최신성 확인**
   - 각 테이블의 `created_at`, `calculation_date` 확인
   - 오래된 데이터는 신뢰도가 낮을 수 있음

2. **NULL 값 처리**
   - 감정 분석 데이터가 없는 경우 `COALESCE()`로 0 처리
   - 기술적 지표 데이터가 없는 경우 해당 종목 제외

3. **임계값 조정**
   - 시장 상황에 따라 조건 완화/강화 가능
   - 백테스팅을 통한 최적 임계값 탐색 권장

4. **리스크 관리**
   - 한 종목에 과도한 집중 투자 지양
   - 분산 투자 원칙 준수

---

## 📝 쿼리 파일 목록

| 파일명 | 설명 |
|-------|------|
| `stock_recommendations_query.sql` | 기술적 지표 매수 쿼리 |
| `stock_analysis_results_query.sql` | 주가 예측 매수 쿼리 |
| `ticker_sentiment_analysis_query.sql` | 감정 분석 매수 쿼리 |
| `combined_buy_recommendation_query.sql` | 통합 매수 추천 쿼리 ⭐ |

---

## 📞 문의 및 지원

쿼리 관련 문의사항이나 개선 제안이 있으시면 이슈를 등록해주세요.


