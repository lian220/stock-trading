# 추천 시스템 전체 가이드

## 📊 시스템 개요

이 프로젝트는 **4가지 분석 방법**을 통해 미국 주식 매수/매도를 추천하고, 자동으로 거래를 실행하는 시스템입니다.

## 🎯 4가지 분석 방법

### 1. 📈 기술적 지표 분석 (Technical Analysis)
**파일**: `app/services/stock_recommendation_service.py` → `generate_technical_recommendations()`

#### 분석 지표
| 지표 | 설명 | 매수 신호 | 매도 신호 |
|-----|------|----------|----------|
| **SMA (Simple Moving Average)** | 단순 이동평균선 | 골든 크로스 (SMA20 > SMA50) | 데드 크로스 (SMA20 < SMA50) |
| **RSI (Relative Strength Index)** | 상대 강도 지수 | RSI < 50 (매수 영역) | RSI > 70 (과매수) |
| **MACD** | 이동평균 수렴확산 | MACD > Signal | MACD < Signal |

> **참고**: RSI < 30은 과매도, RSI > 70은 과매수로 일반적으로 알려져 있으나, 이 시스템에서는 **RSI < 50**을 매수 신호로 사용합니다. (중립 기준 이하)

#### 데이터 저장
- **Supabase**: `stock_recommendations` 테이블
- **MongoDB**: 
  - `stock_recommendations` 컬렉션 (종목별 시계열 조회용)
  - `daily_stock_data.recommendations` 필드 (날짜별 통합 조회용)
- **갱신 주기**: 매일 오후 8시 (미국 동부 시간)
- **대상**: 34개 미국 주식 (ETF 제외)
- **저장 시간**: `created_at`, `updated_at` 자동 저장

---

### 2. 🤖 AI 주가 예측 (AI Prediction)
**파일**: `predict.py` (Jupyter/Colab), `app/services/stock_recommendation_service.py` → `get_stock_recommendations()`

#### 예측 모델
- **모델**: Transformer 기반 딥러닝 모델
- **입력 데이터**: 과거 90일 주가 + 39개 경제 지표
- **예측 기간**: 14일 후 주가
- **학습 데이터**: 80% 학습 / 20% 검증

#### 평가 지표
| 지표 | 설명 | 매수 기준 |
|-----|------|----------|
| **Accuracy** | 예측 정확도 (100 - MAPE) | ≥ 80% |
| **Rise Probability** | 상승 확률 | ≥ 3% |
| **MAPE** | 평균 절대 백분율 오차 | < 20% |

#### 데이터 저장
- **Supabase**: 
  - `predicted_stocks` (날짜별 예측/실제 가격)
  - `stock_analysis_results` (평가 지표 + 추천)
- **MongoDB**: 
  - `stock_predictions` 컬렉션 (종목별 시계열 조회용)
  - `stock_analysis` 컬렉션 (종목별 분석 결과)
  - `daily_stock_data.predictions` 필드 (날짜별 통합 조회용)
  - `daily_stock_data.analysis` 필드 (날짜별 통합 조회용)
- **갱신 주기**: 수동 실행 (주 1회 권장)
- **저장 시간**: `created_at`, `updated_at` 자동 저장

---

### 3. 📰 뉴스 감정 분석 (Sentiment Analysis)
**파일**: `app/services/stock_recommendation_service.py` → `fetch_and_store_sentiment_for_recommendations()`

#### 데이터 소스
- **API**: Alpha Vantage News Sentiment API
- **분석 대상**: 최근 3일간 뉴스 기사
- **분석 방법**: 티커별 감정 점수 평균 계산

#### 감정 점수
| 범위 | 의미 | 매수/매도 판단 |
|-----|------|---------------|
| **≥ 0.15** | 긍정적 | ✅ 매수 신호 |
| **-0.15 ~ 0.15** | 중립 | ⚠️ 관망 |
| **< -0.15** | 부정적 | ❌ 매도 신호 |

#### 데이터 저장
- **Supabase**: `ticker_sentiment_analysis` 테이블
- **MongoDB**: 
  - `sentiment_analysis` 컬렉션 (종목별 시계열 조회용)
  - `daily_stock_data.sentiment` 필드 (날짜별 통합 조회용)
- **갱신 주기**: 매 3일마다 오전 9시 (미국 동부 시간)
- **대상**: 추천 주식 + 보유 주식
- **저장 시간**: `created_at`, `updated_at` 자동 저장

---

### 4. 🎯 통합 추천 (Combined Recommendation)
**파일**: `app/services/stock_recommendation_service.py` → `get_combined_recommendations_with_technical_and_sentiment()`

#### 통합 방법
```
AI 예측 (Accuracy ≥ 80%, Rise ≥ 3%)
    ∩
기술적 지표 (골든크로스 OR RSI<50 OR MACD매수)
    ∩
감정 분석 (Score ≥ 0.15 OR 강력한 기술 신호)
    ↓
최종 매수 추천
```

#### 종합 점수 계산
```python
composite_score = (
    0.3 × rise_probability +      # 30%: AI 예측 상승률
    0.4 × tech_signal_score +     # 40%: 기술적 지표 점수
    0.3 × sentiment_score         # 30%: 감정 분석 점수
)
```

#### 최종 매수 조건
1. **조건 1**: 감정 점수 ≥ 0.15 **AND** 기술적 신호 2개 이상
2. **조건 2**: 기술적 신호 3개 모두 (감정 무관)

---

## 🔄 전체 시스템 흐름

```
┌─────────────────────────────────────────────────────────┐
│  1️⃣  통합 분석 실행 (Scheduler - 자동 실행)             │
└─────────────────────────────────────────────────────────┘
    │
    └─ 매일 23:45 (KST): 기술적 지표 + 감정 + AI 통합 분석
        ├─ generate_technical_recommendations()
        ├─ fetch_and_store_sentiment_for_recommendations()
        └─ get_combined_recommendations_with_technical_and_sentiment()
        └─ Slack 알림 발송

┌─────────────────────────────────────────────────────────┐
│  2️⃣  자동 매수 실행 (Scheduler - 자동 실행)             │
└─────────────────────────────────────────────────────────┘
    │
    └─ 매일 00:00 (KST): 통합 분석 결과 기반 자동 매수
        └─ execute_auto_buy()
        └─ 추천 종목 1주씩 매수 (잔고 허용 범위 내)

┌─────────────────────────────────────────────────────────┐
│  3️⃣  자동 매도 실행 (Scheduler - 자동 실행)             │
└─────────────────────────────────────────────────────────┘
    │
    └─ 1분마다: 보유 종목 매도 판단
        └─ execute_auto_sell()
        └─ 익절(+5%) / 손절(-7%) / 기술+감정 신호

┌─────────────────────────────────────────────────────────┐
│  4️⃣  AI 예측 모델 학습 (수동 실행)                      │
└─────────────────────────────────────────────────────────┘
    │
    └─ 주 1회 권장: AI 예측 모델 재학습
        └─ python predict.py

┌─────────────────────────────────────────────────────────┐
│  5️⃣  경제 데이터 수집 (Scheduler - 자동 실행)           │
└─────────────────────────────────────────────────────────┘
    │
    └─ 매일 06:05 (KST): 경제 지표 및 주가 데이터 업데이트
        └─ update_economic_data_in_background()
        └─ 뉴욕 16:05 (전날) = 장 마감 직후 확정된 종가 데이터
        └─ Supabase와 MongoDB에 동시 저장
        └─ ⚠️ 분석 작업은 별도 API/스케줄러로 분리됨
```

---

## 📁 주요 파일 구조

```
stock-trading/
├── predict.py                           # AI 예측 모델 (수동 실행)
├── app/
│   ├── services/
│   │   ├── stock_recommendation_service.py   # ⭐ 모든 추천 로직
│   │   ├── auto_trading_service.py           # 자동 매매 실행
│   │   └── balance_service.py                # 잔고/보유 조회
│   ├── utils/
│   │   ├── scheduler.py                      # ⭐ 스케줄러 설정
│   │   └── slack_notifier.py                 # Slack 알림
│   └── api/routes/
│       └── stock_recommendations.py          # API 엔드포인트
└── docs/
    ├── trading/
    │   └── 자동매수_흐름_종합가이드.md      # 자동 매매 종합 가이드
    ├── system/
    │   └── 스케줄러_가이드.md               # 스케줄러 실행 가이드
    ├── recommendation/
    │   ├── 주식예측모델_가이드.md           # AI 모델 상세 설명
    │   └── 통합추천시스템_가이드.md         # 통합 추천 함수 설명
    └── documents/queries/
        └── README.md                        # SQL 쿼리 예시
```

---

## 🗃️ 데이터베이스 테이블

### 입력 데이터
| 데이터 소스 | 설명 | 갱신 주기 |
|---------|------|----------|
| **Supabase** | | |
| `economic_and_stock_data` | 경제 지표 + 주가 원본 데이터 | 매일 (외부 수집) |
| **MongoDB** | | |
| `daily_stock_data` | 날짜별 통합 데이터 (경제 지표 + 주가 + 분석 결과) | 매일 |
| `stocks` | 주식명 ↔ 티커 매핑 (종목 관리) | 정적 (API로 관리) |
| `fred_indicators` | FRED 경제 지표 메타데이터 | 정적 |
| `yfinance_indicators` | Yahoo Finance 지표 메타데이터 | 정적 |

### 분석 결과 데이터 (하이브리드 저장)
| 데이터 소스 | 설명 | 생성 함수 |
|---------|------|----------|
| **Supabase** | | |
| `stock_recommendations` | 기술적 지표 분석 결과 | `generate_technical_recommendations()` |
| `predicted_stocks` | AI 예측 가격 (날짜별) | `predict.py` |
| `stock_analysis_results` | AI 예측 분석 결과 | `predict.py` |
| `ticker_sentiment_analysis` | 감정 분석 결과 | `fetch_and_store_sentiment_for_recommendations()` |
| **MongoDB** | | |
| `stock_recommendations` | 기술적 지표 분석 결과 (종목별 시계열) | `generate_technical_recommendations()` |
| `daily_stock_data.recommendations` | 기술적 지표 분석 결과 (날짜별 통합) | `generate_technical_recommendations()` |
| `stock_predictions` | AI 예측 가격 (종목별 시계열) | `predict.py` |
| `daily_stock_data.predictions` | AI 예측 가격 (날짜별 통합) | `predict.py` |
| `stock_analysis` | AI 예측 분석 결과 (종목별) | `predict.py` |
| `daily_stock_data.analysis` | AI 예측 분석 결과 (날짜별 통합) | `predict.py` |
| `sentiment_analysis` | 감정 분석 결과 (종목별 시계열) | `fetch_and_store_sentiment_for_recommendations()` |
| `daily_stock_data.sentiment` | 감정 분석 결과 (날짜별 통합) | `fetch_and_store_sentiment_for_recommendations()` |

### 거래 기록 테이블
| 테이블명 | 설명 | 생성 시점 |
|---------|------|----------|
| `auto_trading_logs` | 자동 매매 실행 로그 | 매수/매도 실행 시 |

---

## 📊 API 엔드포인트

### 추천 조회 API
```bash
# 1. 기술적 지표만
GET /stocks/recommended-stocks

# 2. AI 예측만
GET /stocks/recommended-stocks/ai-predictions

# 3. 감정 분석 포함 (AI + 감정)
GET /stocks/recommended-stocks/with-sentiment

# 4. 통합 추천 (기술 + AI + 감정) ⭐
GET /stocks/recommended-stocks/with-technical-and-sentiment

# 5. 매도 대상 조회
GET /stocks/recommended-stocks/stocks-to-sell

# 6. MongoDB 날짜별 통합 조회
GET /stocks/mongodb/daily/{date}

# 7. MongoDB 종목별 이력 조회
GET /stocks/mongodb/stocks/{ticker}/recommendations
```

### 분석 실행 API
```bash
# 기술적 지표 분석 실행
POST /stocks/recommended-stocks/generate-technical-recommendations

# 감정 분석 실행
POST /stocks/recommended-stocks/analyze-news-sentiment

# 통합 분석 실행 (기술 + 감정)
POST /stocks/recommended-stocks/generate-complete-analysis
```

### 종목 관리 API
```bash
# 종목 목록 조회
GET /stocks?is_active=true&is_etf=false

# 종목 추가/업데이트
POST /stocks

# 특정 종목 조회
GET /stocks/{ticker}

# 종목 삭제 (비활성화)
DELETE /stocks/{ticker}
```

### 경제 데이터 API
```bash
# 경제 및 주식 데이터 업데이트 (데이터 수집만)
POST /economic/update

# ⚠️ 분석 작업은 별도 API 사용:
# - POST /stocks/recommended-stocks/generate-technical-recommendations
# - POST /stocks/recommended-stocks/analyze-news-sentiment
```

---

## 🔔 Slack 알림 시스템

### 알림 타입 (한국 시간 기준)
1. **통합 추천 분석 완료** (매일 23:45) ⭐
   - 기술적 지표 분석 결과
   - 감정 분석 결과
   - AI 예측 분석 결과
   - 최종 통합 추천 종목 (종합 점수 순)
   - 각 종목별 상세 정보 (기술 신호, 감정 점수, 상승률 등)

2. **자동 매수 실행** (매일 00:00)
   - 매수 종목 및 수량
   - 매수 가격 및 총액
   - 매수 성공/실패 결과

3. **자동 매도 실행** (매 1분마다 체크, 조건 충족 시)
   - 매도 종목 및 수익률
   - 매도 사유 (익절/손절/신호)
   - 매도 성공/실패 결과

---

## ⚙️ 스케줄러 설정

### 자동 실행 스케줄 (한국 시간 기준)
| 시간 (KST) | 뉴욕 시간 | 작업 | 함수 |
|-----------|----------|-----|------|
| 06:05 | 16:05 ET (전날) | 경제 데이터 수집 | `update_economic_data_in_background()` |
| 23:45 | 09:45 ET (당일) | 통합 분석 (기술+감정+AI) | `_run_analysis()` |
| 00:00 | 10:00 ET (당일) | 자동 매수 실행 | `_run_auto_buy()` |
| 매 1분마다 | - | 자동 매도 실행 | `_run_auto_sell()` |

> **시간 설정 이유**:
> - **06:05**: 미국 장 마감(16:00 ET) 직후 확정된 종가 데이터 수집 → 데이터 확정성 보장
> - **23:45**: 전날 확정된 종가 데이터 기반으로 통합 분석 실행 → 신뢰도 높은 분석
> - **00:00**: 분석 결과를 바탕으로 장 개장 30분 후 매수 (시장 안정 후)

### 스케줄러 시작
```bash
# 서버 시작 (스케줄러 자동 시작)
uvicorn app.main:app --reload

# 또는 Docker로 실행
docker-compose up -d
```

---

## 🎯 매수/매도 조건 요약

### 매수 조건 (통합 추천)
✅ **조건 1**: 감정 점수 ≥ 0.15 **AND** 기술 신호 2개 이상
✅ **조건 2**: 기술 신호 3개 모두 (골든크로스 + RSI<50 + MACD매수)

**추가 필터**:
- AI 예측 정확도 ≥ 80%
- AI 예측 상승률 ≥ 3%
- 종합 점수 높은 순으로 상위 5개 매수

### 매도 조건
❌ **조건 1**: 익절 - 구매가 대비 **+5% 이상**
❌ **조건 2**: 손절 - 구매가 대비 **-7% 이하**
❌ **조건 3**: 감정 점수 < -0.15 **AND** 기술 매도 신호 2개 이상
❌ **조건 4**: 기술 매도 신호 3개 (데드크로스 + RSI>70 + MACD매도)

---

## 📈 실전 사용 예시

### 1. 시스템 초기 설정
```bash
# 1. 환경 변수 설정 (.env 파일)
KIS_APP_KEY=your_app_key
KIS_APP_SECRET=your_app_secret
ALPHA_VANTAGE_API_KEY=your_api_key
SLACK_WEBHOOK_URL=your_webhook_url

# 2. 서버 시작
uvicorn app.main:app --reload

# 3. AI 모델 학습 (최초 1회)
python predict.py
```

### 2. 수동으로 추천 확인
```python
from app.services.stock_recommendation_service import StockRecommendationService

service = StockRecommendationService()

# 통합 추천 조회
result = service.get_combined_recommendations_with_technical_and_sentiment()

for stock in result['results'][:5]:
    print(f"{stock['stock_name']}: {stock['composite_score']:.2f}점")
```

### 3. API로 추천 확인
```bash
# 통합 추천 조회
curl http://localhost:8000/api/stock-recommendations/combined

# 매도 대상 조회
curl http://localhost:8000/api/stock-recommendations/stocks-to-sell
```

---

## 💡 최적화 팁

### 1. 매수 조건 완화 (더 많은 추천)
```python
# stock_recommendation_service.py 수정
if sentiment_score >= 0.10:  # 0.15 → 0.10
    if tech_conditions >= 1:  # 2 → 1
        final_results.append(item)
```

### 2. 매수 조건 강화 (더 신뢰도 높은 추천)
```python
if sentiment_score >= 0.20:  # 0.15 → 0.20
    if tech_conditions >= 3:  # 2 → 3 (모든 조건)
        final_results.append(item)
```

### 3. 매수 금액 조정
```python
# auto_trading_service.py 수정
investment_per_stock = 200000  # 15만원 → 20만원
max_stocks_to_buy = 10  # 5개 → 10개
```

### 4. 손익 기준 변경
```python
# stock_recommendation_service.py - get_stocks_to_sell()
if price_change_percent >= 7:  # 익절: +5% → +7%
    sell_reasons.append("익절 조건 충족")
elif price_change_percent <= -5:  # 손절: -7% → -5%
    sell_reasons.append("손절 조건 충족")
```

---

## ⚠️ 주의사항

### 1. 데이터 최신성
- 기술적 지표: 매일 갱신 필수
- 감정 분석: 3일마다 갱신 권장
- AI 예측: 주 1회 재학습 권장

### 2. API 제한
- Alpha Vantage: 무료 계정 500 calls/day
- 한국투자증권: 초당 20건 제한

### 3. 리스크 관리
- 한 종목에 전체 자금의 10% 이상 투자 지양
- 손절매 설정 필수 (-7%)
- 급격한 시장 변동 시 자동 매매 중단 고려

### 4. 백테스팅
- 실전 투자 전 과거 데이터로 전략 검증
- 최소 3개월 ~ 6개월 백테스팅 권장

---

## 🔗 관련 문서

- **[매수_동작_가이드.md](./매수_동작_가이드.md)**: 자동 매매 시스템 상세 설명
- **[스케줄러_가이드.md](./스케줄러_가이드.md)**: 스케줄러 설정 및 실행
- **[주식예측모델_가이드.md](./주식예측모델_가이드.md)**: AI 예측 모델 상세 설명
- **[통합추천시스템_가이드.md](./통합추천시스템_가이드.md)**: 통합 추천 함수 상세 설명

---

---

## 🔄 최근 변경사항 (2025-12-12)

### MongoDB 하이브리드 저장 방식 도입
- 모든 분석 결과를 Supabase와 MongoDB에 동시 저장
- MongoDB는 종목별 시계열 조회용 컬렉션과 날짜별 통합 조회용 `daily_stock_data` 필드로 이중 저장
- `created_at`, `updated_at` 자동 저장

### 종목 관리 API 추가
- `POST /stocks`: 종목 추가/업데이트
- `GET /stocks`: 종목 목록 조회 (필터링 지원)
- `GET /stocks/{ticker}`: 특정 종목 조회
- `DELETE /stocks/{ticker}`: 종목 비활성화

### 분석 로직 분리
- `/economic/update` API는 데이터 수집 및 저장만 담당
- 기술적 지표 생성, 감정 분석은 별도 API로 분리
- 각 분석 작업을 독립적으로 실행 가능

### 데이터 소스 변경
- `stock_ticker_mapping` → MongoDB `stocks` 컬렉션으로 전환
- 종목 정보는 MongoDB에서 조회 (자동 매매는 예외)

---

**마지막 업데이트**: 2025-12-12

