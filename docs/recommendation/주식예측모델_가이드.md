# 주식 예측 모델 가이드 (predict.py)

## 📊 개요

`predict.py`는 Transformer 기반 딥러닝 모델을 사용하여 주식 가격을 예측하고, 예측 결과를 분석하여 매수/매도 추천을 생성하는 스크립트입니다.

## 🎯 주요 기능

### 1. 데이터 수집 및 전처리
- **데이터 소스**: 
  - Supabase: `economic_and_stock_data` 테이블
  - MongoDB: `daily_stock_data` 컬렉션 (경제 지표 및 주가 데이터)
  - MongoDB: `stocks` 컬렉션 (활성 종목 목록)
- **데이터 정제**: 결측치 처리 (forward fill, backward fill, 평균값 대체)
- **데이터 스케일링**: MinMaxScaler를 사용하여 0~1 범위로 정규화

### 2. 모델 학습 (1단계)
- **모델 구조**: Transformer Encoder 기반 딥러닝 모델
  - 주식 데이터와 경제 지표를 분리된 입력으로 처리
  - 각각 4개의 Transformer Layer로 인코딩
  - Multi-Head Attention 메커니즘 사용
- **예측 기간**: 14일 후 주가 예측
- **학습 데이터**: 과거 90일(lookback) 데이터를 기반으로 학습
- **대상 종목**: 
  - 미국 주요 기술주 (애플, 마이크로소프트, 아마존, 구글, 메타, 테슬라, 엔비디아 등)
  - ETF (S&P 500 ETF, QQQ ETF)
  - 총 34개 종목

### 3. 예측 결과 저장
- **Supabase**: `predicted_stocks` 테이블
  - 날짜별 예측 가격 (`{종목명}_Predicted`)
  - 날짜별 실제 가격 (`{종목명}_Actual`)
- **MongoDB**: 
  - `stock_predictions` 컬렉션 (종목별 시계열 조회용)
    - 각 종목별로 날짜, 티커, 예측 가격, 실제 가격 저장
  - `daily_stock_data.predictions` 필드 (날짜별 통합 조회용)
    - 날짜별로 모든 종목의 예측 데이터를 통합 저장
- **저장 시간**: `created_at`, `updated_at` 자동 저장

### 4. 예측 결과 분석 (2단계)
- **평가 지표 계산**:
  - MAE (Mean Absolute Error): 평균 절대 오차
  - MSE (Mean Squared Error): 평균 제곱 오차
  - RMSE (Root Mean Squared Error): 평균 제곱근 오차
  - MAPE (Mean Absolute Percentage Error): 평균 절대 백분율 오차
  - Accuracy: 정확도 (100 - MAPE)

- **상승/하락 예측**:
  - 현재 가격 대비 14일 후 예측 가격 비교
  - 상승 확률(%) 계산

- **매수/매도 추천**:
  - **STRONG BUY**: 상승 예측 & 상승률 > 2%
  - **BUY**: 상승 예측 & 상승률 > 0%
  - **SELL**: 하락 예측 또는 상승률 ≤ 0%

### 5. 분석 결과 저장
- **Supabase**: `stock_analysis_results` 테이블
- **MongoDB**: 
  - `stock_analysis` 컬렉션 (종목별 분석 결과)
    - metrics: MAE, MSE, RMSE, MAPE, Accuracy
    - predictions: 최근 실제 가격, 예측 가격, 상승 확률 등
    - recommendation: AI 추천 등급
    - analysis: 분석 설명
  - `daily_stock_data.analysis` 필드 (날짜별 통합 조회용)
    - 날짜별로 모든 종목의 분석 결과를 통합 저장
- **저장 시간**: `created_at`, `updated_at` 자동 저장
- **저장 내용**:
  - 평가 지표 (MAE, MSE, RMSE, MAPE, Accuracy)
  - 현재 가격 및 예측 가격
  - 상승/하락 예측 및 확률
  - 매수/매도 추천
  - 분석 코멘트

## 📈 사용되는 데이터

### 주식 데이터 (34개 종목)
- 미국 기술주: 애플, 마이크로소프트, 아마존, 구글, 메타, 테슬라, 엔비디아 등
- 반도체: 인텔, 마이크론, 브로드컴, AMD, TSMC 등
- 에너지/인프라: 버티브 홀딩스, 비스트라 에너지, 블룸에너지, 오클로
- AI/클라우드: 팔란티어, 세일즈포스, 오라클, 스노우플레이크 등
- ETF: S&P 500 ETF, QQQ ETF

### 경제 지표 (39개)
- **금리 관련**: 기준금리, 2년/10년 국채 수익률, 장단기 금리차, 모기지 금리
- **인플레이션**: 10년 기대 인플레이션율, CPI, 금 가격
- **경제 지표**: GDP 성장률, 실업률, 개인 소비 지출, 통화 공급량 M2
- **심리 지수**: 미시간대 소비자 심리지수, 금융스트레스지수, VIX 지수
- **환율**: 미국 달러 환율, 달러 인덱스, 달러/엔, 달러/위안
- **글로벌 지수**: 나스닥, S&P 500, 닛케이 225, 상해종합, 항셍, FTSE, DAX, CAC 40
- **채권/리츠**: 전체 채권시장 ETF, TIPS ETF, 투자등급 회사채 ETF, 리츠 ETF

## 🔄 실행 흐름

```
1. 데이터 로드 (economic_and_stock_data 테이블)
   ↓
2. 데이터 전처리 및 스케일링
   ↓
3. Transformer 모델 학습 (90일 → 14일 후 예측)
   ↓
4. 전체 기간 예측 수행
   ↓
5. predicted_stocks 테이블에 저장
   ↓
6. 예측 결과 분석 (평가 지표, 상승률 계산)
   ↓
7. 매수/매도 추천 생성
   ↓
8. stock_analysis_results 테이블에 저장
```

## 💾 데이터베이스 테이블

### 입력 테이블
- **economic_and_stock_data**: 경제 지표 및 주식 가격 원본 데이터

### 출력 테이블
- **predicted_stocks**: 날짜별 예측 가격 및 실제 가격
- **stock_analysis_results**: 예측 분석 결과 및 매수/매도 추천

## ⚙️ 모델 하이퍼파라미터

- **Lookback Period**: 90일 (과거 데이터)
- **Forecast Horizon**: 14일 (예측 기간)
- **Transformer Layers**: 4개
- **Attention Heads**: 8개
- **Feed-Forward Dimension**: 256
- **Dropout Rate**: 0.1~0.2
- **Learning Rate**: 0.0001
- **Epochs**: 50
- **Batch Size**: 32

## 📋 출력 예시

```
============ Final Report ============
Stock                    MAE    RMSE   MAPE(%)  Accuracy(%)  Rise Probability(%)  Recommendation
애플                     2.34   3.12   1.45     98.55        3.24                 STRONG BUY
엔비디아                 8.91   11.23  2.67     97.33        5.12                 STRONG BUY
테슬라                   5.67   7.89   3.21     96.79        1.89                 BUY
...
```

## 🎓 활용 방안

1. **자동 매매 시스템**: 추천 결과를 기반으로 자동 매수/매도 전략 수립
2. **포트폴리오 최적화**: 상승 확률이 높은 종목 위주로 포트폴리오 구성
3. **리스크 관리**: 정확도(Accuracy)가 낮은 종목 제외 또는 투자 비중 축소

---

## 🔄 최근 변경사항 (2025-12-12)

### MongoDB 하이브리드 저장 방식 도입
- 예측 결과와 분석 결과를 Supabase와 MongoDB에 동시 저장
- MongoDB는 종목별 시계열 조회용 컬렉션과 날짜별 통합 조회용 `daily_stock_data` 필드로 이중 저장
- `created_at`, `updated_at` 자동 저장

### 데이터 소스 변경
- 종목 목록은 MongoDB `stocks` 컬렉션에서 조회 (Supabase fallback 제거)
- 경제 데이터는 MongoDB `daily_stock_data`를 우선 조회

---

**마지막 업데이트**: 2025-12-12
4. **백테스팅**: 과거 예측 결과와 실제 가격 비교하여 모델 성능 검증

## ⚠️ 주의사항

1. **과거 데이터 기반 예측**: 모델은 과거 패턴을 학습하므로, 급격한 시장 변화나 예상치 못한 이벤트에는 대응하지 못할 수 있습니다.
2. **투자 참고 자료**: 이 모델의 예측 결과는 투자 판단의 참고 자료일 뿐, 절대적인 투자 지침이 아닙니다.
3. **리스크 관리 필수**: 실제 투자 시에는 손절매, 분산 투자 등 리스크 관리 전략을 반드시 병행해야 합니다.
4. **정기적 재학습**: 시장 상황이 변하므로 정기적으로 모델을 재학습시켜야 합니다.

## 🔗 연관 파일

- `app/services/stock_recommendation_service.py`: 예측 결과를 API로 제공
- `app/api/routes/stock_recommendations.py`: 예측 결과 조회 엔드포인트
- `매수_동작_가이드.md`: 자동 매매 시스템 가이드

