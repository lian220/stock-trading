# 자동매도 전략 가이드

## 개요

자동매도 시스템은 보유 종목 중 매도 조건을 만족하는 종목을 자동으로 매도하는 시스템입니다. 리스크 관리와 수익 확정을 위해 우선순위 기반 매도 전략을 사용합니다.

## 매도 우선순위 체계

매도 조건은 중요도에 따라 4단계 우선순위로 구분됩니다:

### Priority 1: 리스크 관리 (최우선)

**긴급 손절**
- 조건: 구매가 대비 -10% 이하 하락
- 조치: 즉시 전량 매도
- 이유: 손실 확대 방지, 자본 보호

**일반 손절**
- 조건: 구매가 대비 -7% 이하 하락
- 조치: 즉시 전량 매도
- 이유: 손실 제한, 리스크 관리

### Priority 2: 트레일링 스톱 (수익 극대화)

**트레일링 스톱**
- 조건: 
  - 최소 수익률 충족 (일반: 3%, 레버리지: 5%)
  - 현재가 <= 동적 익절가
  - 동적 익절가 = 최고가 × (1 - 트레일링 거리%)
- 조치: 전량 매도
- 이유: 추가 수익 극대화, 하락 시 일정 수익 확보
- 상세: [트레일링 스톱 구현 완료 문서](./트레일링_스톱_구현_완료.md) 참조

### Priority 3: 고정 익절 (수익 확정)

**익절**
- 조건: 
  - 일반 종목: 구매가 대비 +5% 이상 상승
  - 레버리지 ETF: 구매가 대비 +10% 이상 상승
- 조치: 전량 매도
- 이유: 수익 확정, 재투자 기회 확보
- 참고: 트레일링 스톱이 활성화된 경우 Priority 2에서 먼저 처리됨

### Priority 4: 추세 전환 신호

**강력한 기술적 매도**
- 조건: 기술적 지표 중 3개 이상 매도 신호
  - 데드 크로스 (골든 크로스 = False)
  - RSI 과매수 (RSI > 70)
  - MACD 매도 신호 (MACD 매수 신호 = False)
- 조치: 전량 매도
- 이유: 추세 전환 확실

**보통 기술적 매도**
- 조건: 
  - 감성 점수 < -0.15
  - 기술적 지표 중 2개 이상 매도 신호
- 조치: 전량 매도 (향후 부분 매도 고려)
- 이유: 추세 약화 신호

## 구현 상세

### 1. 매도 대상 식별 (`get_stocks_to_sell()`)

각 매도 조건에 우선순위를 부여하여 매도 대상을 식별합니다:

```python
# Priority 1: 손절
if price_change_percent <= -10:
    priority = 1
    sell_type = "stop_loss_urgent"
elif price_change_percent <= -7:
    priority = 1
    sell_type = "stop_loss"

# Priority 2: 트레일링 스톱
elif trailing_stop_service.check_trailing_stop_triggered(ticker, current_price):
    priority = 2
    sell_type = "trailing_stop"

# Priority 3: 고정 익절
elif price_change_percent >= target_profit_percent:
    priority = 3
    sell_type = "take_profit"

# Priority 4: 기술적 매도
elif technical_sell_signals >= 3:
    priority = 4
    sell_type = "technical_strong"
elif sentiment_score < -0.15 and technical_sell_signals >= 2:
    priority = 4
    sell_type = "technical_moderate"
```

### 2. 우선순위별 처리 (`_execute_auto_sell()`)

매도 대상 종목을 우선순위별로 그룹화하여 순차적으로 처리합니다:

1. **Priority 1 (손절)** 처리
   - 긴급 손절 및 일반 손절 종목 즉시 매도
   - 리스크 관리 최우선

2. **Priority 2 (트레일링 스톱)** 처리
   - 동적 익절가 하회 종목 매도
   - 손절 처리 완료 후 실행
   - 최고가 기준으로 수익 극대화

3. **Priority 3 (고정 익절)** 처리
   - 구매가 기준 고정 익절 조건 충족 종목 매도
   - 손절/트레일링 스톱 처리 완료 후 실행

4. **Priority 4 (기술적 매도)** 처리
   - 추세 전환 신호 종목 매도
   - 손절/트레일링 스톱/익절 처리 완료 후 실행

### 3. 통계 및 로깅

각 우선순위별로 처리 건수를 추적하고 로깅합니다:

```
[매도 작업 요약]
  총 매도 대상: X개
  ✅ 주문 성공: Y개
  ❌ 주문 실패: Z개

  우선순위별 상세:
    손절 (Priority 1): A개 (성공: B개, 실패: C개)
    트레일링 스톱 (Priority 2): D개 (성공: E개, 실패: F개)
    익절 (Priority 3): G개 (성공: H개, 실패: I개)
    기술적 매도 (Priority 4): J개 (성공: K개, 실패: L개)
```

## 매도 조건 상세

### 손절 조건

손절은 리스크 관리의 핵심입니다. 손실이 일정 수준에 도달하면 즉시 매도하여 추가 손실을 방지합니다.

- **일반 손절**: -7% (기본값)
- **긴급 손절**: -10% (추가 보호)

### 트레일링 스톱 조건

트레일링 스톱은 최고가를 추적하여 동적으로 익절가를 상향 조정하는 전략입니다.

- **일반 종목**: 트레일링 거리 5%, 최소 수익률 3%
- **레버리지 ETF**: 트레일링 거리 7%, 최소 수익률 5%
- **동작**: 주가 상승 시 최고가 갱신 → 동적 익절가 상향 조정
- **매도**: 현재가가 동적 익절가 이하로 하락 시 매도

상세 내용은 [트레일링 스톱 구현 완료 문서](./트레일링_스톱_구현_완료.md)를 참조하세요.

### 고정 익절 조건

고정 익절은 구매가 기준으로 목표 수익률에 도달하면 매도하는 전략입니다.

- **일반 종목**: +5%
- **레버리지 ETF**: +10% (변동성이 크므로 더 높은 목표 설정)
- **참고**: 트레일링 스톱이 활성화된 경우 Priority 2에서 먼저 처리됨

### 기술적 매도 조건

기술적 지표를 기반으로 추세 전환을 감지하여 매도합니다.

**기술적 지표:**
1. **골든 크로스/데드 크로스**
   - 골든 크로스: 단기 이동평균선이 장기 이동평균선을 상향 돌파 (매수 신호)
   - 데드 크로스: 단기 이동평균선이 장기 이동평균선을 하향 돌파 (매도 신호)

2. **RSI (Relative Strength Index)**
   - RSI > 70: 과매수 구간 (매도 신호)
   - RSI < 30: 과매도 구간 (매수 신호)

3. **MACD (Moving Average Convergence Divergence)**
   - MACD 매수 신호: MACD 선이 시그널 선을 상향 돌파
   - MACD 매도 신호: MACD 매수 신호가 없음

**감성 분석:**
- 감성 점수 < -0.15: 부정적 감성
- 감성 점수 > +0.15: 긍정적 감성

## 향후 개선 방향

### 1. 부분 매도 전략
- 익절: +5% 도달 시 50% 매도, +10% 도달 시 나머지 50% 매도
- 기술적 매도: 신호 강도에 따라 부분 매도 고려

### 2. 트레일링 스톱 (Trailing Stop)
- 고정 익절 대신 주가 상승에 따라 익절가를 동적으로 상향 조정
- 최대 수익 확보

### 3. 시간 기반 필터링
- 장 시작 30분 이내: 긴급 손절만 처리 (변동성 대응)
- 장 마감 30분 전: 익절 우선 처리 (수익 확정)

### 4. 조건 조합 전략
- 익절 + 기술적 매도: 즉시 전량 매도
- 손절 + 기술적 매도: 즉시 전량 매도
- 기술적 매도만: 부분 매도 고려

## 관련 파일

- `app/services/stock_recommendation_service.py`: `get_stocks_to_sell()` 메서드
- `app/utils/scheduler.py`: `_execute_auto_sell()` 메서드
- `app/services/auto_trading_service.py`: 자동매매 설정 관리

## 참고 문서

- [자동매수 흐름 종합가이드](./자동매수_흐름_종합가이드.md)
- [트레이딩 전략 분석 가이드](../system/트레이딩_전략_분석_가이드.md)
- [스케줄러 가이드](../system/스케줄러_가이드.md)

