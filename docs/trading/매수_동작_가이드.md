# 📊 주식 자동 매수 시스템 가이드

한국투자증권 API를 활용한 주식 자동 매수 시스템의 전체 동작 방식을 설명합니다.

## 📋 목차
1. [시스템 개요](#시스템-개요)
2. [매수 대상 선정](#매수-대상-선정)
3. [자동 매수 스케줄러](#자동-매수-스케줄러)
4. [API 사용 방법](#api-사용-방법)
5. [Slack 알림 설정](#slack-알림-설정)
6. [매수 조건 상세 설명](#매수-조건-상세-설명)
7. [실전 활용 가이드](#실전-활용-가이드)

---

## 시스템 개요

### 전체 프로세스 흐름

```
┌─────────────────────────────┐
│  1. 데이터 수집              │
│  - AI 주가 예측             │
│  - 기술적 지표 계산         │
│  - 뉴스 감정 분석           │
└──────────┬──────────────────┘
           │
           ▼
┌─────────────────────────────┐
│  2. 매수 대상 선정           │
│  - 조건 필터링              │
│  - 종합 점수 계산           │
│  - 우선순위 정렬            │
└──────────┬──────────────────┘
           │
           ▼
┌─────────────────────────────┐
│  3. 자동 매수 스케줄러       │
│  - 한국 시간 밤 12시 실행   │
│  - 미국 장 시간 확인        │
│  - 중복 매수 방지           │
└──────────┬──────────────────┘
           │
           ▼
┌─────────────────────────────┐
│  4. 매수 주문 실행           │
│  - 현재가 조회              │
│  - 거래소 자동 판별         │
│  - 주문 전송                │
└──────────┬──────────────────┘
           │
           ▼
┌─────────────────────────────┐
│  5. Slack 알림 전송          │
│  - 매수 체결 알림           │
│  - 실패 알림                │
└─────────────────────────────┘
```

### 주요 구성 요소

| 구성 요소 | 파일 위치 | 역할 |
|----------|----------|------|
| **매수 추천 서비스** | `app/services/stock_recommendation_service.py` | 매수 대상 선정 로직 |
| **자동 매수 스케줄러** | `app/utils/scheduler.py` | 자동 매수 실행 |
| **API 라우터** | `app/api/routes/stock_recommendations.py` | API 엔드포인트 제공 |
| **Slack 알림** | `app/utils/slack_notifier.py` | 알림 전송 |

---

## 매수 대상 선정

### 📊 데이터 소스

시스템은 3가지 데이터 소스를 통합하여 매수 대상을 선정합니다.

#### 1️⃣ AI 주가 예측 (`stock_analysis_results`)

| 조건 | 값 |
|-----|-----|
| 정확도(Accuracy) | ≥ 80% |
| 상승확률(Rise Probability) | ≥ 3% |

**의미**: AI 모델이 주가 상승을 높은 신뢰도로 예측

#### 2️⃣ 기술적 지표 (`stock_recommendations`)

3가지 기술적 신호 중 **2개 이상** 만족해야 함:

| 지표 | 조건 | 가중치 |
|-----|------|--------|
| **골든 크로스** | SMA20 > SMA50 | 1.5점 |
| **RSI** | < 50 (과매도 구간) | 1.0점 |
| **MACD 매수 신호** | MACD > Signal | 1.0점 |

**의미**: 기술적으로 상승 추세 신호

#### 3️⃣ 뉴스 감정 분석 (`ticker_sentiment_analysis`)

| 조건 | 값 |
|-----|-----|
| 평균 감정 점수 | ≥ 0.15 |
| 기사 수 | ≥ 5개 |

**의미**: 시장 심리가 긍정적

### 🎯 최종 매수 조건

**현재 적용 중인 조건:**

```
✅ 1번(AI 예측) 통과 
   AND
✅ 3번(감정 분석) 만족 (점수 ≥ 0.15)
   AND  
✅ 2번(기술적 지표) 2개 이상 만족
```

**조건이 충족되지 않는 경우:**
- 감정 점수가 0.15 미만이면 기술적 지표 **3개 모두** 만족해야 함

### 📈 종합 점수 계산

```python
종합 점수 = (상승확률 × 0.3) + (기술적지표 × 0.4) + (감정점수 × 0.3)
```

| 요소 | 가중치 | 설명 |
|-----|-------|------|
| 상승확률 | 30% | AI 모델의 예측 상승 확률 |
| 기술적지표 | 40% | 골든크로스, RSI, MACD 점수 |
| 감정점수 | 30% | 뉴스 감정 분석 점수 |

종합 점수가 높을수록 매수 우선순위가 높습니다.

---

## 자동 매수 스케줄러

### ⏰ 실행 시간

**한국 시간 기준 매일 밤 12시(00:00)** 에 자동으로 실행됩니다.

### 🔍 실행 조건 확인

스케줄러는 다음 조건들을 순차적으로 확인합니다:

#### 1. 주말 체크 (뉴욕 시간 기준)
```python
# 토요일(5) 또는 일요일(6)이면 실행 안 함
if ny_weekday >= 5:
    return  # 매수 작업 건너뜀
```

#### 2. 미국 장 시간 확인
```python
# 미국 주식 시장: 평일 9:30 AM - 4:00 PM ET (뉴욕 시간)
- 서머타임 자동 고려
- 장이 열려있지 않으면 매수 안 함
```

#### 3. 보유 종목 조회
```python
# 중복 매수 방지
- 이미 보유 중인 종목은 매수 대상에서 자동 제외
```

### 🚀 매수 프로세스

```python
for 매수_대상_종목 in 추천_종목_리스트:
    1. 거래소 코드 판별
       - NASDAQ: "NASD" → API 코드 "NAS"
       - NYSE: "NYSE" → API 코드"NYS"
    
    2. 보유 종목 확인
       - 이미 보유 중이면 SKIP
    
    3. 현재가 조회
       - 한국투자증권 API 호출
       - 실시간 체결가 확인
    
    4. 매수 수량 계산
       - 현재: 기본값 1주
       - 향후: 계좌 잔고 기반 계산 가능
    
    5. 매수 주문 실행
       - 주문 구분: 00 (지정가)
       - API를 통해 주문 전송
    
    6. Slack 알림 전송
       - 성공: 매수 체결 알림
       - 실패: 에러 메시지 알림
    
    7. API 제한 관리
       - 1초 대기 (Rate Limit 준수)
```

### 📝 로깅

모든 매수 활동은 `stock_scheduler.log` 파일에 기록됩니다:

```
2024-12-03 23:30:00 - 자동 매수 작업 시작
2024-12-03 23:30:05 - 엔비디아(NVDA) 현재가 조회: $450.00
2024-12-03 23:30:07 - 엔비디아(NVDA) 매수 주문 성공: 10주
2024-12-03 23:30:10 - 애플(AAPL) 이미 보유 중이므로 매수하지 않음
2024-12-03 23:30:15 - 자동 매수 작업 완료
```

---

## API 사용 방법

### 🔗 Base URL
```
http://localhost:8000/api/recommended-stocks
```

### 주요 엔드포인트

#### 1. 매수 추천 종목 조회 (기본)

**엔드포인트**: `GET /recommended-stocks`

정확도 80% 이상, 상승 확률 3% 이상인 종목 조회

```bash
curl http://localhost:8000/api/recommended-stocks
```

#### 2. 감정 분석 포함 추천

**엔드포인트**: `GET /recommended-stocks/with-sentiment`

감정 점수 ≥ 0.15인 종목만 필터링

```bash
curl http://localhost:8000/api/recommended-stocks/with-sentiment
```

#### 3. 통합 매수 추천 (⭐ 핵심)

**엔드포인트**: `GET /recommended-stocks/with-technical-and-sentiment`

AI 예측 + 기술적 지표 + 감정 분석을 모두 통합

```bash
curl http://localhost:8000/api/recommended-stocks/with-technical-and-sentiment
```

**응답 예시:**
```json
{
  "message": "3개의 매수 추천 주식을 찾았습니다",
  "results": [
    {
      "ticker": "NVDA",
      "stock_name": "엔비디아",
      "accuracy": 85.2,
      "rise_probability": 8.5,
      "last_price": 450.00,
      "predicted_price": 485.00,
      "sentiment_score": 0.35,
      "golden_cross": true,
      "rsi": 45.2,
      "macd_buy_signal": true,
      "composite_score": 87.5
    }
  ]
}
```

#### 4. 기술적 지표 생성

**엔드포인트**: `POST /recommended-stocks/generate-technical-recommendations`

최근 180일 데이터로 기술적 지표 계산 및 저장

```bash
curl -X POST http://localhost:8000/api/recommended-stocks/generate-technical-recommendations
```

#### 5. 뉴스 감정 분석

**엔드포인트**: `POST /recommended-stocks/analyze-news-sentiment`

추천 종목의 뉴스 감정 분석 수행

```bash
curl -X POST http://localhost:8000/api/recommended-stocks/analyze-news-sentiment
```

#### 6. 통합 분석 (올인원)

**엔드포인트**: `POST /recommended-stocks/generate-complete-analysis`

기술적 지표 생성 → 뉴스 감정 분석 → 통합 결과 조회를 한번에 실행

```bash
curl -X POST http://localhost:8000/api/recommended-stocks/generate-complete-analysis
```

### 스케줄러 제어 API

#### 매수 스케줄러 시작

**엔드포인트**: `POST /recommended-stocks/purchase/scheduler/start`

매일 밤 12시 자동 매수 시작

```bash
curl -X POST http://localhost:8000/api/recommended-stocks/purchase/scheduler/start
```

#### 매수 스케줄러 중지

**엔드포인트**: `POST /recommended-stocks/purchase/scheduler/stop`

```bash
curl -X POST http://localhost:8000/api/recommended-stocks/purchase/scheduler/stop
```

#### 즉시 매수 실행 (테스트용)

**엔드포인트**: `POST /recommended-stocks/purchase/trigger`

스케줄러를 기다리지 않고 즉시 매수 실행

```bash
curl -X POST http://localhost:8000/api/recommended-stocks/purchase/trigger
```

#### 스케줄러 상태 확인

**엔드포인트**: `GET /recommended-stocks/scheduler/status`

매수/매도 스케줄러의 실행 상태 확인

```bash
curl http://localhost:8000/api/recommended-stocks/scheduler/status
```

**응답 예시:**
```json
{
  "buy_running": true,
  "sell_running": false,
  "message": "매수 스케줄러: 실행 중, 매도 스케줄러: 중지됨"
}
```

---

## Slack 알림 설정

### 📝 설정 방법

#### 1단계: Slack Webhook URL 생성

1. [Slack API 웹사이트](https://api.slack.com/apps)에 접속
2. **"Create New App"** → **"From scratch"** 선택
3. 앱 이름(예: "Stock Trading Bot")과 워크스페이스 선택
4. **"Incoming Webhooks"** 활성화
5. **"Add New Webhook to Workspace"** 클릭
6. 알림을 받을 채널 선택 → **"Allow"**
7. 생성된 Webhook URL 복사

#### 2단계: 환경 변수 설정

`.env` 파일에 다음 내용 추가:

```bash
# Slack 알림 설정
SLACK_WEBHOOK_URL=https://hooks.slack.com/services/YOUR/WEBHOOK/URL
SLACK_ENABLED=true
```

#### 3단계: 서버 재시작

```bash
./stop.sh
./start.sh
```

또는 Docker 사용 시:
```bash
docker-compose restart
```

### 📨 알림 형식

#### ✅ 매수 체결 알림

```
✅ 주식 매수 체결

종목명: 엔비디아
티커: NVDA
수량: 10주
가격: $450.50
거래소: NASD
총 금액: $4,505.00

매수 주문이 성공적으로 체결되었습니다.

🕒 한국 2024-12-03 23:30:00 | 뉴욕 2024-12-03 09:30:00
```

#### ❌ 매수 실패 알림

```
❌ 주식 매수 실패

종목명: 엔비디아
티커: NVDA
수량: 10주
가격: $450.50
거래소: NASD

매수 주문이 실패했습니다.
오류: 계좌 잔고 부족

🕒 한국 2024-12-03 23:30:00 | 뉴욕 2024-12-03 09:30:00
```

### 🧪 알림 테스트

터미널에서 직접 테스트:

```bash
curl -X POST -H 'Content-type: application/json' \
  --data '{"text":"테스트 메시지입니다!"}' \
  YOUR_WEBHOOK_URL
```

### ⚙️ 알림 비활성화

알림을 받고 싶지 않다면:

```bash
# .env 파일에서
SLACK_ENABLED=false
```

---

## 매수 조건 상세 설명

### 🔍 기술적 지표

#### 1. 골든 크로스 (Golden Cross)

**정의**: 단기 이동평균(SMA20)이 장기 이동평균(SMA50)을 상향 돌파

```
SMA20 > SMA50
```

- **의미**: 상승 추세 전환 신호, 가장 강력한 매수 신호
- **가중치**: 1.5점 (최고 가중치)

#### 2. RSI (Relative Strength Index)

**정의**: 상대강도지수, 과매수/과매도 판단 지표

```
RSI < 50
```

- **의미**: 과매도 구간 진입, 반등 가능성
- **가중치**: 1.0점
- **참고**: RSI < 30이면 강한 과매도, RSI > 70이면 과매수

#### 3. MACD (Moving Average Convergence Divergence)

**정의**: MACD 선이 Signal 선을 상향 돌파

```
MACD > Signal
```

- **의미**: 단기 모멘텀 상승, 매수 타이밍
- **가중치**: 1.0점

### 📈 AI 주가 예측

#### 정확도 (Accuracy)

```
Accuracy ≥ 80%
```

- **의미**: AI 모델의 예측 신뢰도
- **높을수록**: 예측이 더 정확할 가능성

#### 상승 확률 (Rise Probability)

```
Rise Probability ≥ 3%
```

- **의미**: 주가 상승 예측 확률
- **높을수록**: 더 큰 수익 기대

#### 예상 수익률

```python
expected_return_pct = ((predicted_price - last_price) / last_price) × 100
```

### 💬 감정 분석

#### 평균 감정 점수

```
Average Sentiment Score ≥ 0.15
```

- **범위**: -1.0 (매우 부정) ~ +1.0 (매우 긍정)
- **의미**: 뉴스 기사에서 추출한 시장 심리

| 감정 점수 | 해석 |
|---------|------|
| ≥ 0.30 | 🌟 매우 긍정적 |
| 0.20 ~ 0.29 | 😊 긍정적 |
| 0.15 ~ 0.19 | 🙂 다소 긍정적 |
| 0 ~ 0.14 | 😐 중립 |
| < 0 | 😟 부정적 |

#### 기사 수

```
Article Count ≥ 5개
```

- **의미**: 분석된 뉴스 기사 개수
- **높을수록**: 감정 점수의 신뢰도 증가

---

## 실전 활용 가이드

### 🎯 시나리오 1: 자동 매수 시작하기

```bash
# 1. 통합 분석 실행 (데이터 최신화)
curl -X POST http://localhost:8000/api/recommended-stocks/generate-complete-analysis

# 2. 매수 추천 종목 확인
curl http://localhost:8000/api/recommended-stocks/with-technical-and-sentiment

# 3. 매수 스케줄러 시작
curl -X POST http://localhost:8000/api/recommended-stocks/purchase/scheduler/start

# 이제 매일 밤 12시에 자동으로 매수됩니다!
```

### 🎯 시나리오 2: 즉시 매수 테스트

```bash
# 1. 현재 추천 종목 확인
curl http://localhost:8000/api/recommended-stocks/with-technical-and-sentiment

# 2. 즉시 매수 실행
curl -X POST http://localhost:8000/api/recommended-stocks/purchase/trigger

# 3. 로그 확인
tail -f stock_scheduler.log
```

### 🎯 시나리오 3: 보수적 매수 전략

조건을 더 엄격하게 설정하려면 `stock_recommendation_service.py` 수정:

```python
# 더 높은 기준 적용
filtered_df = df[
    (df['Accuracy (%)'] >= 85) &  # 85%로 상향
    (df['Rise Probability (%)'] >= 5)  # 5%로 상향
]
```

감정 점수 기준도 상향:

```python
sentiment_response = supabase.table("ticker_sentiment_analysis")\
    .select("*")\
    .gte("average_sentiment_score", 0.25)\  # 0.25로 상향
    .execute()
```

### 🎯 시나리오 4: 공격적 매수 전략

더 많은 종목을 매수하려면:

```python
# 기준 완화
filtered_df = df[
    (df['Accuracy (%)'] >= 75) &  # 75%로 하향
    (df['Rise Probability (%)'] >= 2)  # 2%로 하향
]
```

기술적 지표 조건 완화:

```python
# 2개 → 1개로 완화
if sentiment_score is not None and sentiment_score >= 0.15:
    if sum(tech_conditions) >= 1:  # 1개만 만족해도 OK
        final_results.append(item)
```

### 📊 Python 스크립트 예제

```python
import requests
import time

BASE_URL = "http://localhost:8000/api/recommended-stocks"

def daily_auto_buy_workflow():
    """매일 실행할 자동 매수 워크플로우"""
    
    print("1. 통합 분석 시작...")
    response = requests.post(f"{BASE_URL}/generate-complete-analysis")
    print(response.json()["message"])
    
    time.sleep(5)  # API 안정화 대기
    
    print("2. 매수 추천 종목 확인...")
    response = requests.get(f"{BASE_URL}/with-technical-and-sentiment")
    candidates = response.json()["results"]
    print(f"매수 추천: {len(candidates)}개 종목")
    
    for candidate in candidates[:3]:  # 상위 3개만 출력
        print(f"  - {candidate['stock_name']}: 종합점수 {candidate['composite_score']:.2f}")
    
    print("3. 스케줄러 상태 확인...")
    response = requests.get(f"{BASE_URL}/scheduler/status")
    status = response.json()
    print(f"  {status['message']}")
    
    if not status["buy_running"]:
        print("4. 매수 스케줄러 시작...")
        response = requests.post(f"{BASE_URL}/purchase/scheduler/start")
        print(f"  {response.json()['message']}")
    else:
        print("4. 매수 스케줄러 이미 실행 중")

# 실행
daily_auto_buy_workflow()
```

---

## ⚠️ 주의사항

### 1. API Rate Limit

한국투자증권 API는 속도 제한이 있습니다:
- 스케줄러가 자동으로 1초씩 대기
- 너무 많은 종목을 동시에 주문하지 않도록 주의

### 2. 중복 매수 방지

- 시스템이 자동으로 보유 종목을 확인
- 이미 보유 중인 종목은 재매수하지 않음

### 3. 장 시간 확인

- 미국 주식 시장 시간에만 실행
- 평일 9:30 AM - 4:00 PM ET (뉴욕 시간)
- 서머타임 자동 고려

### 4. 매수 수량

현재는 기본값 **1주**로 설정:

```python
# scheduler.py 412번 줄
quantity = 1  # 기본값 설정
```

계좌 잔고 기반으로 수량을 계산하려면 이 부분을 수정해야 합니다.

### 5. 로그 확인

문제 발생 시 반드시 로그를 확인하세요:

```bash
# 로그 파일 확인
tail -f stock_scheduler.log

# Docker 로그 확인
docker logs stock-trading-app -f
```

---

## 🔧 고급 설정

### 매수 조건 커스터마이징

`app/services/stock_recommendation_service.py` 파일의 `get_combined_recommendations_with_technical_and_sentiment` 함수를 수정하여 매수 조건을 변경할 수 있습니다.

**현재 조건:**
```python
if sentiment_score is not None and sentiment_score >= 0.15:
    if sum(tech_conditions) >= 2:  # 기술적 지표 2개
        final_results.append(item)
else:
    if sum(tech_conditions) >= 3:  # 기술적 지표 3개
        final_results.append(item)
```

**보수적으로 변경:**
```python
if sentiment_score is not None and sentiment_score >= 0.25:  # 감정 점수 상향
    if sum(tech_conditions) >= 3:  # 조건 강화
        final_results.append(item)
```

**공격적으로 변경:**
```python
if sentiment_score is not None and sentiment_score >= 0.10:  # 감정 점수 하향
    if sum(tech_conditions) >= 1:  # 조건 완화
        final_results.append(item)
```

### 스케줄러 시간 변경

`app/utils/scheduler.py` 파일의 41번 줄:

```python
# 현재: 밤 12시
schedule.every().day.at("00:00").do(self._run_auto_buy)

# 예: 새벽 6시로 변경
schedule.every().day.at("06:00").do(self._run_auto_buy)
```

---

## 📞 문의 및 지원

매수 시스템 관련 문의사항이나 개선 제안이 있으시면 이슈를 등록해주세요.

**관련 API 문서**: http://localhost:8000/docs

---

**이제 주식 자동 매수 시스템이 완전히 자동화되었습니다!** 🚀

