# ğŸ¤– ìë™ ë§¤ìˆ˜ ì‹œìŠ¤í…œ ì¢…í•© ê°€ì´ë“œ

ìë™ ë§¤ìˆ˜ ì‹œìŠ¤í…œì˜ ì „ì²´ íë¦„ì„ ë¶„ì„í•˜ê³ , ê·¸ íë¦„ì— ë§ê²Œ ì½”ë”©ì„ í•˜ê²Œ í•˜ëŠ” ì¢…í•© ê°€ì´ë“œì…ë‹ˆë‹¤.

## ğŸ“‹ ëª©ì°¨

1. [ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ ê°œìš”](#ì‹œìŠ¤í…œ-ì•„í‚¤í…ì²˜-ê°œìš”)
2. [ìë™ ë§¤ìˆ˜ ì „ì²´ íë¦„](#ìë™-ë§¤ìˆ˜-ì „ì²´-íë¦„)
3. [ë‹¨ê³„ë³„ ìƒì„¸ ë¶„ì„](#ë‹¨ê³„ë³„-ìƒì„¸-ë¶„ì„)
4. [ì½”ë“œ êµ¬ì¡° ë° íŒŒì¼ ìœ„ì¹˜](#ì½”ë“œ-êµ¬ì¡°-ë°-íŒŒì¼-ìœ„ì¹˜)
5. [ë°ì´í„° íë¦„ ë‹¤ì´ì–´ê·¸ë¨](#ë°ì´í„°-íë¦„-ë‹¤ì´ì–´ê·¸ë¨)
6. [ì½”ë”© ê°€ì´ë“œë¼ì¸](#ì½”ë”©-ê°€ì´ë“œë¼ì¸)
7. [ì„¤ì • ë° ì»¤ìŠ¤í„°ë§ˆì´ì§•](#ì„¤ì •-ë°-ì»¤ìŠ¤í„°ë§ˆì´ì§•)
8. [API ì—”ë“œí¬ì¸íŠ¸ ì •ë¦¬](#api-ì—”ë“œí¬ì¸íŠ¸-ì •ë¦¬)
9. [ì—ëŸ¬ ì²˜ë¦¬ ë° ë¡œê¹…](#ì—ëŸ¬-ì²˜ë¦¬-ë°-ë¡œê¹…)
10. [ì‹¤ì „ í™œìš© ì˜ˆì‹œ](#ì‹¤ì „-í™œìš©-ì˜ˆì‹œ)

---

## ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ ê°œìš”

### ğŸ—ï¸ ì „ì²´ êµ¬ì¡°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ìë™ ë§¤ìˆ˜ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ìŠ¤ì¼€ì¤„ëŸ¬    â”‚â”€â”€â”€â”€â”€â–¶â”‚  ìë™ë§¤ë§¤     â”‚â”€â”€â”€â”€â”€â–¶â”‚  ì£¼ë¬¸ ì‹¤í–‰    â”‚
â”‚  (Scheduler)  â”‚      â”‚   ì„œë¹„ìŠ¤     â”‚      â”‚  (KIS API)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                     â”‚                       â”‚
       â”‚                     â”‚                       â”‚
       â–¼                     â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ì¶”ì²œ ì„œë¹„ìŠ¤  â”‚      â”‚  ì„¤ì • ê´€ë¦¬    â”‚      â”‚  ì”ê³  ì¡°íšŒ    â”‚
â”‚ (Recommend)  â”‚      â”‚  (Config)     â”‚      â”‚  (Balance)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ë°ì´í„° ì†ŒìŠ¤ ë ˆì´ì–´                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Supabase: stock_analysis_results, stock_recommendations,     â”‚
â”‚            ticker_sentiment_analysis, auto_trading_config    â”‚
â”‚  MongoDB:  daily_stock_data, stocks, users                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ“ ì£¼ìš” ì»´í¬ë„ŒíŠ¸

| ì»´í¬ë„ŒíŠ¸ | íŒŒì¼ ìœ„ì¹˜ | ì—­í•  |
|---------|----------|------|
| **ìŠ¤ì¼€ì¤„ëŸ¬** | `app/utils/scheduler.py` | ë§¤ì¼ ë°¤ 12ì‹œ ìë™ ë§¤ìˆ˜ íŠ¸ë¦¬ê±° |
| **ìë™ë§¤ë§¤ ì„œë¹„ìŠ¤** | `app/services/auto_trading_service.py` | ë§¤ìˆ˜ ë¡œì§ ì‹¤í–‰ ë° ê´€ë¦¬ |
| **ì¶”ì²œ ì„œë¹„ìŠ¤** | `app/services/stock_recommendation_service.py` | ë§¤ìˆ˜ ëŒ€ìƒ ì„ ì • |
| **ì”ê³  ì„œë¹„ìŠ¤** | `app/services/balance_service.py` | ì£¼ë¬¸ ì‹¤í–‰ ë° ì”ê³  ì¡°íšŒ |
| **API ë¼ìš°í„°** | `app/api/routes/auto_trading.py` | REST API ì—”ë“œí¬ì¸íŠ¸ |
| **ìŠ¤í‚¤ë§ˆ** | `app/schemas/auto_trading.py` | ë°ì´í„° ëª¨ë¸ ì •ì˜ |

---

## ìë™ ë§¤ìˆ˜ ì „ì²´ íë¦„

### ğŸ”„ ì „ì²´ í”„ë¡œì„¸ìŠ¤ í”Œë¡œìš°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ìŠ¤ì¼€ì¤„ëŸ¬ íŠ¸ë¦¬ê±° (ë§¤ì¼ ë°¤ 12ì‹œ í•œêµ­ ì‹œê°„)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. ì‹¤í–‰ ì¡°ê±´ í™•ì¸                                             â”‚
â”‚    â”œâ”€ ì£¼ë§ ì²´í¬ (ë‰´ìš• ì‹œê°„ ê¸°ì¤€)                              â”‚
â”‚    â”œâ”€ ë¯¸êµ­ ì¥ ì‹œê°„ í™•ì¸ (9:30 AM - 4:00 PM ET)               â”‚
â”‚    â””â”€ ìë™ë§¤ë§¤ í™œì„±í™” ì—¬ë¶€ í™•ì¸                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. ë§¤ìˆ˜ í›„ë³´ ì„ ì •                                             â”‚
â”‚    â”œâ”€ í†µí•© ì¶”ì²œ ì¡°íšŒ (AI + ê¸°ìˆ ì  ì§€í‘œ + ê°ì • ë¶„ì„)            â”‚
â”‚    â”œâ”€ ì¢…í•© ì ìˆ˜ í•„í„°ë§ (min_composite_score)                 â”‚
â”‚    â”œâ”€ ê°ì • ì ìˆ˜ í•„í„°ë§ (min_sentiment_score)                  â”‚
â”‚    â”œâ”€ ìµœëŒ€ ë§¤ìˆ˜ ì¢…ëª© ìˆ˜ ì œí•œ (max_stocks_to_buy)              â”‚
â”‚    â””â”€ ì¢…í•© ì ìˆ˜ ê¸°ì¤€ ì •ë ¬ (ë†’ì€ ìˆœ)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. ë³´ìœ  ì¢…ëª© í™•ì¸                                             â”‚
â”‚    â””â”€ ì¤‘ë³µ ë§¤ìˆ˜ ë°©ì§€ (ì„ íƒì )                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. ê° ì¢…ëª©ë³„ ë§¤ìˆ˜ ì²˜ë¦¬                                        â”‚
â”‚    â”œâ”€ ë ˆë²„ë¦¬ì§€ ì„¤ì • í™•ì¸ (MongoDB users ì»¬ë ‰ì…˜)               â”‚
â”‚    â”œâ”€ ê±°ë˜ì†Œ ì½”ë“œ ê²°ì • (NASD/NYSE)                             â”‚
â”‚    â”œâ”€ í˜„ì¬ê°€ ì¡°íšŒ (ì—¬ëŸ¬ ê±°ë˜ì†Œ ì‹œë„)                           â”‚
â”‚    â”œâ”€ ë§¤ìˆ˜ ê°€ëŠ¥ ìˆ˜ëŸ‰ ê³„ì‚° (inquire_psamount)                  â”‚
â”‚    â”œâ”€ ë§¤ìˆ˜ ì£¼ë¬¸ ì‹¤í–‰ (order_overseas_stock)                   â”‚
â”‚    â”œâ”€ ì£¼ë¬¸ ê¸°ë¡ ì €ì¥ (auto_trading_logs)                      â”‚
â”‚    â””â”€ Slack ì•Œë¦¼ ì „ì†¡                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. ì™„ë£Œ ë° ë¡œê¹…                                               â”‚
â”‚    â”œâ”€ ì„±ê³µ/ì‹¤íŒ¨ í†µê³„                                          â”‚
â”‚    â”œâ”€ ë‚¨ì€ ì”ê³  ì •ë³´                                          â”‚
â”‚    â””â”€ ë¡œê·¸ íŒŒì¼ ê¸°ë¡                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. ì²´ê²° í™•ì¸ (ë¹„ë™ê¸°)                                         â”‚
â”‚    â”œâ”€ ì£¼ë¬¸ ì ‘ìˆ˜ í›„ 5ì´ˆ ëŒ€ê¸°                                    â”‚
â”‚    â”œâ”€ ì£¼ë¬¸ì²´ê²°ë‚´ì—­ APIë¡œ ì²´ê²° ì—¬ë¶€ í™•ì¸                        â”‚
â”‚    â”œâ”€ ì²´ê²° ì‹œ ìƒíƒœ ì—…ë°ì´íŠ¸ ë° Slack ì•Œë¦¼                      â”‚
â”‚    â””â”€ ë¯¸ì²´ê²° ì‹œ pending ìƒíƒœë¡œ ìœ ì§€                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. ì¥ ë§ˆê° í›„ ë¯¸ì²´ê²° ì£¼ë¬¸ ì •ë¦¬ (ë§¤ì¼ 06:30)                    â”‚
â”‚    â”œâ”€ pending/accepted ìƒíƒœ ì£¼ë¬¸ ì¡°íšŒ                         â”‚
â”‚    â”œâ”€ failed ìƒíƒœë¡œ ë³€ê²½                                      â”‚
â”‚    â””â”€ Slack ì•Œë¦¼ ì „ì†¡                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ë‹¨ê³„ë³„ ìƒì„¸ ë¶„ì„

### 1ï¸âƒ£ ìŠ¤ì¼€ì¤„ëŸ¬ íŠ¸ë¦¬ê±°

**íŒŒì¼**: `app/utils/scheduler.py`

**ì½”ë“œ ìœ„ì¹˜**:
```python
# ìŠ¤ì¼€ì¤„ëŸ¬ ì‹œì‘
schedule.every().day.at("00:00").do(self._run_auto_buy)

# ì‹¤í–‰ í•¨ìˆ˜
def _run_auto_buy(self, send_slack_notification: bool = True):
    """ìë™ ë§¤ìˆ˜ ì‹¤í–‰ í•¨ìˆ˜ - ìŠ¤ì¼€ì¤„ë§ëœ ì‹œê°„ì— ì‹¤í–‰ë¨"""
    # ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
    if self.buy_executing:
        return False
    
    self.buy_executing = True
    # ì£¼ë§ ì²´í¬
    # ë¹„ë™ê¸° ì‹¤í–‰
```

**í•µì‹¬ ë¡œì§**:
- ë§¤ì¼ ë°¤ 12ì‹œ (í•œêµ­ ì‹œê°„) ìë™ ì‹¤í–‰
- ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€ í”Œë˜ê·¸ (`buy_executing`)
- ì£¼ë§ ì²´í¬ (ë‰´ìš• ì‹œê°„ ê¸°ì¤€)
- ë¹„ë™ê¸° ì‹¤í–‰ì„ ìœ„í•œ ìŠ¤ë ˆë“œ ìƒì„±

**ì½”ë”© ê°€ì´ë“œ**:
```python
# âœ… ì˜¬ë°”ë¥¸ ì˜ˆì‹œ
def _run_auto_buy(self, send_slack_notification: bool = True):
    if self.buy_executing:  # ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
        return False
    
    self.buy_executing = True
    try:
        # ì£¼ë§ ì²´í¬
        now_ny = datetime.now(pytz.timezone('America/New_York'))
        if now_ny.weekday() >= 5:  # ì£¼ë§
            return False
        
        # ë¹„ë™ê¸° ì‹¤í–‰
        thread = threading.Thread(target=run_in_thread)
        thread.start()
    finally:
        self.buy_executing = False
```

---

### 2ï¸âƒ£ ì‹¤í–‰ ì¡°ê±´ í™•ì¸

**íŒŒì¼**: `app/utils/scheduler.py` â†’ `_execute_auto_buy()`

**ì½”ë“œ ìœ„ì¹˜**:
```python
async def _execute_auto_buy(self, send_slack_notification: bool = True):
    # ë¯¸êµ­ ì¥ ì‹œê°„ í™•ì¸
    now_in_ny = datetime.now(pytz.timezone('America/New_York'))
    ny_hour = now_in_ny.hour
    ny_minute = now_in_ny.minute
    ny_weekday = now_in_ny.weekday()
    
    # ì¥ ì‹œê°„ ì²´í¬
    is_weekday = 0 <= ny_weekday <= 4
    is_market_open_time = (
        (ny_hour == 9 and ny_minute >= 30) or
        (10 <= ny_hour < 16) or
        (ny_hour == 16 and ny_minute == 0)
    )
    
    if not (is_weekday and is_market_open_time):
        logger.info("ë¯¸êµ­ ì¥ ì‹œê°„ì´ ì•„ë‹ˆë¯€ë¡œ ë§¤ìˆ˜ ì‘ì—…ì„ ê±´ë„ˆëœë‹ˆë‹¤.")
        return
```

**í•µì‹¬ ë¡œì§**:
- ë‰´ìš• ì‹œê°„ ê¸°ì¤€ìœ¼ë¡œ ì¥ ì‹œê°„ í™•ì¸
- ì„œë¨¸íƒ€ì„ ìë™ ê³ ë ¤ (`pytz.timezone('America/New_York')`)
- í‰ì¼ 9:30 AM - 4:00 PM ETë§Œ ì‹¤í–‰

**ì½”ë”© ê°€ì´ë“œ**:
```python
# âœ… ì˜¬ë°”ë¥¸ ì˜ˆì‹œ: ì„œë¨¸íƒ€ì„ ìë™ ê³ ë ¤
now_in_ny = datetime.now(pytz.timezone('America/New_York'))

# âŒ ì˜ëª»ëœ ì˜ˆì‹œ: í•œêµ­ ì‹œê°„ ê¸°ì¤€
now_in_korea = datetime.now()  # ì„œë¨¸íƒ€ì„ ë¯¸ê³ ë ¤
```

---

### 3ï¸âƒ£ ë§¤ìˆ˜ í›„ë³´ ì„ ì •

**íŒŒì¼**: `app/services/auto_trading_service.py` â†’ `get_buy_candidates()`

**ì½”ë“œ ìœ„ì¹˜**:
```python
def get_buy_candidates(self, config: Optional[Dict] = None) -> List[Dict]:
    # 1. í†µí•© ì¶”ì²œ ì¡°íšŒ
    recommendations = self.stock_service.get_combined_recommendations_with_technical_and_sentiment(
        send_slack_notification=False
    )
    
    # 2. í•„í„°ë§
    candidates = []
    for stock in recommendations["results"]:
        # ì¢…í•© ì ìˆ˜ í•„í„°ë§
        if stock.get("composite_score", 0) < config.get("min_composite_score", 2.0):
            continue
        
        # ê°ì • ë¶„ì„ í•„í„°ë§
        if config.get("use_sentiment", False):
            sentiment_score = stock.get("sentiment_score")
            if sentiment_score is None or sentiment_score < config.get("min_sentiment_score", 0.15):
                continue
        
        candidates.append(stock)
    
    # 3. ì •ë ¬ ë° ì œí•œ
    candidates.sort(key=lambda x: x.get("composite_score", 0), reverse=True)
    candidates = candidates[:config.get("max_stocks_to_buy", 5)]
    
    return candidates
```

**í•µì‹¬ ë¡œì§**:
- `get_combined_recommendations_with_technical_and_sentiment()` í˜¸ì¶œ
- ì¢…í•© ì ìˆ˜ í•„í„°ë§ (`min_composite_score`)
- ê°ì • ì ìˆ˜ í•„í„°ë§ (`min_sentiment_score`, ì„ íƒì )
- ìµœëŒ€ ë§¤ìˆ˜ ì¢…ëª© ìˆ˜ ì œí•œ (`max_stocks_to_buy`)
- ì¢…í•© ì ìˆ˜ ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬

**ë°ì´í„° ì†ŒìŠ¤**:
- **Supabase**: `stock_analysis_results`, `stock_recommendations`, `ticker_sentiment_analysis`
- **MongoDB**: `daily_stock_data` (ê¸°ìˆ ì  ì§€í‘œ ê³„ì‚°ìš©)

**ì½”ë”© ê°€ì´ë“œ**:
```python
# âœ… ì˜¬ë°”ë¥¸ ì˜ˆì‹œ: ì„¤ì • ê¸°ë°˜ í•„í„°ë§
if stock.get("composite_score", 0) < config.get("min_composite_score", 2.0):
    continue

# âœ… ì˜¬ë°”ë¥¸ ì˜ˆì‹œ: ì„ íƒì  í•„í„°ë§
if config.get("use_sentiment", False):
    if sentiment_score < config.get("min_sentiment_score", 0.15):
        continue

# âŒ ì˜ëª»ëœ ì˜ˆì‹œ: í•˜ë“œì½”ë”©ëœ ê°’
if stock.get("composite_score", 0) < 2.0:  # ì„¤ì • ë¬´ì‹œ
    continue
```

---

### 4ï¸âƒ£ ë³´ìœ  ì¢…ëª© í™•ì¸

**íŒŒì¼**: `app/services/auto_trading_service.py` â†’ `execute_auto_buy()`

**ì½”ë“œ ìœ„ì¹˜**:
```python
# í˜„ì¬ ë³´ìœ  ì¢…ëª© í™•ì¸
balance_result = get_overseas_balance()
holding_tickers = set()
if balance_result.get("rt_cd") == "0" and "output1" in balance_result:
    holding_tickers = {item.get("ovrs_pdno") for item in balance_result["output1"]}

# ë§¤ìˆ˜ ì²˜ë¦¬ ì¤‘
for candidate in candidates:
    ticker = candidate.get("ticker")
    # ì´ë¯¸ ë³´ìœ  ì¤‘ì¸ ì¢…ëª©ì€ ìŠ¤í‚µ (ì„ íƒì )
    # if ticker in holding_tickers:
    #     continue
```

**í•µì‹¬ ë¡œì§**:
- `get_overseas_balance()` API í˜¸ì¶œ
- ë³´ìœ  ì¢…ëª© í‹°ì»¤ ì¶”ì¶œ
- ì¤‘ë³µ ë§¤ìˆ˜ ë°©ì§€ (í˜„ì¬ëŠ” ì£¼ì„ ì²˜ë¦¬ë¨)

**ì½”ë”© ê°€ì´ë“œ**:
```python
# âœ… ì˜¬ë°”ë¥¸ ì˜ˆì‹œ: API ì‘ë‹µ ê²€ì¦
if balance_result.get("rt_cd") == "0" and "output1" in balance_result:
    holding_tickers = {item.get("ovrs_pdno") for item in balance_result["output1"]}

# âŒ ì˜ëª»ëœ ì˜ˆì‹œ: ì‘ë‹µ ê²€ì¦ ì—†ìŒ
holding_tickers = {item.get("ovrs_pdno") for item in balance_result["output1"]}
```

---

### 5ï¸âƒ£ ê° ì¢…ëª©ë³„ ë§¤ìˆ˜ ì²˜ë¦¬

**íŒŒì¼**: `app/utils/scheduler.py` â†’ `_execute_auto_buy()`

#### 5-1. ë ˆë²„ë¦¬ì§€ ì„¤ì • í™•ì¸

**ì½”ë“œ ìœ„ì¹˜**:
```python
# MongoDBì—ì„œ ì‚¬ìš©ìë³„ ë ˆë²„ë¦¬ì§€ ì„¤ì • ì¡°íšŒ
from app.infrastructure.database.mongodb_client import get_mongodb_database
db = get_mongodb_database()
user = db.users.find_one({"user_id": user_id})
if user and user.get("stocks"):
    for stock in user.get("stocks", []):
        ticker = stock.get("ticker")
        if ticker:
            user_leverage_map[ticker] = {
                "use_leverage": stock.get("use_leverage", False),
                "leverage_ticker": stock.get("leverage_ticker")
            }

# ë ˆë²„ë¦¬ì§€ ì ìš©
actual_ticker = ticker
if ticker in user_leverage_map:
    leverage_info = user_leverage_map[ticker]
    if leverage_info["use_leverage"] and leverage_info["leverage_ticker"]:
        actual_ticker = leverage_info["leverage_ticker"]
```

**í•µì‹¬ ë¡œì§**:
- MongoDB `users` ì»¬ë ‰ì…˜ì—ì„œ ì‚¬ìš©ì ì„¤ì • ì¡°íšŒ
- ë ˆë²„ë¦¬ì§€ í™œì„±í™” ì‹œ ë ˆë²„ë¦¬ì§€ í‹°ì»¤ë¡œ ë³€ê²½
- ì˜ˆ: `AAPL` â†’ `AAPL3L` (3ë°° ë ˆë²„ë¦¬ì§€)

**ì½”ë”© ê°€ì´ë“œ**:
```python
# âœ… ì˜¬ë°”ë¥¸ ì˜ˆì‹œ: ì•ˆì „í•œ ì¡°íšŒ
user = db.users.find_one({"user_id": user_id})
if user and user.get("stocks"):
    # ì²˜ë¦¬

# âŒ ì˜ëª»ëœ ì˜ˆì‹œ: None ì²´í¬ ì—†ìŒ
for stock in user.get("stocks", []):  # userê°€ Noneì´ë©´ ì—ëŸ¬
    pass
```

#### 5-2. ê±°ë˜ì†Œ ì½”ë“œ ê²°ì •

**ì½”ë“œ ìœ„ì¹˜**:
```python
# ê±°ë˜ì†Œ ì½”ë“œ ê²°ì •
if actual_ticker.endswith(".X") or actual_ticker.endswith(".N"):
    exchange_code = "NYSE" if actual_ticker.endswith(".N") else "NASD"
    pure_ticker = actual_ticker.split(".")[0]
else:
    exchange_code = "NASD"  # ê¸°ë³¸ê°’
    pure_ticker = actual_ticker

# API ìš”ì²­ìš© ê±°ë˜ì†Œ ì½”ë“œ ë³€í™˜
api_exchange_code = "NAS"
if exchange_code == "NYSE":
    api_exchange_code = "NYS"
elif exchange_code == "AMEX":
    api_exchange_code = "AMS"
```

**í•µì‹¬ ë¡œì§**:
- í‹°ì»¤ì— ê±°ë˜ì†Œ êµ¬ë¶„ì´ í¬í•¨ëœ ê²½ìš° íŒŒì‹±
- ê¸°ë³¸ê°’ì€ NASDAQ (`NASD`)
- API ìš”ì²­ ì‹œ ì½”ë“œ ë³€í™˜ (`NASD` â†’ `NAS`)

**ì½”ë”© ê°€ì´ë“œ**:
```python
# âœ… ì˜¬ë°”ë¥¸ ì˜ˆì‹œ: ì•ˆì „í•œ íŒŒì‹±
if actual_ticker.endswith(".X") or actual_ticker.endswith(".N"):
    exchange_code = "NYSE" if actual_ticker.endswith(".N") else "NASD"
    pure_ticker = actual_ticker.split(".")[0]
else:
    exchange_code = "NASD"
    pure_ticker = actual_ticker

# âŒ ì˜ëª»ëœ ì˜ˆì‹œ: ì¸ë±ìŠ¤ ì—ëŸ¬ ê°€ëŠ¥
pure_ticker = actual_ticker.split(".")[0]  # "."ì´ ì—†ìœ¼ë©´ ì—ëŸ¬
```

#### 5-3. í˜„ì¬ê°€ ì¡°íšŒ

**ì½”ë“œ ìœ„ì¹˜**:
```python
# ì—¬ëŸ¬ ê±°ë˜ì†Œ ì‹œë„
exchanges = ["NAS", "AMS", "NYS"]
price_result = None

# ê¸°ë³¸ ê±°ë˜ì†Œë¥¼ ë§¨ ì•ìœ¼ë¡œ
default_exchange = self._get_exchange_code(ticker).replace("D", "S")
if default_exchange in exchanges:
    exchanges.remove(default_exchange)
    exchanges.insert(0, default_exchange)

for exchange in exchanges:
    temp_result = get_current_price({
        "EXCD": exchange,
        "SYMB": ticker
    })
    
    output = temp_result.get("output", {})
    if temp_result.get("rt_cd") == "0" and (output.get("last") or output.get("base")):
        price_result = temp_result
        break

# í˜„ì¬ê°€ ì¶”ì¶œ
current_price = float(price_result.get("output", {}).get("last") or 0)

# ëŒ€ì²´ ê°€ê²© ì‚¬ìš© (í˜„ì¬ê°€ê°€ 0ì¸ ê²½ìš°)
if current_price <= 0:
    base_price = float(price_result.get("output", {}).get("base") or 0)
    if base_price > 0:
        current_price = base_price
    else:
        # ì¶”ì²œ ë°ì´í„°ì˜ ê°€ê²© ì‚¬ìš©
        cached_last_price = float(candidate.get("last_price") or 0)
        predicted_price = float(candidate.get("predicted_price") or 0)
        if cached_last_price > 0:
            current_price = cached_last_price
        elif predicted_price > 0:
            current_price = predicted_price
```

**í•µì‹¬ ë¡œì§**:
- ì—¬ëŸ¬ ê±°ë˜ì†Œì—ì„œ í˜„ì¬ê°€ ì¡°íšŒ ì‹œë„
- ì‹¤ì‹œê°„ ê°€ê²©(`last`) ìš°ì„ , ì—†ìœ¼ë©´ ì „ì¼ ì¢…ê°€(`base`) ì‚¬ìš©
- ëª¨ë‘ ì‹¤íŒ¨ ì‹œ ì¶”ì²œ ë°ì´í„°ì˜ ê°€ê²© ì‚¬ìš©

**ì½”ë”© ê°€ì´ë“œ**:
```python
# âœ… ì˜¬ë°”ë¥¸ ì˜ˆì‹œ: ì•ˆì „í•œ íƒ€ì… ë³€í™˜
try:
    current_price = float(price_result.get("output", {}).get("last") or 0)
    if current_price <= 0:
        # ëŒ€ì²´ ê°€ê²© ì‹œë„
        base_price = float(price_result.get("output", {}).get("base") or 0)
except (ValueError, TypeError):
    logger.error("ê°€ê²© ë³€í™˜ ì‹¤íŒ¨")
    continue

# âŒ ì˜ëª»ëœ ì˜ˆì‹œ: íƒ€ì… ë³€í™˜ ì—†ìŒ
current_price = price_result.get("output", {}).get("last")  # ë¬¸ìì—´ì¼ ìˆ˜ ìˆìŒ
```

#### 5-4. ë§¤ìˆ˜ ê°€ëŠ¥ ìˆ˜ëŸ‰ ê³„ì‚°

**ì½”ë“œ ìœ„ì¹˜**:
```python
# ë§¤ìˆ˜ ê°€ëŠ¥ ìˆ˜ëŸ‰ ê³„ì‚°
quantity_result = self.calculate_buy_quantity(
    ticker, exchange_code, current_price, max_amount
)

if not quantity_result.get("success") or quantity_result.get("quantity", 0) <= 0:
    logger.warning(f"{ticker} - ë§¤ìˆ˜ ê°€ëŠ¥ ìˆ˜ëŸ‰ ì—†ìŒ")
    continue

quantity = quantity_result["quantity"]
```

**íŒŒì¼**: `app/services/auto_trading_service.py` â†’ `calculate_buy_quantity()`

**ì½”ë“œ ìœ„ì¹˜**:
```python
def calculate_buy_quantity(self, ticker: str, exchange_code: str, target_price: float, 
                           max_amount: float) -> Dict:
    # ë§¤ìˆ˜ê°€ëŠ¥ê¸ˆì•¡ ì¡°íšŒ
    params = {
        "CANO": settings.KIS_CANO,
        "ACNT_PRDT_CD": settings.KIS_ACNT_PRDT_CD,
        "OVRS_EXCG_CD": exchange_code,
        "ITEM_CD": ticker,
        "OVRS_ORD_UNPR": str(target_price)
    }
    
    result = inquire_psamount(params)
    
    if result.get("rt_cd") != "0":
        return {"success": False, "error": result.get("msg1", "ì¡°íšŒ ì‹¤íŒ¨")}
    
    # ë§¤ìˆ˜ ê°€ëŠ¥ ê¸ˆì•¡ í™•ì¸
    output = result.get("output", {})
    max_buy_amount = float(output.get("max_ord_psbl_amt") or 0)
    
    # ì„¤ì •ëœ ìµœëŒ€ ê¸ˆì•¡ê³¼ ë¹„êµí•˜ì—¬ ë” ì‘ì€ ê°’ ì‚¬ìš©
    actual_max_amount = min(max_buy_amount, max_amount)
    
    # ìˆ˜ëŸ‰ ê³„ì‚°
    quantity = int(actual_max_amount / target_price)
    
    return {
        "success": True,
        "quantity": quantity,
        "estimated_amount": quantity * target_price,
        "max_available": max_buy_amount
    }
```

**í•µì‹¬ ë¡œì§**:
- `inquire_psamount()` API í˜¸ì¶œë¡œ ë§¤ìˆ˜ ê°€ëŠ¥ ê¸ˆì•¡ ì¡°íšŒ
- ì„¤ì •ëœ ìµœëŒ€ ê¸ˆì•¡(`max_amount_per_stock`)ê³¼ ë¹„êµ
- ë” ì‘ì€ ê°’ìœ¼ë¡œ ìˆ˜ëŸ‰ ê³„ì‚°

**ì½”ë”© ê°€ì´ë“œ**:
```python
# âœ… ì˜¬ë°”ë¥¸ ì˜ˆì‹œ: ì•ˆì „í•œ ê³„ì‚°
try:
    max_buy_amount = float(output.get("max_ord_psbl_amt") or 0)
except ValueError:
    max_buy_amount = 0.0

actual_max_amount = min(max_buy_amount, max_amount)
quantity = int(actual_max_amount / target_price)

# âŒ ì˜ëª»ëœ ì˜ˆì‹œ: ë‚˜ëˆ—ì…ˆ ì—ëŸ¬ ê°€ëŠ¥
quantity = int(max_buy_amount / target_price)  # target_priceê°€ 0ì´ë©´ ì—ëŸ¬
```

#### 5-5. ë§¤ìˆ˜ ì£¼ë¬¸ ì‹¤í–‰

**ì½”ë“œ ìœ„ì¹˜**:
```python
# ì‹¤ì œ ì£¼ë¬¸ ì‹¤í–‰
order_data = {
    "CANO": settings.KIS_CANO,
    "ACNT_PRDT_CD": settings.KIS_ACNT_PRDT_CD,
    "PDNO": ticker,
    "OVRS_EXCG_CD": exchange_code,
    "ORD_QTY": str(quantity),
    "OVRS_ORD_UNPR": str(current_price),
    "is_buy": True,
    "ORD_DVSN": config.get("order_type", "00")  # 00: ì§€ì •ê°€
}

order_result = order_overseas_stock(order_data)

# ì£¼ë¬¸ ê¸°ë¡ ì €ì¥
self._save_order_log(order_info, "buy")

# API Rate Limit ë°©ì§€ë¥¼ ìœ„í•œ ëŒ€ê¸°
time.sleep(0.5)
```

**íŒŒì¼**: `app/services/balance_service.py` â†’ `order_overseas_stock()`

**í•µì‹¬ ë¡œì§**:
- `order_overseas_stock()` API í˜¸ì¶œ
- ì£¼ë¬¸ êµ¬ë¶„: `00` (ì§€ì •ê°€)
- ì£¼ë¬¸ ê¸°ë¡ ì €ì¥ (`auto_trading_logs` í…Œì´ë¸”)
- Slack ì•Œë¦¼ ì „ì†¡ (ì„±ê³µ/ì‹¤íŒ¨ ëª¨ë‘)

**ì½”ë”© ê°€ì´ë“œ**:
```python
# âœ… ì˜¬ë°”ë¥¸ ì˜ˆì‹œ: ì£¼ë¬¸ ë°ì´í„° ê²€ì¦
if quantity <= 0 or current_price <= 0:
    logger.error("ìœ íš¨í•˜ì§€ ì•Šì€ ì£¼ë¬¸ ë°ì´í„°")
    continue

order_data = {
    "ORD_QTY": str(quantity),  # ë¬¸ìì—´ë¡œ ë³€í™˜
    "OVRS_ORD_UNPR": str(current_price),  # ë¬¸ìì—´ë¡œ ë³€í™˜
    "is_buy": True
}

# âŒ ì˜ëª»ëœ ì˜ˆì‹œ: íƒ€ì… ë³€í™˜ ì—†ìŒ
order_data = {
    "ORD_QTY": quantity,  # APIëŠ” ë¬¸ìì—´ì„ ìš”êµ¬
    "OVRS_ORD_UNPR": current_price
}
```

---

### 6ï¸âƒ£ ì²´ê²° í™•ì¸ (ë¹„ë™ê¸°)

**íŒŒì¼**: `app/utils/scheduler.py` â†’ `_check_and_update_execution()`

**ì½”ë“œ ìœ„ì¹˜**:
```python
async def _check_and_update_execution(
    self,
    order_no: str,
    ticker: str,
    stock_name: str,
    function_name: str = "_execute_auto_buy",
    before_quantity: int = 0,
    order_quantity: int = 0
):
    # 5ì´ˆ ëŒ€ê¸° í›„ ì²´ê²° í™•ì¸
    await asyncio.sleep(5)
    
    # ì£¼ë¬¸ì²´ê²°ë‚´ì—­ APIë¡œ ì²´ê²° ì—¬ë¶€ í™•ì¸
    execution_result = check_order_execution(
        order_no=order_no,
        exchange_code=exchange_code,
        ticker=ticker,
        max_retries=3,
        retry_delay=5
    )
    
    if execution_result.get("executed"):
        # ì²´ê²° ì„±ê³µ - ìƒíƒœ ì—…ë°ì´íŠ¸ ë° Slack ì•Œë¦¼
        db.trading_logs.update_one(
            {"_id": log_record["_id"]},
            {"$set": {"status": "executed", ...}}
        )
        
        # íŠ¸ë ˆì¼ë§ ìŠ¤í†± ì´ˆê¸°í™” (ì²´ê²° ì™„ë£Œ ì‹œ)
        self._initialize_trailing_stop_after_buy(
            ticker=ticker,
            stock_name=stock_name,
            purchase_price=log_record.get("price", 0),
            function_name=function_name
        )
    else:
        # ë¯¸ì²´ê²° - pending ìƒíƒœë¡œ ìœ ì§€
        db.trading_logs.update_one(
            {"_id": log_record["_id"]},
            {"$set": {"status": "pending", ...}}
        )
```

**í•µì‹¬ ë¡œì§**:
- ì£¼ë¬¸ ì ‘ìˆ˜ í›„ 5ì´ˆ ëŒ€ê¸° (ì²´ê²°ê¹Œì§€ ì‹œê°„ í•„ìš”)
- ì£¼ë¬¸ì²´ê²°ë‚´ì—­ API(`get_overseas_order_detail`)ë¡œ ì²´ê²° ì—¬ë¶€ í™•ì¸
- ì²´ê²° ì‹œ: `executed` ìƒíƒœë¡œ ë³€ê²½, Slack ì•Œë¦¼ ì „ì†¡
- ë¯¸ì²´ê²° ì‹œ: `pending` ìƒíƒœë¡œ ìœ ì§€, ë¯¸ì²´ê²° ì•Œë¦¼ ì „ì†¡
- Fallback: ì£¼ë¬¸ ì¡°íšŒ ì‹¤íŒ¨ ì‹œ ì”ê³  ì¡°íšŒë¡œ ì²´ê²° ì—¬ë¶€ í™•ì¸

#### 6-1. íŠ¸ë ˆì¼ë§ ìŠ¤í†± ì´ˆê¸°í™”

**ì²´ê²° ì™„ë£Œ ì‹œ ìë™ ì‹¤í–‰**:
- íŠ¸ë ˆì¼ë§ ìŠ¤í†± ì„¤ì •ì´ í™œì„±í™”ëœ ê²½ìš°(`trailing_stop_enabled: true`)
- ë ˆë²„ë¦¬ì§€ ì¢…ëª© ìë™ ê°ì§€ (MongoDB `leverage_ticker` í•„ë“œ ë˜ëŠ” ì¢…ëª©ëª… í‚¤ì›Œë“œ)
- ì¼ë°˜ ì¢…ëª©: íŠ¸ë ˆì¼ë§ ê±°ë¦¬ 5%, ìµœì†Œ ìˆ˜ìµë¥  3%
- ë ˆë²„ë¦¬ì§€ ETF: íŠ¸ë ˆì¼ë§ ê±°ë¦¬ 7%, ìµœì†Œ ìˆ˜ìµë¥  5%
- ì´ˆê¸° ìµœê³ ê°€: êµ¬ë§¤ê°€, ì´ˆê¸° ë™ì  ìµì ˆê°€: êµ¬ë§¤ê°€ Ã— (1 - íŠ¸ë ˆì¼ë§ ê±°ë¦¬%)

**íŒŒì¼**: `app/utils/scheduler.py` â†’ `_initialize_trailing_stop_after_buy()`

**ì½”ë”© ê°€ì´ë“œ**:
```python
# âœ… ì˜¬ë°”ë¥¸ ì˜ˆì‹œ: ë¹„ë™ê¸° ì²´ê²° í™•ì¸
if order_no:
    asyncio.create_task(self._check_and_update_execution(
        order_no=order_no,
        ticker=ticker,
        stock_name=stock_name,
        before_quantity=before_quantity,
        order_quantity=quantity
    ))

# âŒ ì˜ëª»ëœ ì˜ˆì‹œ: ë™ê¸° ì‹¤í–‰ (ë‹¤ìŒ ì¢…ëª© ë§¤ìˆ˜ ì§€ì—°)
if order_no:
    await self._check_and_update_execution(...)  # ë‹¤ìŒ ì¢…ëª© ë§¤ìˆ˜ê°€ ì§€ì—°ë¨
```

**ì²´ê²° í™•ì¸ ë°©ë²•**:
1. **ì£¼ë¬¸ì²´ê²°ë‚´ì—­ API**: ì£¼ë¬¸ë²ˆí˜¸ë¡œ ì¡°íšŒí•˜ì—¬ `CNTG_YN` ë˜ëŠ” `nccs_qty` í™•ì¸
2. **ì”ê³  ì¡°íšŒ**: ì£¼ë¬¸ ì ‘ìˆ˜ ì „ ë³´ìœ  ìˆ˜ëŸ‰ê³¼ ë¹„êµí•˜ì—¬ ì¦ê°€ ì—¬ë¶€ í™•ì¸

---

### 7ï¸âƒ£ ì¥ ë§ˆê° í›„ ë¯¸ì²´ê²° ì£¼ë¬¸ ì •ë¦¬

**íŒŒì¼**: `app/utils/scheduler.py` â†’ `_cleanup_pending_orders()`

**ì½”ë“œ ìœ„ì¹˜**:
```python
def _cleanup_pending_orders(self, send_slack_notification: bool = True):
    """ì¥ ë§ˆê° í›„ ë¯¸ì²´ê²° ì£¼ë¬¸ ì¼ê´„ ì •ë¦¬ (ì‹¤íŒ¨ ìƒíƒœë¡œ ë³€ê²½)"""
    # ì¥ ë§ˆê° í™•ì¸ (16:00 ET ì´í›„)
    now_in_ny = datetime.now(pytz.timezone('America/New_York'))
    if not is_after_market_close:
        return
    
    # ë¯¸ì²´ê²° ì£¼ë¬¸ ì¡°íšŒ
    pending_orders = list(db.trading_logs.find({
        "status": {"$in": ["pending", "accepted"]},
        "created_at": {"$gte": yesterday_start}
    }))
    
    # ê° ì£¼ë¬¸ì„ ì‹¤íŒ¨ ìƒíƒœë¡œ ë³€ê²½
    for order in pending_orders:
        db.trading_logs.update_one(
            {"_id": order["_id"]},
            {
                "$set": {
                    "status": "failed",
                    "failed_at": datetime.now(),
                    "failure_reason": "ì¥ ë§ˆê° í›„ ë¯¸ì²´ê²°ë¡œ ì¸í•œ ìë™ ì·¨ì†Œ"
                }
            }
        )
```

**í•µì‹¬ ë¡œì§**:
- ë§¤ì¼ ìƒˆë²½ 6ì‹œ 30ë¶„ (í•œêµ­ ì‹œê°„) ìë™ ì‹¤í–‰
- ì¥ ë§ˆê° í›„(16:00 ET ì´í›„)ì—ë§Œ ì‹¤í–‰
- `pending` ë˜ëŠ” `accepted` ìƒíƒœì¸ ì£¼ë¬¸ ì¡°íšŒ
- ëª¨ë“  ë¯¸ì²´ê²° ì£¼ë¬¸ì„ `failed` ìƒíƒœë¡œ ë³€ê²½
- ê°œë³„ ë° ìš”ì•½ Slack ì•Œë¦¼ ì „ì†¡

**ì²˜ë¦¬ ëŒ€ìƒ**:
- ì–´ì œë¶€í„° ì˜¤ëŠ˜ê¹Œì§€ ìƒì„±ëœ ë¯¸ì²´ê²° ì£¼ë¬¸
- ìƒíƒœê°€ `pending` ë˜ëŠ” `accepted`ì¸ ì£¼ë¬¸

**ì½”ë”© ê°€ì´ë“œ**:
```python
# âœ… ì˜¬ë°”ë¥¸ ì˜ˆì‹œ: ì¥ ë§ˆê° í™•ì¸
is_weekday = 0 <= ny_weekday <= 4
is_after_market_close = ny_hour >= 16

if not is_after_market_close and is_weekday:
    logger.info("ì¥ ë§ˆê° ì „ì…ë‹ˆë‹¤. ì •ë¦¬ ì‘ì—…ì„ ê±´ë„ˆëœë‹ˆë‹¤.")
    return

# âŒ ì˜ëª»ëœ ì˜ˆì‹œ: ì‹œê°„ í™•ì¸ ì—†ì´ ì‹¤í–‰
# ì¥ ì‹œê°„ ì¤‘ì—ë„ ì‹¤í–‰ë  ìˆ˜ ìˆìŒ
```

---

## ì½”ë“œ êµ¬ì¡° ë° íŒŒì¼ ìœ„ì¹˜

### ğŸ“‚ íŒŒì¼ êµ¬ì¡°

```
app/
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ auto_trading_service.py      # ìë™ë§¤ë§¤ ì„œë¹„ìŠ¤ (ë§¤ìˆ˜ ë¡œì§)
â”‚   â”œâ”€â”€ stock_recommendation_service.py  # ì¶”ì²œ ì„œë¹„ìŠ¤ (í›„ë³´ ì„ ì •)
â”‚   â””â”€â”€ balance_service.py           # ì”ê³  ë° ì£¼ë¬¸ ì„œë¹„ìŠ¤
â”œâ”€â”€ api/
â”‚   â””â”€â”€ routes/
â”‚       â”œâ”€â”€ auto_trading.py          # ìë™ë§¤ë§¤ API ë¼ìš°í„°
â”‚       â””â”€â”€ stock_recommendations.py  # ì¶”ì²œ API ë¼ìš°í„°
â”œâ”€â”€ utils/
â”‚   â””â”€â”€ scheduler.py                 # ìŠ¤ì¼€ì¤„ëŸ¬ (íŠ¸ë¦¬ê±°)
â”œâ”€â”€ schemas/
â”‚   â””â”€â”€ auto_trading.py              # ë°ì´í„° ëª¨ë¸
â””â”€â”€ core/
    â””â”€â”€ config.py                     # ì„¤ì • ê´€ë¦¬
```

### ğŸ”— ì£¼ìš” í•¨ìˆ˜ í˜¸ì¶œ ì²´ì¸

```
scheduler._run_auto_buy()
    â””â”€> scheduler._execute_auto_buy()
        â””â”€> auto_trading_service.get_buy_candidates()
            â””â”€> stock_recommendation_service.get_combined_recommendations_with_technical_and_sentiment()
                â”œâ”€> Supabase: stock_analysis_results ì¡°íšŒ
                â”œâ”€> Supabase: stock_recommendations ì¡°íšŒ
                â””â”€> Supabase: ticker_sentiment_analysis ì¡°íšŒ
        â””â”€> balance_service.get_overseas_balance()
        â””â”€> balance_service.get_current_price()
        â””â”€> auto_trading_service.calculate_buy_quantity()
            â””â”€> balance_service.inquire_psamount()
        â””â”€> balance_service.order_overseas_stock()
            â””â”€> KIS API í˜¸ì¶œ
        â””â”€> auto_trading_service._save_order_log()
            â””â”€> Supabase: auto_trading_logs ì €ì¥
```

---

## ë°ì´í„° íë¦„ ë‹¤ì´ì–´ê·¸ë¨

### ğŸ“Š ë°ì´í„° íë¦„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ë°ì´í„° ì†ŒìŠ¤ ë ˆì´ì–´                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  Supabase                                                    â”‚
â”‚  â”œâ”€ stock_analysis_results (AI ì˜ˆì¸¡)                         â”‚
â”‚  â”‚  â””â”€ accuracy, rise_probability, predicted_price          â”‚
â”‚  â”‚                                                           â”‚
â”‚  â”œâ”€ stock_recommendations (ê¸°ìˆ ì  ì§€í‘œ)                      â”‚
â”‚  â”‚  â””â”€ golden_cross, rsi, macd_buy_signal                   â”‚
â”‚  â”‚                                                           â”‚
â”‚  â”œâ”€ ticker_sentiment_analysis (ê°ì • ë¶„ì„)                    â”‚
â”‚  â”‚  â””â”€ average_sentiment_score, article_count                â”‚
â”‚  â”‚                                                           â”‚
â”‚  â””â”€ auto_trading_config (ì„¤ì •)                               â”‚
â”‚     â””â”€ min_composite_score, max_stocks_to_buy, ...           â”‚
â”‚                                                               â”‚
â”‚  MongoDB                                                     â”‚
â”‚  â”œâ”€ users (ì‚¬ìš©ì ì„¤ì •)                                       â”‚
â”‚  â”‚  â””â”€ stocks[].use_leverage, leverage_ticker               â”‚
â”‚  â”‚                                                           â”‚
â”‚  â””â”€ daily_stock_data (ì£¼ê°€ ë°ì´í„°)                           â”‚
â”‚     â””â”€ ê¸°ìˆ ì  ì§€í‘œ ê³„ì‚°ìš©                                     â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ì¶”ì²œ ì„œë¹„ìŠ¤ (í†µí•© ë¶„ì„)                           â”‚
â”‚  get_combined_recommendations_with_technical_and_sentiment()â”‚
â”‚                                                               â”‚
â”‚  1. AI ì˜ˆì¸¡ ë°ì´í„° ì¡°íšŒ                                       â”‚
â”‚  2. ê¸°ìˆ ì  ì§€í‘œ ë°ì´í„° ì¡°íšŒ                                   â”‚
â”‚  3. ê°ì • ë¶„ì„ ë°ì´í„° ì¡°íšŒ                                     â”‚
â”‚  4. ë°ì´í„° í†µí•© ë° í•„í„°ë§                                     â”‚
â”‚  5. ì¢…í•© ì ìˆ˜ ê³„ì‚°                                            â”‚
â”‚     composite_score = (ìƒìŠ¹í™•ë¥  Ã— 0.3) +                      â”‚
â”‚                       (ê¸°ìˆ ì ì§€í‘œ Ã— 0.4) +                    â”‚
â”‚                       (ê°ì •ì ìˆ˜ Ã— 0.3)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ìë™ë§¤ë§¤ ì„œë¹„ìŠ¤ (í›„ë³´ ì„ ì •)                       â”‚
â”‚  get_buy_candidates()                                        â”‚
â”‚                                                               â”‚
â”‚  1. ì¢…í•© ì ìˆ˜ í•„í„°ë§ (min_composite_score)                    â”‚
â”‚  2. ê°ì • ì ìˆ˜ í•„í„°ë§ (min_sentiment_score, ì„ íƒì )            â”‚
â”‚  3. ìµœëŒ€ ì¢…ëª© ìˆ˜ ì œí•œ (max_stocks_to_buy)                     â”‚
â”‚  4. ì¢…í•© ì ìˆ˜ ê¸°ì¤€ ì •ë ¬                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ìŠ¤ì¼€ì¤„ëŸ¬ (ë§¤ìˆ˜ ì‹¤í–‰)                              â”‚
â”‚  _execute_auto_buy()                                        â”‚
â”‚                                                               â”‚
â”‚  ê° ì¢…ëª©ë³„ ì²˜ë¦¬:                                             â”‚
â”‚  1. ë ˆë²„ë¦¬ì§€ ì„¤ì • í™•ì¸ (MongoDB users)                        â”‚
â”‚  2. ê±°ë˜ì†Œ ì½”ë“œ ê²°ì •                                          â”‚
â”‚  3. í˜„ì¬ê°€ ì¡°íšŒ (KIS API)                                     â”‚
â”‚  4. ë§¤ìˆ˜ ê°€ëŠ¥ ìˆ˜ëŸ‰ ê³„ì‚° (KIS API)                             â”‚
â”‚  5. ë§¤ìˆ˜ ì£¼ë¬¸ ì‹¤í–‰ (KIS API)                                  â”‚
â”‚  6. ì£¼ë¬¸ ê¸°ë¡ ì €ì¥ (Supabase)                                â”‚
â”‚  7. Slack ì•Œë¦¼ ì „ì†¡                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ì½”ë”© ê°€ì´ë“œë¼ì¸

### âœ… í•„ìˆ˜ ì²´í¬ë¦¬ìŠ¤íŠ¸

#### 1. ì—ëŸ¬ ì²˜ë¦¬

```python
# âœ… ì˜¬ë°”ë¥¸ ì˜ˆì‹œ
try:
    result = api_call()
    if result.get("rt_cd") != "0":
        logger.error(f"API ì˜¤ë¥˜: {result.get('msg1')}")
        return {"success": False, "error": result.get("msg1")}
except Exception as e:
    logger.error(f"ì˜ˆì™¸ ë°œìƒ: {str(e)}", exc_info=True)
    return {"success": False, "error": str(e)}

# âŒ ì˜ëª»ëœ ì˜ˆì‹œ
result = api_call()  # ì˜ˆì™¸ ì²˜ë¦¬ ì—†ìŒ
data = result["output"]  # KeyError ê°€ëŠ¥
```

#### 2. íƒ€ì… ë³€í™˜

```python
# âœ… ì˜¬ë°”ë¥¸ ì˜ˆì‹œ
try:
    price = float(price_str or 0)
    if price <= 0:
        logger.warning("ìœ íš¨í•˜ì§€ ì•Šì€ ê°€ê²©")
        continue
except (ValueError, TypeError):
    logger.error("ê°€ê²© ë³€í™˜ ì‹¤íŒ¨")
    continue

# âŒ ì˜ëª»ëœ ì˜ˆì‹œ
price = float(price_str)  # Noneì´ë©´ ì—ëŸ¬
```

#### 3. None ì²´í¬

```python
# âœ… ì˜¬ë°”ë¥¸ ì˜ˆì‹œ
if result and result.get("output"):
    data = result["output"]
else:
    logger.warning("ë°ì´í„° ì—†ìŒ")
    return

# âŒ ì˜ëª»ëœ ì˜ˆì‹œ
data = result["output"]  # resultê°€ Noneì´ë©´ ì—ëŸ¬
```

#### 4. ì„¤ì • ê¸°ë°˜ ë¡œì§

```python
# âœ… ì˜¬ë°”ë¥¸ ì˜ˆì‹œ
config = self.get_auto_trading_config()
min_score = config.get("min_composite_score", 2.0)
if stock.get("composite_score", 0) < min_score:
    continue

# âŒ ì˜ëª»ëœ ì˜ˆì‹œ
if stock.get("composite_score", 0) < 2.0:  # í•˜ë“œì½”ë”©
    continue
```

#### 5. ë¡œê¹…

```python
# âœ… ì˜¬ë°”ë¥¸ ì˜ˆì‹œ
logger.info(f"[{function_name}] ë§¤ìˆ˜ ì‹œì‘: {ticker}")
logger.error(f"[{function_name}] ë§¤ìˆ˜ ì‹¤íŒ¨: {error}", exc_info=True)

# âŒ ì˜ëª»ëœ ì˜ˆì‹œ
print(f"ë§¤ìˆ˜ ì‹œì‘: {ticker}")  # ë¡œê±° ì‚¬ìš© ì•ˆ í•¨
```

### ğŸ“ ì½”ë”© íŒ¨í„´

#### íŒ¨í„´ 1: ì„¤ì • ê¸°ë°˜ í•„í„°ë§

```python
def filter_candidates(candidates: List[Dict], config: Dict) -> List[Dict]:
    """ì„¤ì • ê¸°ë°˜ í›„ë³´ í•„í„°ë§"""
    filtered = []
    
    for candidate in candidates:
        # ì¢…í•© ì ìˆ˜ í•„í„°ë§
        if candidate.get("composite_score", 0) < config.get("min_composite_score", 2.0):
            continue
        
        # ê°ì • ì ìˆ˜ í•„í„°ë§ (ì„ íƒì )
        if config.get("use_sentiment", False):
            sentiment = candidate.get("sentiment_score")
            if sentiment is None or sentiment < config.get("min_sentiment_score", 0.15):
                continue
        
        filtered.append(candidate)
    
    return filtered
```

#### íŒ¨í„´ 2: ì•ˆì „í•œ API í˜¸ì¶œ

```python
def safe_api_call(api_func, *args, **kwargs):
    """ì•ˆì „í•œ API í˜¸ì¶œ ë˜í¼"""
    max_retries = 3
    for attempt in range(max_retries):
        try:
            result = api_func(*args, **kwargs)
            
            # ì‘ë‹µ ê²€ì¦
            if result.get("rt_cd") != "0":
                error_msg = result.get("msg1", "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜")
                logger.warning(f"API ì˜¤ë¥˜ (ì‹œë„ {attempt+1}/{max_retries}): {error_msg}")
                
                if attempt < max_retries - 1:
                    time.sleep(2 ** attempt)  # ì§€ìˆ˜ ë°±ì˜¤í”„
                    continue
                else:
                    return {"success": False, "error": error_msg}
            
            return {"success": True, "data": result}
            
        except Exception as e:
            logger.error(f"API í˜¸ì¶œ ì˜ˆì™¸ (ì‹œë„ {attempt+1}/{max_retries}): {str(e)}")
            if attempt < max_retries - 1:
                time.sleep(2 ** attempt)
                continue
            else:
                return {"success": False, "error": str(e)}
    
    return {"success": False, "error": "ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼"}
```

#### íŒ¨í„´ 3: ëŒ€ì²´ ê°€ê²© ì‚¬ìš©

```python
def get_price_with_fallback(ticker: str, candidate: Dict) -> float:
    """í˜„ì¬ê°€ ì¡°íšŒ (ëŒ€ì²´ ê°€ê²© í¬í•¨)"""
    # 1ì°¨: ì‹¤ì‹œê°„ ê°€ê²© ì¡°íšŒ
    price_result = get_current_price({"EXCD": "NAS", "SYMB": ticker})
    
    if price_result.get("rt_cd") == "0":
        output = price_result.get("output", {})
        last_price = float(output.get("last") or 0)
        
        if last_price > 0:
            return last_price
        
        # 2ì°¨: ì „ì¼ ì¢…ê°€ ì‚¬ìš©
        base_price = float(output.get("base") or 0)
        if base_price > 0:
            logger.warning(f"{ticker} - ì „ì¼ ì¢…ê°€ ì‚¬ìš©: {base_price}")
            return base_price
    
    # 3ì°¨: ì¶”ì²œ ë°ì´í„°ì˜ ê°€ê²© ì‚¬ìš©
    cached_price = float(candidate.get("last_price") or 0)
    if cached_price > 0:
        logger.warning(f"{ticker} - ì¶”ì²œ ë‹¹ì‹œ ê°€ê²© ì‚¬ìš©: {cached_price}")
        return cached_price
    
    predicted_price = float(candidate.get("predicted_price") or 0)
    if predicted_price > 0:
        logger.warning(f"{ticker} - AI ì˜ˆì¸¡ ê°€ê²© ì‚¬ìš©: {predicted_price}")
        return predicted_price
    
    raise ValueError(f"{ticker} - ìœ íš¨í•œ ê°€ê²©ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ")
```

---

## ì„¤ì • ë° ì»¤ìŠ¤í„°ë§ˆì´ì§•

### âš™ï¸ ìë™ë§¤ë§¤ ì„¤ì •

**í…Œì´ë¸”**: `auto_trading_config` (Supabase)

**ì„¤ì • í•­ëª©**:

| í•­ëª© | íƒ€ì… | ê¸°ë³¸ê°’ | ì„¤ëª… |
|-----|------|-------|------|
| `enabled` | boolean | `false` | ìë™ë§¤ë§¤ í™œì„±í™” ì—¬ë¶€ |
| `min_composite_score` | float | `2.0` | ìµœì†Œ ì¢…í•© ì ìˆ˜ |
| `max_stocks_to_buy` | int | `5` | ìµœëŒ€ ë§¤ìˆ˜ ì¢…ëª© ìˆ˜ |
| `max_amount_per_stock` | float | `10000.0` | ì¢…ëª©ë‹¹ ìµœëŒ€ ë§¤ìˆ˜ ê¸ˆì•¡ (USD) |
| `stop_loss_percent` | float | `-7.0` | ì†ì ˆ ê¸°ì¤€ (%) |
| `take_profit_percent` | float | `5.0` | ìµì ˆ ê¸°ì¤€ (%) |
| `use_sentiment` | boolean | `true` | ê°ì • ë¶„ì„ ì‚¬ìš© ì—¬ë¶€ |
| `min_sentiment_score` | float | `0.15` | ìµœì†Œ ê°ì • ì ìˆ˜ |
| `order_type` | string | `"00"` | ì£¼ë¬¸ êµ¬ë¶„ (00: ì§€ì •ê°€) |
| `trailing_stop_enabled` | boolean | `false` | íŠ¸ë ˆì¼ë§ ìŠ¤í†± í™œì„±í™” ì—¬ë¶€ |
| `trailing_stop_distance_percent` | float | `5.0` | ì¼ë°˜ ì¢…ëª© íŠ¸ë ˆì¼ë§ ê±°ë¦¬ (%) |
| `leveraged_trailing_stop_distance_percent` | float | `7.0` | ë ˆë²„ë¦¬ì§€ ì¢…ëª© íŠ¸ë ˆì¼ë§ ê±°ë¦¬ (%) |
| `trailing_stop_min_profit_percent` | float | `3.0` | ì¼ë°˜ ì¢…ëª© ìµœì†Œ ìˆ˜ìµë¥  (%) |
| `leveraged_trailing_stop_min_profit_percent` | float | `5.0` | ë ˆë²„ë¦¬ì§€ ì¢…ëª© ìµœì†Œ ìˆ˜ìµë¥  (%) |

**ì„¤ì • ì—…ë°ì´íŠ¸ ë°©ë²•**:

```python
# APIë¥¼ í†µí•œ ì„¤ì • ì—…ë°ì´íŠ¸
PUT /api/auto-trading/config
{
    "enabled": true,
    "min_composite_score": 2.5,
    "max_stocks_to_buy": 3,
    "max_amount_per_stock": 5000.0
}
```

### ğŸ¯ ë§¤ìˆ˜ ì¡°ê±´ ì»¤ìŠ¤í„°ë§ˆì´ì§•

#### 1. ì¢…í•© ì ìˆ˜ ê¸°ì¤€ ë³€ê²½

**íŒŒì¼**: `app/services/auto_trading_service.py`

```python
# í˜„ì¬ ì½”ë“œ
if stock.get("composite_score", 0) < config.get("min_composite_score", 2.0):
    continue

# ë” ë³´ìˆ˜ì ìœ¼ë¡œ ë³€ê²½
if stock.get("composite_score", 0) < 2.5:  # 2.0 â†’ 2.5
    continue

# ë” ê³µê²©ì ìœ¼ë¡œ ë³€ê²½
if stock.get("composite_score", 0) < 1.5:  # 2.0 â†’ 1.5
    continue
```

#### 2. ê°ì • ì ìˆ˜ ê¸°ì¤€ ë³€ê²½

**íŒŒì¼**: `app/services/auto_trading_service.py`

```python
# í˜„ì¬ ì½”ë“œ
if sentiment_score is None or sentiment_score < config.get("min_sentiment_score", 0.15):
    continue

# ë” ë³´ìˆ˜ì ìœ¼ë¡œ ë³€ê²½
if sentiment_score is None or sentiment_score < 0.25:  # 0.15 â†’ 0.25
    continue

# ë” ê³µê²©ì ìœ¼ë¡œ ë³€ê²½
if sentiment_score is None or sentiment_score < 0.10:  # 0.15 â†’ 0.10
    continue
```

#### 3. ê¸°ìˆ ì  ì§€í‘œ ì¡°ê±´ ë³€ê²½

**íŒŒì¼**: `app/services/stock_recommendation_service.py` â†’ `get_combined_recommendations_with_technical_and_sentiment()`

```python
# í˜„ì¬ ì½”ë“œ
if sentiment_score is not None and sentiment_score >= 0.15:
    if sum(tech_conditions) >= 2:  # ê¸°ìˆ ì  ì§€í‘œ 2ê°œ
        final_results.append(item)
else:
    if sum(tech_conditions) >= 3:  # ê¸°ìˆ ì  ì§€í‘œ 3ê°œ
        final_results.append(item)

# ë” ë³´ìˆ˜ì ìœ¼ë¡œ ë³€ê²½
if sentiment_score is not None and sentiment_score >= 0.25:
    if sum(tech_conditions) >= 3:  # 2ê°œ â†’ 3ê°œ
        final_results.append(item)
else:
    if sum(tech_conditions) >= 3:  # ìœ ì§€
        final_results.append(item)

# ë” ê³µê²©ì ìœ¼ë¡œ ë³€ê²½
if sentiment_score is not None and sentiment_score >= 0.10:
    if sum(tech_conditions) >= 1:  # 2ê°œ â†’ 1ê°œ
        final_results.append(item)
else:
    if sum(tech_conditions) >= 2:  # 3ê°œ â†’ 2ê°œ
        final_results.append(item)
```

---

## API ì—”ë“œí¬ì¸íŠ¸ ì •ë¦¬

### ğŸ”Œ ìë™ë§¤ë§¤ API

#### 1. ì„¤ì • ì¡°íšŒ

```http
GET /api/auto-trading/config
```

**ì‘ë‹µ**:
```json
{
  "success": true,
  "config": {
    "enabled": true,
    "min_composite_score": 2.0,
    "max_stocks_to_buy": 5,
    "max_amount_per_stock": 10000.0,
    "stop_loss_percent": -7.0,
    "take_profit_percent": 5.0,
    "use_sentiment": true,
    "min_sentiment_score": 0.15,
    "order_type": "00"
  }
}
```

#### 2. ì„¤ì • ì—…ë°ì´íŠ¸

```http
PUT /api/auto-trading/config
Content-Type: application/json

{
  "enabled": true,
  "min_composite_score": 2.5,
  "max_stocks_to_buy": 3
}
```

#### 3. ë§¤ìˆ˜ í›„ë³´ ì¡°íšŒ

```http
GET /api/auto-trading/candidates/buy
```

**ì‘ë‹µ**:
```json
{
  "success": true,
  "message": "3ê°œì˜ ë§¤ìˆ˜ ì¶”ì²œ ì¢…ëª©ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤",
  "candidates": [
    {
      "ticker": "NVDA",
      "stock_name": "ì—”ë¹„ë””ì•„",
      "composite_score": 2.8,
      "sentiment_score": 0.35,
      "accuracy": 85.2,
      "rise_probability": 8.5,
      "last_price": 450.00,
      "predicted_price": 485.00
    }
  ]
}
```

#### 4. ìë™ ë§¤ìˆ˜ ì‹¤í–‰

```http
POST /api/auto-trading/execute/buy
Content-Type: application/json

{
  "dry_run": false
}
```

**ì‘ë‹µ**:
```json
{
  "success": true,
  "message": "2ê°œ ì¢…ëª© ì£¼ë¬¸ ì™„ë£Œ",
  "orders": [
    {
      "ticker": "NVDA",
      "stock_name": "ì—”ë¹„ë””ì•„",
      "price": 450.00,
      "quantity": 10,
      "estimated_amount": 4500.00,
      "composite_score": 2.8,
      "status": "success"
    }
  ],
  "config": { ... }
}
```

#### 5. ìë™ë§¤ë§¤ ìƒíƒœ ì¡°íšŒ

```http
GET /api/auto-trading/status
```

**ì‘ë‹µ**:
```json
{
  "success": true,
  "status": {
    "config": { ... },
    "holdings": {
      "count": 5,
      "total_value": 25000.0,
      "items": [ ... ]
    },
    "available_cash": 222.64,
    "candidates": {
      "buy": {
        "count": 3,
        "items": [ ... ]
      },
      "sell": {
        "count": 1,
        "items": [ ... ]
      }
    },
    "recent_orders": [ ... ]
  }
}
```

**ì‘ë‹µ í•„ë“œ ì„¤ëª…**:
- `config`: í˜„ì¬ ìë™ë§¤ë§¤ ì„¤ì •
- `holdings`: ë³´ìœ  ì¢…ëª© ì •ë³´
  - `count`: ë³´ìœ  ì¢…ëª© ìˆ˜
  - `total_value`: ì´ í‰ê°€ ê¸ˆì•¡ (USD)
  - `items`: ì¢…ëª©ë³„ ìƒì„¸ ì •ë³´
- `available_cash`: í˜„ê¸ˆ ì”ê³  (USD) - ë§¤ìˆ˜ ê°€ëŠ¥í•œ í˜„ê¸ˆ ê¸ˆì•¡
- `candidates`: ë§¤ìˆ˜/ë§¤ë„ í›„ë³´
  - `buy`: ë§¤ìˆ˜ ì¶”ì²œ ì¢…ëª© ëª©ë¡
  - `sell`: ë§¤ë„ ëŒ€ìƒ ì¢…ëª© ëª©ë¡
- `recent_orders`: ìµœê·¼ 7ì¼ê°„ ì£¼ë¬¸ ë‚´ì—­

### ğŸ”Œ ì¶”ì²œ ì‹œìŠ¤í…œ API

#### 1. í†µí•© ì¶”ì²œ ì¡°íšŒ

```http
GET /api/recommended-stocks/with-technical-and-sentiment
```

#### 2. í†µí•© ë¶„ì„ ìƒì„±

```http
POST /api/recommended-stocks/generate-complete-analysis
```

---

## ì—ëŸ¬ ì²˜ë¦¬ ë° ë¡œê¹…

### ğŸš¨ ì£¼ìš” ì—ëŸ¬ ì‹œë‚˜ë¦¬ì˜¤

#### 1. API í˜¸ì¶œ ì‹¤íŒ¨

```python
# ì—ëŸ¬ ì²˜ë¦¬ ì˜ˆì‹œ
try:
    result = get_current_price(params)
    if result.get("rt_cd") != "0":
        error_msg = result.get("msg1", "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜")
        logger.error(f"í˜„ì¬ê°€ ì¡°íšŒ ì‹¤íŒ¨: {error_msg}")
        # ëŒ€ì²´ ê°€ê²© ì‚¬ìš©
        current_price = candidate.get("last_price", 0)
except Exception as e:
    logger.error(f"í˜„ì¬ê°€ ì¡°íšŒ ì˜ˆì™¸: {str(e)}", exc_info=True)
    continue  # ë‹¤ìŒ ì¢…ëª©ìœ¼ë¡œ
```

#### 2. ì”ê³  ë¶€ì¡±

```python
# ì”ê³  ë¶€ì¡± ì²˜ë¦¬
quantity_result = self.calculate_buy_quantity(...)
if not quantity_result.get("success") or quantity_result.get("quantity", 0) <= 0:
    logger.warning(f"{ticker} - ë§¤ìˆ˜ ê°€ëŠ¥ ìˆ˜ëŸ‰ ì—†ìŒ (ì”ê³  ë¶€ì¡±)")
    skipped_no_cash += 1
    continue
```

#### 3. ì£¼ë¬¸ ì‹¤íŒ¨

```python
# ì£¼ë¬¸ ì‹¤íŒ¨ ì²˜ë¦¬
order_result = order_overseas_stock(order_data)
if order_result.get("rt_cd") != "0":
    error_msg = order_result.get("msg1", "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜")
    logger.error(f"{ticker} - ë§¤ìˆ˜ ì£¼ë¬¸ ì‹¤íŒ¨: {error_msg}")
    # Slack ì•Œë¦¼ ì „ì†¡
    slack_notifier.send_buy_notification(..., success=False, error_message=error_msg)
    continue
```

### ğŸ“ ë¡œê¹… ê°€ì´ë“œ

#### ë¡œê·¸ ë ˆë²¨

```python
# INFO: ì¼ë°˜ì ì¸ ì •ë³´
logger.info(f"[{function_name}] ë§¤ìˆ˜ ì‹œì‘: {ticker}")

# WARNING: ê²½ê³  (ê³„ì† ì§„í–‰ ê°€ëŠ¥)
logger.warning(f"{ticker} - ì”ê³  ë¶€ì¡±ìœ¼ë¡œ ë§¤ìˆ˜ ê±´ë„ˆëœ€")

# ERROR: ì˜¤ë¥˜ (ì²˜ë¦¬ ì‹¤íŒ¨)
logger.error(f"{ticker} - ë§¤ìˆ˜ ì£¼ë¬¸ ì‹¤íŒ¨: {error_msg}", exc_info=True)

# DEBUG: ë””ë²„ê¹… ì •ë³´
logger.debug(f"ì£¼ë¬¸ ë°ì´í„°: {order_data}")
```

#### ë¡œê·¸ í¬ë§·

```python
# í•¨ìˆ˜ëª… í¬í•¨
logger.info(f"[{function_name}] ì‘ì—… ì‹œì‘")

# ìƒì„¸ ì •ë³´ í¬í•¨
logger.info(f"[{function_name}] {stock_name}({ticker}) ë§¤ìˆ˜ ì„±ê³µ: {quantity}ì£¼ @ ${price}")

# ì—ëŸ¬ ì‹œ ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤ í¬í•¨
logger.error(f"[{function_name}] ì˜¤ë¥˜ ë°œìƒ: {str(e)}", exc_info=True)
```

---

## ì‹¤ì „ í™œìš© ì˜ˆì‹œ

### ğŸ¯ ì‹œë‚˜ë¦¬ì˜¤ 1: ìë™ ë§¤ìˆ˜ ì‹œìŠ¤í…œ ì‹œì‘

```python
import requests

BASE_URL = "http://localhost:8000/api"

# 1. ìë™ë§¤ë§¤ ì„¤ì • í™•ì¸
response = requests.get(f"{BASE_URL}/auto-trading/config")
config = response.json()["config"]

if not config.get("enabled"):
    # 2. ìë™ë§¤ë§¤ í™œì„±í™”
    requests.put(f"{BASE_URL}/auto-trading/config", json={"enabled": True})

# 3. ë§¤ìˆ˜ í›„ë³´ í™•ì¸
response = requests.get(f"{BASE_URL}/auto-trading/candidates/buy")
candidates = response.json()["candidates"]
print(f"ë§¤ìˆ˜ í›„ë³´: {len(candidates)}ê°œ")

# 4. Dry runìœ¼ë¡œ í…ŒìŠ¤íŠ¸
response = requests.post(f"{BASE_URL}/auto-trading/execute/buy", json={"dry_run": True})
print(response.json())

# 5. ì‹¤ì œ ë§¤ìˆ˜ ì‹¤í–‰
response = requests.post(f"{BASE_URL}/auto-trading/execute/buy", json={"dry_run": False})
print(response.json())
```

### ğŸ¯ ì‹œë‚˜ë¦¬ì˜¤ 2: ë³´ìˆ˜ì  ë§¤ìˆ˜ ì „ëµ ì„¤ì •

```python
# ë³´ìˆ˜ì  ì„¤ì • ì ìš©
config_update = {
    "enabled": True,
    "min_composite_score": 2.5,  # 2.0 â†’ 2.5 (ë” ë†’ì€ ê¸°ì¤€)
    "max_stocks_to_buy": 3,      # 5 â†’ 3 (ë” ì ì€ ì¢…ëª©)
    "max_amount_per_stock": 5000.0,  # 10000 â†’ 5000 (ë” ì ì€ ê¸ˆì•¡)
    "use_sentiment": True,
    "min_sentiment_score": 0.25  # 0.15 â†’ 0.25 (ë” ë†’ì€ ê°ì • ì ìˆ˜)
}

requests.put(f"{BASE_URL}/auto-trading/config", json=config_update)
```

### ğŸ¯ ì‹œë‚˜ë¦¬ì˜¤ 3: ê³µê²©ì  ë§¤ìˆ˜ ì „ëµ ì„¤ì •

```python
# ê³µê²©ì  ì„¤ì • ì ìš©
config_update = {
    "enabled": True,
    "min_composite_score": 1.5,  # 2.0 â†’ 1.5 (ë” ë‚®ì€ ê¸°ì¤€)
    "max_stocks_to_buy": 10,     # 5 â†’ 10 (ë” ë§ì€ ì¢…ëª©)
    "max_amount_per_stock": 15000.0,  # 10000 â†’ 15000 (ë” ë§ì€ ê¸ˆì•¡)
    "use_sentiment": True,
    "min_sentiment_score": 0.10  # 0.15 â†’ 0.10 (ë” ë‚®ì€ ê°ì • ì ìˆ˜)
}

requests.put(f"{BASE_URL}/auto-trading/config", json=config_update)
```

### ğŸ¯ ì‹œë‚˜ë¦¬ì˜¤ 4: ë§¤ìˆ˜ ìƒíƒœ ëª¨ë‹ˆí„°ë§

```python
import time
from datetime import datetime

def monitor_auto_trading():
    """ìë™ë§¤ë§¤ ìƒíƒœ ëª¨ë‹ˆí„°ë§"""
    while True:
        response = requests.get(f"{BASE_URL}/auto-trading/status")
        status = response.json()["status"]
        
        print(f"\n[{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}]")
        print(f"ë³´ìœ  ì¢…ëª©: {status['holdings']['count']}ê°œ")
        print(f"ì´ í‰ê°€ ê¸ˆì•¡: ${status['holdings']['total_value']:,.2f}")
        print(f"ë§¤ìˆ˜ í›„ë³´: {status['candidates']['buy']['count']}ê°œ")
        print(f"ë§¤ë„ í›„ë³´: {status['candidates']['sell']['count']}ê°œ")
        
        time.sleep(60)  # 1ë¶„ë§ˆë‹¤ í™•ì¸

# ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰
import threading
thread = threading.Thread(target=monitor_auto_trading, daemon=True)
thread.start()
```

---

## ğŸ“š ì°¸ê³  ë¬¸ì„œ

- [ë§¤ìˆ˜ ë™ì‘ ê°€ì´ë“œ](./ë§¤ìˆ˜_ë™ì‘_ê°€ì´ë“œ.md) - ë§¤ìˆ˜ ì‹œìŠ¤í…œ ìƒì„¸ ê°€ì´ë“œ
- [ìŠ¤ì¼€ì¤„ëŸ¬ ê°€ì´ë“œ](../system/ìŠ¤ì¼€ì¤„ëŸ¬_ê°€ì´ë“œ.md) - ìŠ¤ì¼€ì¤„ëŸ¬ ì „ì²´ ê°€ì´ë“œ
- [í†µí•© ì¶”ì²œ ì‹œìŠ¤í…œ ê°€ì´ë“œ](../recommendation/í†µí•©ì¶”ì²œì‹œìŠ¤í…œ_ê°€ì´ë“œ.md) - ì¶”ì²œ ì‹œìŠ¤í…œ ê°€ì´ë“œ

---

## ğŸ”„ ìµœê·¼ ë³€ê²½ì‚¬í•­

### 2025-12-29
- íŠ¸ë ˆì¼ë§ ìŠ¤í†± êµ¬í˜„ ì™„ë£Œ ë° í†µí•©
  - ë§¤ìˆ˜ ì²´ê²° ì‹œ íŠ¸ë ˆì¼ë§ ìŠ¤í†± ìë™ ì´ˆê¸°í™”
  - ë ˆë²„ë¦¬ì§€ ì¢…ëª©ë³„ íŠ¸ë ˆì¼ë§ ê±°ë¦¬ ì°¨ë³„í™” (ì¼ë°˜: 5%, ë ˆë²„ë¦¬ì§€: 7%)
  - ìµœê³ ê°€ ê°±ì‹  ë¡œì§ êµ¬í˜„ (ë§¤ë„ ìŠ¤ì¼€ì¤„ëŸ¬ 5ë¶„ë§ˆë‹¤)
  - íŠ¸ë ˆì¼ë§ ìŠ¤í†± ì¡°ê±´ ì¶©ì¡± ì‹œ Priority 2ë¡œ ìë™ ë§¤ë„

### 2025-12-12
- ë ˆë²„ë¦¬ì§€ ì„¤ì • ì§€ì› ì¶”ê°€ (MongoDB users ì»¬ë ‰ì…˜)
- ì—¬ëŸ¬ ê±°ë˜ì†Œì—ì„œ í˜„ì¬ê°€ ì¡°íšŒ ì‹œë„ ë¡œì§ ì¶”ê°€
- ëŒ€ì²´ ê°€ê²© ì‚¬ìš© ë¡œì§ ê°œì„  (ì „ì¼ ì¢…ê°€, ì¶”ì²œ ê°€ê²©, ì˜ˆì¸¡ ê°€ê²©)

### 2025-12-10
- ìë™ë§¤ë§¤ ì„œë¹„ìŠ¤ ë¶„ë¦¬ (`auto_trading_service.py`)
- ì„¤ì • ê¸°ë°˜ í•„í„°ë§ ë¡œì§ ê°œì„ 
- API ì—”ë“œí¬ì¸íŠ¸ ì •ë¦¬ ë° ë¬¸ì„œí™”

---

**ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸**: 2025-12-29

**ì‘ì„±ì**: Cursor AI

**ë²„ì „**: 1.0.0



