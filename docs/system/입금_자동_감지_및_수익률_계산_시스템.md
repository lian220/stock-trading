# 입금 자동 감지 및 수익률 계산 시스템

## 📋 목차

1. [시스템 개요](#시스템-개요)
2. [전체 플로우](#전체-플로우)
3. [데이터 구조](#데이터-구조)
4. [주요 컴포넌트](#주요-컴포넌트)
5. [사용 방법](#사용-방법)
6. [API 엔드포인트](#api-엔드포인트)
7. [주의사항](#주의사항)

---

## 시스템 개요

입금 자동 감지 및 수익률 계산 시스템은 다음과 같은 기능을 제공합니다:

- **입금 자동 감지**: 매매로 인한 잔액 변화와 실제 입금을 구분하여 추적
- **전체 수익률 계산**: 총 자산과 총 입금금액을 비교한 전체 수익률 계산
- **실현 수익률 계산**: 완료된 거래(매수→매도) 기준의 실현 수익률 계산
- **수동 입금 기록**: 입금 자동 감지 실패 시 수동 보정 가능

### ⚠️ 중요 사항

**이 시스템은 스케줄러에 자동으로 통합되지 않습니다.** 수동으로 실행하거나 별도의 스케줄링 시스템을 통해 주기적으로 실행해야 합니다.

---

## 전체 플로우

### 1. 계좌 잔액 조회 및 업데이트 플로우

```
┌─────────────────────────────────────────────────────────────┐
│ 1. 계좌 잔액 조회                                           │
│    scripts/update_user_balance.py 실행                      │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│ 2. KIS API 호출                                             │
│    get_overseas_present_balance()                           │
│    - 외화사용가능금액 (현재 보유 현금)                       │
│    - 매입금액 합계 (보유 종목 구매 금액)                     │
│    - 총 자산                                                │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│ 3. 현재 계산값 계산                                          │
│    total_deposit_usd = 매입금액 + 현재 보유 현금            │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│ 4. 이전 총 입금금액 조회                                    │
│    MongoDB users 컬렉션에서                                │
│    account_balance.previous_total_deposit_usd               │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│ 5. 입금 감지 로직                                            │
│    ┌──────────────────────────────────────────┐           │
│    │ 현재 계산값 > 이전 총 입금금액?            │           │
│    └──────┬───────────────────────┬───────────┘           │
│           │ YES                   │ NO                     │
│           ▼                       ▼                        │
│    ┌──────────────┐      ┌──────────────────┐            │
│    │ 입금 감지     │      │ 기존 값 유지      │            │
│    │ - 총 입금금액 │      │ (매매로 인한      │            │
│    │   업데이트    │      │  변화로 간주)     │            │
│    └──────────────┘      └──────────────────┘            │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│ 6. 수익률 계산                                               │
│    - 전체 수익률: (총 자산 - 총 입금금액) / 총 입금금액 * 100│
│    - 실현 수익률: 완료된 거래 기준 (calculate_cumulative)  │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│ 7. MongoDB 저장                                             │
│    users 컬렉션 업데이트                                    │
│    account_balance 필드에 모든 정보 저장                    │
└─────────────────────────────────────────────────────────────┘
```

### 2. 입금 감지 로직 상세

```
초기 상태:
  총 입금금액: $1,000
  매입금액: $0
  보유 현금: $1,000
  계산값: $0 + $1,000 = $1,000

매수 $500 후:
  매입금액: $500
  보유 현금: $500
  계산값: $500 + $500 = $1,000
  → 입금 없음 (기존 값 유지)

추가 입금 $500 후:
  매입금액: $500
  보유 현금: $1,000
  계산값: $500 + $1,000 = $1,500
  → 입금 감지! ($1,000 → $1,500)

매도 $100 후 (수익 $50):
  매입금액: $400
  보유 현금: $1,050
  계산값: $400 + $1,050 = $1,450
  → 입금 없음 (기존 값 유지, $1,500 유지)
```

### 3. 수익률 계산 플로우

```
┌─────────────────────────────────────────────────────────────┐
│ 전체 수익률 계산                                             │
│                                                              │
│ 1. users 컬렉션에서 총 입금금액 조회                        │
│ 2. 체결기준현재잔고 API로 총 자산 조회                      │
│ 3. 수익률 = (총 자산 - 총 입금금액) / 총 입금금액 * 100     │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│ 실현 수익률 계산                                             │
│                                                              │
│ 1. trading_logs에서 완료된 거래 조회 (매수→매도)            │
│ 2. FIFO 방식으로 매수/매도 매칭                              │
│ 3. 실현 수익률 = (총 실현 수익 / 총 매수 금액) * 100        │
└─────────────────────────────────────────────────────────────┘
```

---

## 데이터 구조

### AccountBalance 모델

```python
class AccountBalance(BaseModel):
    # 기본 정보
    available_usd: float  # 외화사용가능금액 (현재 보유 현금)
    total_valuation_usd: float  # 외화평가총액
    total_assets_usd: float  # 총 자산
    total_cost_usd: float  # 매입금액 합계 (보유 종목 구매 금액)
    total_value_usd: float  # 평가금액 합계
    total_profit_usd: float  # 총 평가손익
    total_profit_percent: float  # 총 평가손익률 (%)
    
    # 입금 관련
    total_deposit_usd: float  # 총 입금금액 (실제 외부 입금 금액)
    previous_total_deposit_usd: Optional[float]  # 이전 총 입금금액 (입금 감지용)
    deposit_history: Optional[List[Dict]]  # 입금 이력 (선택사항)
    
    # 수익률
    total_return_percent: Optional[float]  # 전체 수익률
    realized_return_percent: Optional[float]  # 실현 수익률
    ticker_realized_profit: Optional[Dict[str, Dict[str, float]]]  # 종목별 실현 수익률 (티커: {"profit_percent": float, "profit_usd": float})
    
    # 기타
    holdings_count: int  # 보유 종목 수
    exchange_rate: float  # 기준환율 (원/USD)
    currency: Optional[str]  # 통화코드
    currency_name: Optional[str]  # 통화명
    withdrawable_amount_usd: Optional[float]  # 출금가능금액
    last_updated: datetime  # 마지막 업데이트 시간
```

### MongoDB 저장 구조

```json
{
  "user_id": "lian",
  "account_balance": {
    "available_usd": 982.54,
    "total_assets_usd": 1500.00,
    "total_deposit_usd": 1000.00,
    "previous_total_deposit_usd": 500.00,
    "total_return_percent": 50.00,
    "realized_return_percent": 10.50,
    "ticker_realized_profit": {
      "AAPL": {
        "profit_percent": 5.25,
        "profit_usd": 125.50
      },
      "GOOGL": {
        "profit_percent": -2.10,
        "profit_usd": -45.20
      }
    },
    "last_updated": "2024-01-15T10:30:00Z"
  }
}
```

---

## 주요 컴포넌트

### 1. 스크립트: `scripts/update_user_balance.py`

**역할**: 계좌 잔액 조회 및 업데이트

**기능**:
- KIS API를 통한 계좌 잔액 조회
- 입금 자동 감지
- 수익률 계산
- MongoDB 저장

**사용법**:
```bash
# 기본 사용 (user_id: lian)
python scripts/update_user_balance.py

# 특정 사용자 지정
python scripts/update_user_balance.py <user_id>
```

### 2. 서비스: `app/services/balance_service.py`

**주요 함수**:

#### `get_overseas_present_balance()`
- 해외주식 체결기준현재잔고 조회
- 외화사용가능금액, 매입금액, 총 자산 등 조회

#### `calculate_total_return(user_id: str)`
- 전체 수익률 계산
- 총 자산과 총 입금금액 비교

#### `calculate_cumulative_profit(user_id: str, days: int, ticker: str)`
- 완료된 거래의 누적 수익률 계산
- FIFO 방식으로 매수/매도 매칭

#### `update_ticker_realized_profit(user_id: str, ticker: str)`
- 특정 종목의 실현 수익률을 계산하여 users 컬렉션에 업데이트
- 매도 체결 시 자동 호출
- 종목별 실현 수익률(수익률 + 금액) 저장

### 3. API 라우터: `app/api/routes/balance.py`

**엔드포인트**:
- `GET /api/balance/profit/total`: 전체 수익률 조회
- `GET /api/balance/profit/cumulative`: 실현 수익률 조회
- `POST /api/balance/deposit`: 수동 입금 기록

### 4. 모델: `app/models/mongodb_models.py`

**AccountBalance 모델**: 계좌 잔액 정보 구조 정의

---

## 사용 방법

### 1. 계좌 잔액 업데이트 (수동 실행)

```bash
# 가상환경 활성화
source venv/bin/activate

# 스크립트 실행
python scripts/update_user_balance.py
```

**출력 예시**:
```
================================================================================
사용자 계좌 정보 업데이트: lian
================================================================================

1️⃣ 계좌 정보 조회 중...
✅ 계좌 정보 조회 성공!

2️⃣ 추출된 계좌 정보:
   💰 총 입금금액: $1,500.00 USD
      - 매입금액: $500.00 USD
      - 현재 보유 현금: $1,000.00 USD
   
   💵 외화사용가능금액: $1,000.00 USD
   📊 외화평가총액: $1,200.00 USD
   💰 총 자산: $1,500.00 USD
   📊 전체 수익률: 0.00% (총 자산 기준)
   💰 실현 수익률: 10.50% (완료된 거래 기준)

3️⃣ MongoDB 업데이트 중...
💰 입금 감지: $500.00 USD 증가 (이전: $1,000.00 → 현재: $1,500.00)
✅ 사용자 'lian' 계좌 정보 업데이트 완료
```

### 2. API를 통한 수익률 조회

```bash
# 전체 수익률 조회
curl http://localhost:8000/api/balance/profit/total?user_id=lian

# 실현 수익률 조회
curl http://localhost:8000/api/balance/profit/cumulative?user_id=lian&days=90
```

### 3. 수동 입금 기록

```bash
curl -X POST "http://localhost:8000/api/balance/deposit?user_id=lian" \
  -H "Content-Type: application/json" \
  -d '{
    "amount": 500.0,
    "description": "추가 입금"
  }'
```

---

## API 엔드포인트

### 1. 전체 수익률 조회

**엔드포인트**: `GET /api/balance/profit/total`

**쿼리 파라미터**:
- `user_id` (string, 기본값: "lian"): 사용자 ID

**응답 예시**:
```json
{
  "success": true,
  "total_deposit_usd": 1000.00,
  "total_assets_usd": 1500.00,
  "total_return_usd": 500.00,
  "total_return_percent": 50.00
}
```

### 2. 실현 수익률 조회

**엔드포인트**: `GET /api/balance/profit/cumulative`

**쿼리 파라미터**:
- `user_id` (string, 필수): 사용자 ID
- `days` (int, 기본값: 90): 조회 기간 (일)
- `ticker` (string, 선택): 특정 티커만 조회

**응답 예시**:
```json
{
  "success": true,
  "trades": [...],
  "statistics": {
    "total_trades": 10,
    "winning_trades": 7,
    "losing_trades": 3,
    "win_rate": 70.0,
    "total_profit": 500.00,
    "total_cost": 1000.00,
    "total_profit_percent": 50.00
  },
  "by_ticker": [...]
}
```

### 3. 수동 입금 기록

**엔드포인트**: `POST /api/balance/deposit`

**쿼리 파라미터**:
- `user_id` (string, 기본값: "lian"): 사용자 ID

**요청 본문**:
```json
{
  "amount": 500.0,
  "date": "2024-01-15T10:30:00Z",  // 선택사항
  "description": "추가 입금"  // 선택사항
}
```

**응답 예시**:
```json
{
  "success": true,
  "total_deposit_usd": 1500.00,
  "deposit_increase": 500.00,
  "previous_deposit": 1000.00,
  "deposit_record": {
    "amount": 500.0,
    "date": "2024-01-15T10:30:00Z",
    "description": "추가 입금",
    "recorded_at": "2024-01-15T10:30:00Z"
  }
}
```

---

## 주의사항

### 1. 입금 감지의 한계

- **매도 수익 발생 시**: 입금으로 오인할 수 있음
  - 해결: 수동 보정 API 사용
- **매도 손실 발생 시**: 총 입금금액이 감소하지 않음 (정상 동작)

### 2. 스케줄링

**⚠️ 이 시스템은 스케줄러에 자동으로 통합되지 않습니다.**

주기적으로 실행하려면:
- **cron 작업 설정** (Linux/Mac)
- **Windows 작업 스케줄러** (Windows)
- **외부 스케줄링 서비스** (예: GitHub Actions, AWS Lambda)

**권장 실행 주기**: 
- 매일 1회 (장 마감 후)
- 또는 입금 후 수동 실행

### 3. 데이터 정확성

- 초기 입금금액은 수동으로 설정해야 할 수 있음
- 입금 자동 감지가 실패한 경우 수동 보정 API 사용
- 입금 이력(`deposit_history`)을 통해 추적 가능

### 4. 수익률 계산

- **전체 수익률**: 미실현 수익과 실현 수익 모두 포함
- **실현 수익률**: 완료된 거래(매수→매도)만 포함
- **종목별 실현 수익률**: 각 종목별로 완료된 거래의 수익률과 금액 저장
  - 형식: `{"티커": {"profit_percent": 수익률%, "profit_usd": 금액USD}}`
  - 매도 체결 시 자동 업데이트
- 두 수익률은 서로 다른 의미이므로 함께 확인 권장

---

## 관련 문서

- [스케줄러 가이드](./스케줄러_가이드.md)
- [자동매수 흐름 종합가이드](../trading/자동매수_흐름_종합가이드.md)
- [자동매도 전략 가이드](../trading/자동매도_전략_가이드.md)

---

## 변경 이력

- **2024-01-15**: 초기 구현
  - 입금 자동 감지 로직
  - 전체 수익률 계산
  - 실현 수익률 계산
  - 수동 입금 기록 API

- **2026-01-06**: 종목별 실현 수익률 추가
  - 종목별 실현 수익률 저장 기능 추가
  - 매도 체결 시 자동 업데이트
  - 수익률(%)과 금액(USD) 모두 저장
  - Slack 리포트에 계좌 정보 및 수익률 정보 추가

