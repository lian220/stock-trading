# ⏰ 자동 매매 스케줄러 가이드

주식 자동 매매 시스템의 스케줄러 전체 동작 방식을 설명합니다.

## 📋 목차
1. [스케줄러 개요](#스케줄러-개요)
2. [매수 스케줄러](#매수-스케줄러)
3. [매도 스케줄러](#매도-스케줄러)
4. [경제 데이터 스케줄러](#경제-데이터-스케줄러)
5. [스케줄러 제어 API](#스케줄러-제어-api)
6. [실행 조건](#실행-조건)
7. [사용 예시](#사용-예시)

---

## 스케줄러 개요

### 🔄 3가지 자동 스케줄러

| 스케줄러 | 실행 시간 | 작업 내용 |
|---------|----------|----------|
| **매수 스케줄러** | 매일 밤 12시 (한국 시간) | 추천 종목 자동 매수 |
| **매도 스케줄러** | 1분마다 | 보유 종목 자동 매도 |
| **경제 데이터 스케줄러** | 매일 새벽 6시 5분 (한국 시간) | 경제 지표 및 주가 데이터 수집 |

### 🎯 자동 실행

서버 시작 시 **모든 스케줄러가 자동으로 시작**됩니다:

```python
# app/main.py
async def startup():
    # 1. 경제 데이터 즉시 수집
    await update_economic_data_in_background()
    
    # 2. 경제 데이터 스케줄러 시작
    start_economic_data_scheduler()
    
    # 3. 매수 스케줄러 시작
    start_scheduler()
    
    # 4. 매도 스케줄러 시작
    start_sell_scheduler()
```

---

## 매수 스케줄러

### ⏰ 실행 시간

**한국 시간 기준 매일 밤 12시 (00:00)**

```python
schedule.every().day.at("00:00").do(self._run_auto_buy)
```

### 🔍 실행 흐름

```
1. 주말 체크 (뉴욕 시간 기준)
   └─ 토요일/일요일이면 종료
   
2. 미국 장 시간 체크
   └─ 평일 9:30 AM - 4:00 PM ET 확인
   └─ 장이 닫혀있으면 종료
   
3. 보유 종목 조회
   └─ 중복 매수 방지
   
4. 주문가능금액 조회 (TTTS3007R)
   └─ 실제 매수 가능한 달러 금액 확인
   
5. 매수 추천 종목 조회
   └─ AI 예측 + 기술적 지표 + 감정 분석
   └─ 종합 점수 높은 순으로 정렬
   
6. 우선순위대로 매수
   ├─ 이미 보유 중이면 SKIP
   ├─ 잔고 부족하면 SKIP
   ├─ 현재가 조회
   ├─ 매수 주문 실행
   ├─ 잔고 차감
   └─ Slack 알림 전송
   
7. 매수 완료 요약 로그
   └─ 성공 건수, 잔고 부족 건수, 남은 잔고
```

### 📊 매수 대상 선정 조건

#### 1번 조건 (기본 필터)
- Accuracy ≥ 80%
- Rise Probability ≥ 3%

#### 2번 조건 (기술적 지표)
골든 크로스, RSI < 50, MACD 매수신호 중 **2개 이상** 충족

#### 3번 조건 (감정 분석)
- Sentiment Score ≥ 0.15

**최종 선정**: 1번 통과 + 3번 만족 + 2번 항목 중 2개 이상 만족

### 💰 잔고 관리

```python
# 매수 전 잔고 조회
order_psbl_result = get_overseas_order_possible_amount("NASD", "AAPL")
available_cash = output.get("ord_psbl_frcr_amt")

# 각 종목 매수 시 잔고 확인
if available_cash < estimated_cost:
    logger.warning(f"{stock_name} - 잔고 부족으로 매수 건너뜀")
    continue

# 매수 성공 시 잔고 차감
available_cash -= (current_price * quantity)
```

### 📝 로그 예시

```
2025-12-03 23:30:00 - 자동 매수 작업 시작
2025-12-03 23:30:01 - 미국 장 시간 확인: 한국 2025-12-03 23:30:00 (뉴욕 2025-12-03 09:30:00)
2025-12-03 23:30:02 - 현재 보유 중인 종목 수: 0
2025-12-03 23:30:03 - 💰 구매 가능 금액: $541.20
2025-12-03 23:30:04 - 매수 대상 종목 2개를 찾았습니다. (종합 점수 높은 순)
2025-12-03 23:30:05 - 구글 A(GOOGL) 매수 주문 성공: 주문 전송 완료
2025-12-03 23:30:06 - 매수 후 잔고: $225.10
2025-12-03 23:30:07 - 구글 C(GOOG) - 잔고 부족으로 매수 건너뜀
2025-12-03 23:30:08 - ============================================================
2025-12-03 23:30:08 - 자동 매수 처리가 완료되었습니다.
2025-12-03 23:30:08 - 총 매수 대상: 2개
2025-12-03 23:30:08 - 매수 성공: 1개
2025-12-03 23:30:08 - 잔고 부족으로 건너뜀: 1개
2025-12-03 23:30:08 - 남은 잔고: $225.10
2025-12-03 23:30:08 - ============================================================
```

---

## 매도 스케줄러

### ⏰ 실행 시간

**1분마다 자동 실행**

```python
schedule.every(1).minutes.do(self._run_auto_sell)
```

### 🔍 실행 흐름

```
1. 주말 체크 (뉴욕 시간 기준)
   └─ 토요일/일요일이면 종료
   
2. 미국 장 시간 체크
   └─ 평일 9:30 AM - 4:00 PM ET 확인
   └─ 장이 닫혀있으면 종료
   
3. 매도 대상 종목 조회
   └─ get_stocks_to_sell() 함수 호출
   
4. 각 종목에 대해
   ├─ 현재가 조회
   ├─ 매도 주문 실행
   └─ Slack 알림 전송
```

### 📉 매도 조건

| 조건 | 설명 |
|-----|------|
| **익절** | 구매가 대비 +5% 이상 상승 |
| **손절** | 구매가 대비 -7% 이하 하락 |
| **기술적 매도** | 데드 크로스, RSI > 70, MACD 매도 신호 중 3개 이상 |
| **감정 매도** | 감정 점수 < -0.15 + 기술적 매도 신호 2개 이상 |

### 📝 로그 예시

```
2025-12-03 23:31:00 - 자동 매도 작업 시작
2025-12-03 23:31:01 - 보유 종목 정보를 성공적으로 가져왔습니다. 총 3개 종목 보유 중
2025-12-03 23:31:02 - 2개의 매도 대상 종목을 식별했습니다
2025-12-03 23:31:03 - 테슬라(TSLA) 매도 근거: 손절 조건 충족: 구매가 대비 -7.50% 하락
2025-12-03 23:31:04 - 테슬라(TSLA) 매도 주문 성공: 주문이 접수되었습니다.
2025-12-03 23:31:05 - 자동 매도 처리가 완료되었습니다.
```

---

## 경제 데이터 스케줄러

### ⏰ 실행 시간

**한국 시간 기준 매일 새벽 6시 5분**

```python
schedule.every().day.at("06:05").do(_run_economic_data_update)
```

### 🔍 실행 흐름

```
1. 미국 장 시간 체크
   └─ 장이 열려있으면 종료 (장 마감 후에만 수집)
   
2. 마지막 수집 날짜 확인
   └─ MongoDB daily_stock_data에서 최신 날짜 조회 (fallback: Supabase)
   
3. 경제 지표 데이터 수집
   ├─ 금 가격, 달러 인덱스, VIX 지수
   ├─ 아시아 주요 지수 (닛케이, 상해, 항셍)
   └─ 유럽 주요 지수 (FTSE, DAX, CAC 40)
   
4. 미국 주식 데이터 수집
   └─ 활성화된 주식 34개 (yfinance 사용)
   
5. 데이터 저장
   ├─ Supabase: economic_and_stock_data 테이블
   └─ MongoDB: daily_stock_data 컬렉션
      ├─ fred_indicators: FRED 지표
      ├─ yfinance_indicators: Yahoo Finance 지표
      ├─ stocks: 주가 데이터 (open, high, low, close, adjusted_close)
      └─ volumes: 거래량 데이터
   
6. 저장 시간 자동 기록
   └─ created_at, updated_at 자동 설정
   
⚠️ 주의: 분석 작업(기술적 지표 생성, 감정 분석)은 별도 API로 분리됨
```

### 📊 수집 데이터

#### 경제 지표 (11개)
- 금 가격, 달러 인덱스, VIX 지수
- 닛케이 225, 상해종합, 항셍
- 영국 FTSE, 독일 DAX, 프랑스 CAC 40
- 달러/엔, 달러/위안

#### 미국 주식 (34개)
- 빅테크: 애플, 마이크로소프트, 아마존, 구글, 메타, 엔비디아
- 반도체: 인텔, AMD, 브로드컴, TSMC
- 기타 주요 종목

### 🔄 분석 작업 분리

**경제 데이터 업데이트 API (`/economic/update`)는 데이터 수집 및 저장만 담당합니다.**

분석 작업은 별도 API를 통해 실행:
- **기술적 지표 생성**: `POST /stocks/recommended-stocks/generate-technical-recommendations`
- **감정 분석**: `POST /stocks/recommended-stocks/analyze-news-sentiment`
- **통합 분석**: `POST /stocks/recommended-stocks/generate-complete-analysis`

이렇게 분리함으로써:
- 데이터 수집과 분석 작업을 독립적으로 실행 가능
- 각 작업의 실패가 다른 작업에 영향을 주지 않음
- 필요시 분석 작업만 재실행 가능

### 📝 로그 예시

```
2025-12-03 06:05:00 - 경제 데이터 업데이트 작업 시작
2025-12-03 06:05:01 - 경제 지표 및 주가 데이터 업데이트 작업 시작...
2025-12-03 06:05:05 - 데이터 수집 완료
2025-12-03 06:05:10 - 총 5개 날짜 중 5개가 처리되었습니다.
2025-12-03 06:05:10 - 경제 데이터 업데이트 작업 완료
```

---

## 스케줄러 제어 API

### 매수 스케줄러

#### 시작
```bash
POST /stocks/recommendations/purchase/scheduler/start
```

**응답:**
```json
{
  "message": "자동 매수 스케줄러가 시작되었습니다. 매일 밤 12시에 자동 매수가 실행됩니다."
}
```

#### 중지
```bash
POST /stocks/recommendations/purchase/scheduler/stop
```

**응답:**
```json
{
  "message": "자동 매수 스케줄러가 중지되었습니다."
}
```

#### 즉시 실행 (테스트용)
```bash
POST /stocks/recommendations/purchase/trigger
```

**응답:**
```json
{
  "message": "자동 매수 프로세스가 트리거되었습니다. 로그를 확인하세요."
}
```

### 매도 스케줄러

#### 시작
```bash
POST /stocks/recommendations/sell/scheduler/start
```

**응답:**
```json
{
  "message": "자동 매도 스케줄러가 시작되었습니다. 1분마다 매도 대상을 확인합니다."
}
```

#### 중지
```bash
POST /stocks/recommendations/sell/scheduler/stop
```

**응답:**
```json
{
  "message": "자동 매도 스케줄러가 중지되었습니다."
}
```

#### 즉시 실행 (테스트용)
```bash
POST /stocks/recommendations/sell/trigger
```

**응답:**
```json
{
  "message": "자동 매도 프로세스가 트리거되었습니다. 로그를 확인하세요."
}
```

### 스케줄러 상태 확인

```bash
GET /stocks/recommendations/scheduler/status
```

**응답:**
```json
{
  "buy_running": true,
  "sell_running": true,
  "message": "매수 스케줄러: 실행 중, 매도 스케줄러: 실행 중"
}
```

---

## 실행 조건

### 🌍 타임존 관리

모든 시간 체크는 **뉴욕 시간 기준**으로 동작합니다.

```python
now_in_korea = datetime.now(pytz.timezone('Asia/Seoul'))
now_in_ny = datetime.now(pytz.timezone('America/New_York'))  # 서머타임 자동 적용
```

### 📅 주말 체크

```python
ny_weekday = now_in_ny.weekday()  # 0=월요일, 6=일요일

if ny_weekday >= 5:  # 토요일(5) 또는 일요일(6)
    # 매수/매도 작업을 건너뜀
    return
```

### ⏰ 미국 장 시간 체크

**정규 거래 시간**: 평일 9:30 AM - 4:00 PM ET (뉴욕 시간)

```python
is_weekday = 0 <= ny_weekday <= 4  # 월요일~금요일
is_market_open_time = (
    (ny_hour == 9 and ny_minute >= 30) or
    (10 <= ny_hour < 16) or
    (ny_hour == 16 and ny_minute == 0)
)

is_market_hours = is_weekday and is_market_open_time
```

**한국 시간 변환**:
- 정규 시간: 23:30 - 06:00 (다음날)
- 서머타임: 22:30 - 05:00 (다음날)

### 🕐 스케줄러 실행 시간 정리

| 스케줄러 | 한국 시간 | 뉴욕 시간 | 실제 실행 조건 |
|---------|----------|----------|--------------|
| **매수** | 매일 00:00 | 전날 10:00 | 장 시간(9:30-16:00)일 때만 |
| **매도** | 1분마다 | 1분마다 | 장 시간(9:30-16:00)일 때만 |
| **경제 데이터** | 매일 06:05 | 전날 16:05 | 장 마감 후에만 (데이터 수집만) |
| **기술적 지표 분석** | 별도 API | - | `POST /stocks/recommended-stocks/generate-technical-recommendations` |
| **감정 분석** | 별도 API | - | `POST /stocks/recommended-stocks/analyze-news-sentiment` |

**결과적으로**:
- 매수는 한국 시간 **밤 11:30 PM - 새벽 6:00 AM** 사이에 실행됨
- 매도는 같은 시간대에 1분마다 체크
- 경제 데이터는 미국 장 마감 후 자동 수집

---

## 사용 예시

### 🎯 시나리오 1: 전체 자동화 시스템 시작

```bash
# 1. 서버 시작 (모든 스케줄러 자동 시작)
./start.sh

# 2. 스케줄러 상태 확인
curl http://localhost:8000/stocks/recommendations/scheduler/status

# 이제 완전 자동으로 동작합니다!
```

**결과:**
- 매일 밤 12시에 자동 매수
- 1분마다 자동 매도 체크
- 매일 새벽 6시 5분 데이터 업데이트

### 🎯 시나리오 2: 특정 스케줄러만 중지

```bash
# 매도 스케줄러만 중지 (매수는 계속)
curl -X POST http://localhost:8000/stocks/recommendations/sell/scheduler/stop

# 상태 확인
curl http://localhost:8000/stocks/recommendations/scheduler/status
```

**결과:**
```json
{
  "buy_running": true,
  "sell_running": false,
  "message": "매수 스케줄러: 실행 중, 매도 스케줄러: 중지됨"
}
```

### 🎯 시나리오 3: 즉시 매수/매도 테스트

```bash
# 스케줄러를 기다리지 않고 즉시 실행
curl -X POST http://localhost:8000/stocks/recommendations/purchase/trigger
curl -X POST http://localhost:8000/stocks/recommendations/sell/trigger
```

**주의**: 장 시간이 아니면 자동으로 건너뜁니다.

### 🎯 시나리오 4: 수동 제어

```bash
# 1. 모든 스케줄러 중지
curl -X POST http://localhost:8000/stocks/recommendations/purchase/scheduler/stop
curl -X POST http://localhost:8000/stocks/recommendations/sell/scheduler/stop

# 2. 필요할 때만 수동으로 실행
curl -X POST http://localhost:8000/stocks/recommendations/purchase/trigger

# 3. 다시 자동화 시작
curl -X POST http://localhost:8000/stocks/recommendations/purchase/scheduler/start
curl -X POST http://localhost:8000/stocks/recommendations/sell/scheduler/start
```

### 🎯 시나리오 5: Python 스크립트

```python
import requests

BASE_URL = "http://localhost:8000/stocks/recommendations"

# 스케줄러 상태 확인
response = requests.get(f"{BASE_URL}/scheduler/status")
status = response.json()

if status["buy_running"]:
    print("✅ 매수 스케줄러 실행 중")
else:
    print("❌ 매수 스케줄러 중지됨 - 시작합니다")
    requests.post(f"{BASE_URL}/purchase/scheduler/start")

if status["sell_running"]:
    print("✅ 매도 스케줄러 실행 중")
else:
    print("❌ 매도 스케줄러 중지됨 - 시작합니다")
    requests.post(f"{BASE_URL}/sell/scheduler/start")

# 즉시 매수 테스트
print("즉시 매수 실행...")
response = requests.post(f"{BASE_URL}/purchase/trigger")
print(response.json()["message"])
```

---

## 🔧 고급 설정

### 스케줄러 시간 변경

`app/utils/scheduler.py` 파일 수정:

```python
# 현재: 매일 밤 12시
schedule.every().day.at("00:00").do(self._run_auto_buy)

# 변경 예: 매일 새벽 1시
schedule.every().day.at("01:00").do(self._run_auto_buy)

# 변경 예: 2시간마다
schedule.every(2).hours.do(self._run_auto_buy)
```

### 매도 체크 주기 변경

```python
# 현재: 1분마다
schedule.every(1).minutes.do(self._run_auto_sell)

# 변경 예: 5분마다
schedule.every(5).minutes.do(self._run_auto_sell)

# 변경 예: 30초마다
schedule.every(30).seconds.do(self._run_auto_sell)
```

### 경제 데이터 수집 시간 변경

```python
# 현재: 매일 새벽 6시 5분
schedule.every().day.at("06:05").do(_run_economic_data_update)

# 변경 예: 매일 새벽 7시
schedule.every().day.at("07:00").do(_run_economic_data_update)
```

---

## ⚠️ 주의사항

### 1. 스케줄러 중복 실행 방지

스케줄러는 **싱글톤 패턴**으로 구현되어 있습니다:

```python
# 전역 싱글톤 인스턴스
stock_scheduler = StockScheduler()
```

같은 스케줄러를 여러 번 시작해도 **한 번만 실행**됩니다.

### 2. 서버 재시작 시 스케줄러 상태

서버를 재시작하면:
- ✅ 모든 스케줄러가 자동으로 시작됨
- ❌ 이전 상태(중지됨)는 유지되지 않음

**해결책**: 스케줄러를 중지하려면 서버 재시작 후 다시 중지해야 함

### 3. 로그 파일 관리

로그는 `stock_scheduler.log` 파일에 기록됩니다:

```bash
# 최근 로그 확인
tail -f stock_scheduler.log

# 로그 파일 크기 확인
ls -lh stock_scheduler.log

# 오래된 로그 삭제
> stock_scheduler.log  # 로그 파일 비우기
```

### 4. API Rate Limit

한국투자증권 API는 속도 제한이 있습니다:
- 스케줄러가 자동으로 1초씩 대기
- 너무 많은 종목을 한 번에 매수하지 않도록 주의

### 5. 장 시간 외 실행

테스트 목적으로 장 시간 체크를 우회하려면:

```python
# app/utils/scheduler.py의 _execute_auto_buy 함수에서
# 주말 체크와 장 시간 체크를 주석 처리
```

**주의**: 실전 투자 시에는 반드시 장 시간 체크를 활성화하세요!

---

## 📊 스케줄러 아키텍처

### 클래스 구조

```python
class StockScheduler:
    def __init__(self):
        self.recommendation_service = StockRecommendationService()
        self.running = False  # 매수 스케줄러 상태
        self.sell_running = False  # 매도 스케줄러 상태
        self.scheduler_thread = None
    
    def start(self):
        """매수 스케줄러 시작"""
        
    def stop(self):
        """매수 스케줄러 중지"""
        
    def start_sell_scheduler(self):
        """매도 스케줄러 시작"""
        
    def stop_sell_scheduler(self):
        """매도 스케줄러 중지"""
        
    def _run_auto_buy(self):
        """자동 매수 실행 함수 - 스케줄링된 시간에 실행됨"""
        
    def _run_auto_sell(self):
        """자동 매도 실행 함수 - 1분마다 실행됨"""
        
    async def _execute_auto_buy(self):
        """자동 매수 실행 로직"""
        
    async def _execute_auto_sell(self):
        """자동 매도 실행 로직"""
```

### 스레드 관리

```python
# 별도 스레드에서 스케줄러 실행
self.scheduler_thread = threading.Thread(target=self._run_scheduler)
self.scheduler_thread.daemon = True  # 데몬 스레드로 실행
self.scheduler_thread.start()
```

**데몬 스레드**:
- 메인 프로그램이 종료되면 자동으로 종료
- 서버 중지 시 스케줄러도 자동 종료

---

## 🧪 테스트 및 디버깅

### 로그 레벨 변경

```python
# app/utils/scheduler.py
logging.basicConfig(
    level=logging.DEBUG,  # INFO → DEBUG로 변경
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.StreamHandler(),
        logging.FileHandler('stock_scheduler.log')
    ]
)
```

### 스케줄러 실행 여부 확인

```bash
# 프로세스 확인
ps aux | grep python

# 로그 실시간 모니터링
tail -f stock_scheduler.log

# Docker 로그 확인
docker compose logs -f stock-trading-api
```

### 수동 테스트

```python
from app.utils.scheduler import stock_scheduler

# 매수 로직만 테스트
stock_scheduler._run_auto_buy()

# 매도 로직만 테스트
stock_scheduler._run_auto_sell()
```

---

## 📞 문의 및 지원

스케줄러 관련 문의사항이나 개선 제안이 있으시면 이슈를 등록해주세요.

**관련 문서:**
- [매수_동작_가이드.md](./매수_동작_가이드.md) - 매수 시스템 전체 가이드
- [README.md](./README.md) - 프로젝트 개요

---

**이제 주식 자동 매매 시스템이 완전히 자동화되었습니다!** 🚀

매일 정해진 시간에 알아서 매수/매도하고, 데이터를 업데이트하며, Slack으로 알림을 보냅니다.

---

## 🔄 최근 변경사항 (2025-12-12)

### MongoDB 저장 시간 자동 기록
- 모든 MongoDB 저장 작업에 `created_at`, `updated_at` 자동 저장
- Upsert 시 `$setOnInsert`를 사용하여 새 문서 생성 시에만 `created_at` 설정

### 분석 로직 분리
- 경제 데이터 업데이트 API (`/economic/update`)는 데이터 수집 및 저장만 담당
- 기술적 지표 생성, 감정 분석은 별도 API로 분리
- 각 분석 작업을 독립적으로 실행 가능

### 데이터 소스 변경
- 마지막 수집 날짜는 MongoDB `daily_stock_data`에서 조회 (Supabase fallback)
- 종목 정보는 MongoDB `stocks` 컬렉션에서 조회

---

**마지막 업데이트**: 2025-12-12

