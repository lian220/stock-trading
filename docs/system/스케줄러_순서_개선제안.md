# ğŸ”„ ìŠ¤ì¼€ì¤„ëŸ¬ ì‹¤í–‰ ìˆœì„œ ê°œì„  ì œì•ˆ

## â“ í˜„ì¬ ë¬¸ì œì 

### ì‚¬ìš©ì ì§ˆë¬¸
> "ì£¼ê°€ ì˜ˆì¸¡ì„ ì™œ ë¨¼ì €í•˜ëŠ”ê±°ì•¼?  
> ë¶„ì„ ì‘ì—…í• ë•Œ ë‰´ìŠ¤ ê°ì •ë¶„ì„ì´ë‘ ê¸°ìˆ ì§€í‘œ ë¶„ì„ìœ¼ë¡œ ë¶„ì„í•˜ëŠ”ê²Œ ì•„ë‹Œê°€??"

### í˜„ì¬ ì‹¤í–‰ ìˆœì„œ
```
23:00 - Vertex AI ì˜ˆì¸¡ (ì£¼ê°€ ì˜ˆì¸¡)
23:45 - ë¶„ì„ ì‘ì—… (ê¸°ìˆ ì  ì§€í‘œ + ê°ì • ë¶„ì„)
00:00 - ë§¤ìˆ˜ ì‹¤í–‰
```

### ë°œê²¬ëœ ë¬¸ì œ

#### 1. ë¶ˆí•„ìš”í•œ ì˜ì¡´ì„±

**í˜„ì¬ ì½”ë“œ êµ¬ì¡°:**

```python
# fetch_and_store_sentiment_for_recommendations() í•¨ìˆ˜ (280ì¤„)
def fetch_and_store_sentiment_for_recommendations(self):
    # âŒ ë¬¸ì œ: AI ì˜ˆì¸¡ ê²°ê³¼ë¥¼ ë¨¼ì € ê°€ì ¸ì˜´
    stock_recs = self.get_stock_recommendations()  # stock_analysis_results í…Œì´ë¸” ì¡°íšŒ
    recommendations = stock_recs.get("recommendations", [])
    
    # AI ì˜ˆì¸¡ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ê°ì • ë¶„ì„í•  í‹°ì»¤ ëª©ë¡ ìƒì„±
    recommended_tickers = [STOCK_TO_TICKER.get(rec["Stock"]) for rec in recommendations]
```

**ë¬¸ì œì :**
- ê°ì • ë¶„ì„ì€ **ë‰´ìŠ¤ ë°ì´í„°ë§Œ ìˆìœ¼ë©´ ê°€ëŠ¥**í•œë°, AI ì˜ˆì¸¡ ê²°ê³¼ì— ì˜ì¡´í•˜ê³  ìˆìŒ
- AI ì˜ˆì¸¡ì´ ì‹¤íŒ¨í•˜ê±°ë‚˜ ì—†ìœ¼ë©´ ê°ì • ë¶„ì„ë„ ì œëŒ€ë¡œ ì•ˆ ë¨
- ë…¼ë¦¬ì ìœ¼ë¡œ ê°ì • ë¶„ì„ì€ ë…ë¦½ì ìœ¼ë¡œ ì‹¤í–‰ ê°€ëŠ¥í•´ì•¼ í•¨

#### 2. ë°ì´í„° ë…ë¦½ì„± ë¶„ì„

| ì‘ì—… | í•„ìš”í•œ ë°ì´í„° | ë…ë¦½ ì‹¤í–‰ ê°€ëŠ¥? | í˜„ì¬ ì˜ì¡´ì„± |
|-----|------------|------------|----------|
| **ê¸°ìˆ ì  ì§€í‘œ ë¶„ì„** | ê³¼ê±° ì£¼ê°€ ë°ì´í„° (economic_and_stock_data) | âœ… ì˜ˆ | ë…ë¦½ì  |
| **ê°ì • ë¶„ì„** | ë‰´ìŠ¤ ë°ì´í„° (Alpha Vantage API) | âœ… ì˜ˆ | âŒ AI ì˜ˆì¸¡ ê²°ê³¼ ì˜ì¡´ |
| **AI ì£¼ê°€ ì˜ˆì¸¡** | ê³¼ê±° ì£¼ê°€ ë°ì´í„° (economic_and_stock_data) | âœ… ì˜ˆ | ë…ë¦½ì  |
| **í†µí•© ë¶„ì„** | ìœ„ 3ê°€ì§€ ê²°ê³¼ ëª¨ë‘ | âŒ ì•„ë‹ˆì˜¤ | ëª¨ë“  ê²°ê³¼ í•„ìš” |

**ê²°ë¡ :** ê¸°ìˆ ì  ì§€í‘œ, ê°ì • ë¶„ì„, AI ì˜ˆì¸¡ì€ ëª¨ë‘ **ë…ë¦½ì ìœ¼ë¡œ ì‹¤í–‰ ê°€ëŠ¥**í•˜ì§€ë§Œ, í˜„ì¬ ì½”ë“œëŠ” ë¶ˆí•„ìš”í•œ ì˜ì¡´ì„±ì„ ë§Œë“¤ê³  ìˆìŒ.

---

## ğŸ’¡ ê°œì„  ì œì•ˆ

### ì˜µì…˜ 1: ë³‘ë ¬ ì‹¤í–‰ (ê¶Œì¥) â­

**ê°œì„ ëœ ìˆœì„œ:**
```
23:00 - ë³‘ë ¬ ì‹¤í–‰ ì‹œì‘ âš ï¸ ì¤‘ìš”: ì§€í‘œ ë°œí‘œ ë“±ì„ ê³ ë ¤í•˜ì—¬ 23:45ë³´ë‹¤ ì¼ì° ì‹¤í–‰
  â”œâ”€ Vertex AI ì˜ˆì¸¡ (ë…ë¦½ì , ~2ì‹œê°„ ì†Œìš”)
  â”œâ”€ ê¸°ìˆ ì  ì§€í‘œ ë¶„ì„ (ë…ë¦½ì , ~5ë¶„)
  â””â”€ ê°ì • ë¶„ì„ (ë…ë¦½ì , ~20ë¶„)
     â†“
23:45 - í†µí•© ë¶„ì„ (ìœ„ 3ê°€ì§€ ê²°ê³¼ í†µí•©)
     â†“
00:00 - ë§¤ìˆ˜ ì‹¤í–‰
```

**ì¥ì :**
- **23:00 ì‹¤í–‰ ì´ìœ **: ë¯¸êµ­ ì‹œì¥ ì§€í‘œ ë°œí‘œ ì‹œê°„ëŒ€ë¥¼ ê³ ë ¤í•˜ì—¬ ì¶©ë¶„í•œ ë¶„ì„ ì‹œê°„ í™•ë³´
- ì‹¤í–‰ ì‹œê°„ ë‹¨ì¶• (ë³‘ë ¬ ì²˜ë¦¬)
- ê° ì‘ì—…ì´ ë…ë¦½ì ìœ¼ë¡œ ì‹¤í–‰ë˜ì–´ ì‹¤íŒ¨ ì‹œ ë‹¤ë¥¸ ì‘ì—…ì— ì˜í–¥ ì—†ìŒ
- ë…¼ë¦¬ì ìœ¼ë¡œ ë” ëª…í™•í•¨
- Vertex AI ì˜ˆì¸¡ì´ 2ì‹œê°„ ì†Œìš”ë˜ì–´ë„ 23:45 í†µí•© ë¶„ì„ ì „ì— ì™„ë£Œ ê°€ëŠ¥

**êµ¬í˜„ ë°©ë²•:**
```python
def _run_analysis(self, send_slack_notification: bool = True):
    """í†µí•© ë¶„ì„ ì‹¤í–‰ (ë³‘ë ¬ ì²˜ë¦¬)"""
    
    # ë³‘ë ¬ ì‹¤í–‰
    import concurrent.futures
    
    with concurrent.futures.ThreadPoolExecutor(max_workers=3) as executor:
        # 1. ê¸°ìˆ ì  ì§€í‘œ ë¶„ì„
        tech_future = executor.submit(
            self.recommendation_service.generate_technical_recommendations,
            send_slack_notification=False
        )
        
        # 2. ê°ì • ë¶„ì„ (ë…ë¦½ì ìœ¼ë¡œ ì‹¤í–‰)
        sentiment_future = executor.submit(
            self.recommendation_service.fetch_and_store_sentiment_independent,
            send_slack_notification=False
        )
        
        # 3. Vertex AI ì˜ˆì¸¡ì€ ì´ë¯¸ 23:00ì— ì‹¤í–‰ë˜ì—ˆìœ¼ë¯€ë¡œ ê²°ê³¼ë§Œ í™•ì¸
    
    # ê²°ê³¼ ëŒ€ê¸°
    tech_result = tech_future.result()
    sentiment_result = sentiment_future.result()
    
    # í†µí•© ë¶„ì„
    combined_result = self.recommendation_service.get_combined_recommendations_with_technical_and_sentiment(
        send_slack_notification=send_slack_notification
    )
```

### ì˜µì…˜ 2: ìˆœì°¨ ì‹¤í–‰ (í˜„ì¬ êµ¬ì¡° ìœ ì§€, ì˜ì¡´ì„± ì œê±°)

**ê°œì„ ëœ ìˆœì„œ:**
```
23:00 - ê¸°ìˆ ì  ì§€í‘œ ë¶„ì„ (ë…ë¦½ì )
23:15 - ê°ì • ë¶„ì„ (ë…ë¦½ì , AI ì˜ˆì¸¡ ê²°ê³¼ ë¶ˆí•„ìš”)
23:30 - Vertex AI ì˜ˆì¸¡ (ë…ë¦½ì )
23:45 - í†µí•© ë¶„ì„ (ìœ„ 3ê°€ì§€ ê²°ê³¼ í†µí•©)
00:00 - ë§¤ìˆ˜ ì‹¤í–‰
```

**ì¥ì :**
- í˜„ì¬ êµ¬ì¡°ì™€ ìœ ì‚¬í•˜ì—¬ ë³€ê²½ ìµœì†Œí™”
- ê° ì‘ì—…ì´ ë…ë¦½ì ìœ¼ë¡œ ì‹¤í–‰

**êµ¬í˜„ ë°©ë²•:**
```python
# fetch_and_store_sentiment_for_recommendations() í•¨ìˆ˜ ìˆ˜ì •
def fetch_and_store_sentiment_independent(self):
    """
    AI ì˜ˆì¸¡ ê²°ê³¼ì— ì˜ì¡´í•˜ì§€ ì•Šê³  ë…ë¦½ì ìœ¼ë¡œ ê°ì • ë¶„ì„ ìˆ˜í–‰
    """
    # í™œì„±í™”ëœ ëª¨ë“  ì£¼ì‹ì— ëŒ€í•´ ê°ì • ë¶„ì„
    # ë˜ëŠ” ë³´ìœ  ì£¼ì‹ + í™œì„±í™”ëœ ì£¼ì‹ ëª©ë¡ ì‚¬ìš©
    from app.db.mongodb import get_db
    db = get_db()
    active_stocks = db.stocks.find({"is_active": True})
    
    all_tickers = [stock["ticker"] for stock in active_stocks]
    
    # ë³´ìœ  ì£¼ì‹ë„ ì¶”ê°€
    balance_result = get_overseas_balance()
    if balance_result.get("rt_cd") == "0":
        holdings = balance_result.get("output1", [])
        holding_tickers = [item.get("ovrs_pdno") for item in holdings]
        all_tickers = list(set(all_tickers + holding_tickers))
    
    # ë‚˜ë¨¸ì§€ ê°ì • ë¶„ì„ ë¡œì§...
```

### ì˜µì…˜ 3: í•˜ì´ë¸Œë¦¬ë“œ (ê¶Œì¥) â­â­

**ê°œì„ ëœ ìˆœì„œ:**
```
âš ï¸ ì¤‘ìš”: 23:00ëŒ€ ì‹¤í–‰ì€ ë¯¸êµ­ ì‹œì¥ ì§€í‘œ ë°œí‘œ ì‹œê°„ëŒ€ë¥¼ ê³ ë ¤í•œ ì„¤ê³„

23:00 - ê¸°ìˆ ì  ì§€í‘œ ë¶„ì„ (ë…ë¦½ì , ~5ë¶„)
23:05 - ê°ì • ë¶„ì„ (ë…ë¦½ì , ~20ë¶„)
23:30 - Vertex AI ì˜ˆì¸¡ (ë…ë¦½ì , ~2ì‹œê°„ ì†Œìš”)
23:45 - í†µí•© ë¶„ì„ (ìœ„ 3ê°€ì§€ ê²°ê³¼ í†µí•©, ~5ë¶„)
00:00 - ë§¤ìˆ˜ ì‹¤í–‰
```

**ì¥ì :**
- **23:00ëŒ€ ì‹¤í–‰**: ì§€í‘œ ë°œí‘œ ë“±ì„ ê³ ë ¤í•˜ì—¬ ì¶©ë¶„í•œ ë¶„ì„ ì‹œê°„ í™•ë³´
- ë¹ ë¥¸ ì‘ì—…ë¶€í„° ì‹¤í–‰í•˜ì—¬ ì‹œê°„ íš¨ìœ¨ì 
- ëŠë¦° ì‘ì—…(AI ì˜ˆì¸¡)ì€ ë³„ë„ë¡œ ì‹¤í–‰í•˜ì—¬ íƒ€ì„ì•„ì›ƒ ê´€ë¦¬ ìš©ì´
- ê° ì‘ì—…ì´ ë…ë¦½ì 
- Vertex AI ì˜ˆì¸¡ì´ 23:30ì— ì‹œì‘í•˜ì—¬ 01:30ê¹Œì§€ ì™„ë£Œ (00:00 ë§¤ìˆ˜ í›„ì—ë„ ê³„ì† ì‹¤í–‰)

---

## ğŸ”§ êµ¬ì²´ì  ì½”ë“œ ìˆ˜ì • ì‚¬í•­

### 1. ê°ì • ë¶„ì„ í•¨ìˆ˜ ìˆ˜ì •

**í˜„ì¬ ì½”ë“œ (ë¬¸ì œ):**
```python
def fetch_and_store_sentiment_for_recommendations(self):
    # âŒ AI ì˜ˆì¸¡ ê²°ê³¼ì— ì˜ì¡´
    stock_recs = self.get_stock_recommendations()
    recommendations = stock_recs.get("recommendations", [])
    recommended_tickers = [STOCK_TO_TICKER.get(rec["Stock"]) for rec in recommendations]
```

**ê°œì„ ëœ ì½”ë“œ:**
```python
def fetch_and_store_sentiment_independent(self):
    """
    AI ì˜ˆì¸¡ ê²°ê³¼ì— ì˜ì¡´í•˜ì§€ ì•Šê³  ë…ë¦½ì ìœ¼ë¡œ ê°ì • ë¶„ì„ ìˆ˜í–‰
    """
    # í™œì„±í™”ëœ ëª¨ë“  ì£¼ì‹ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    all_tickers = []
    
    # 1. í™œì„±í™”ëœ ì£¼ì‹ ëª©ë¡ (stock_ticker_mapping ë˜ëŠ” stocks ì»¬ë ‰ì…˜)
    for stock_name in self.stock_columns:  # ì´ë¯¸ í™œì„±í™”ëœ ì£¼ì‹ ëª©ë¡
        ticker = STOCK_TO_TICKER.get(stock_name)
        if ticker:
            all_tickers.append(ticker)
    
    # 2. ë³´ìœ  ì£¼ì‹ ì¶”ê°€
    balance_result = get_overseas_balance()
    if balance_result.get("rt_cd") == "0" and "output1" in balance_result:
        holdings = balance_result.get("output1", [])
        holding_tickers = [item.get("ovrs_pdno") for item in holdings if item.get("ovrs_pdno")]
        all_tickers = list(set(all_tickers + holding_tickers))
    
    if not all_tickers:
        return {"message": "ë¶„ì„í•  í‹°ì»¤ê°€ ì—†ìŠµë‹ˆë‹¤", "results": []}
    
    # ë‚˜ë¨¸ì§€ ê°ì • ë¶„ì„ ë¡œì§ì€ ë™ì¼...
```

### 2. ìŠ¤ì¼€ì¤„ëŸ¬ ìˆœì„œ ìˆ˜ì •

**í˜„ì¬:**
```python
schedule.every().day.at("23:00").do(self._run_vertex_ai_prediction)
schedule.every().day.at("23:45").do(self._run_analysis)
```

**ê°œì„ ì•ˆ (ì˜µì…˜ 3):**
```python
# ê¸°ìˆ ì  ì§€í‘œ ë¶„ì„ (ë¹ ë¦„, ë…ë¦½ì )
schedule.every().day.at("23:00").do(self._run_technical_analysis)

# ê°ì • ë¶„ì„ (ì¤‘ê°„, ë…ë¦½ì )
schedule.every().day.at("23:05").do(self._run_sentiment_analysis)

# Vertex AI ì˜ˆì¸¡ (ëŠë¦¼, ë…ë¦½ì )
schedule.every().day.at("23:30").do(self._run_vertex_ai_prediction)

# í†µí•© ë¶„ì„ (ìœ„ 3ê°€ì§€ ê²°ê³¼ í†µí•©)
schedule.every().day.at("23:45").do(self._run_combined_analysis)
```

---

## ğŸ“Š ë¹„êµ ë¶„ì„

### í˜„ì¬ êµ¬ì¡° vs ê°œì„ ì•ˆ

| í•­ëª© | í˜„ì¬ | ì˜µì…˜ 1 (ë³‘ë ¬) | ì˜µì…˜ 2 (ìˆœì°¨) | ì˜µì…˜ 3 (í•˜ì´ë¸Œë¦¬ë“œ) |
|-----|------|------------|------------|----------------|
| **ì‹¤í–‰ ì‹œê°„** | ~2ì‹œê°„ | ~2ì‹œê°„ (ë³‘ë ¬) | ~2ì‹œê°„ 15ë¶„ | ~2ì‹œê°„ |
| **ë…ë¦½ì„±** | âŒ ì˜ì¡´ì„± ìˆìŒ | âœ… ì™„ì „ ë…ë¦½ | âœ… ì™„ì „ ë…ë¦½ | âœ… ì™„ì „ ë…ë¦½ |
| **ì‹¤íŒ¨ ì˜í–¥** | ë†’ìŒ | ë‚®ìŒ | ë‚®ìŒ | ë‚®ìŒ |
| **êµ¬í˜„ ë³µì¡ë„** | ë‚®ìŒ | ì¤‘ê°„ | ë‚®ìŒ | ë‚®ìŒ |
| **ë…¼ë¦¬ì  ëª…í™•ì„±** | ë‚®ìŒ | ë†’ìŒ | ë†’ìŒ | ë†’ìŒ |

---

## ğŸ¯ ìµœì¢… ê¶Œì¥ì•ˆ

### ì˜µì…˜ 3 (í•˜ì´ë¸Œë¦¬ë“œ) ì¶”ì²œ â­â­â­

**ì´ìœ :**
1. ê° ì‘ì—…ì´ ì™„ì „íˆ ë…ë¦½ì ìœ¼ë¡œ ì‹¤í–‰
2. ë¹ ë¥¸ ì‘ì—…ë¶€í„° ì‹¤í–‰í•˜ì—¬ ì‹œê°„ íš¨ìœ¨ì 
3. ëŠë¦° ì‘ì—…(AI ì˜ˆì¸¡)ì€ ë³„ë„ë¡œ ì‹¤í–‰í•˜ì—¬ íƒ€ì„ì•„ì›ƒ ê´€ë¦¬ ìš©ì´
4. êµ¬í˜„ ë³µì¡ë„ê°€ ë‚®ìŒ
5. ë…¼ë¦¬ì ìœ¼ë¡œ ëª…í™•í•¨
6. **23:00ëŒ€ ì‹¤í–‰**: ë¯¸êµ­ ì‹œì¥ ì§€í‘œ ë°œí‘œ ì‹œê°„ëŒ€ë¥¼ ê³ ë ¤í•œ ì„¤ê³„

**ì‹¤í–‰ ìˆœì„œ:**
```
06:05 - ê²½ì œ ë°ì´í„° ìˆ˜ì§‘

âš ï¸ ì¤‘ìš”: 23:00ëŒ€ ì‹¤í–‰ì€ ì§€í‘œ ë°œí‘œ ë“±ì„ ê³ ë ¤í•˜ì—¬ ì¶©ë¶„í•œ ë¶„ì„ ì‹œê°„ í™•ë³´

23:00 - ê¸°ìˆ ì  ì§€í‘œ ë¶„ì„ (ë…ë¦½ì , ~5ë¶„)
23:05 - ê°ì • ë¶„ì„ (ë…ë¦½ì , ~20ë¶„)
23:30 - Vertex AI ì˜ˆì¸¡ (ë…ë¦½ì , ~2ì‹œê°„)
23:45 - í†µí•© ë¶„ì„ (ìœ„ 3ê°€ì§€ ê²°ê³¼ í†µí•©, ~5ë¶„)
00:00 - ë§¤ìˆ˜ ì‹¤í–‰
```

---

## ğŸ“ êµ¬í˜„ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] `fetch_and_store_sentiment_for_recommendations()` í•¨ìˆ˜ë¥¼ `fetch_and_store_sentiment_independent()`ë¡œ ìˆ˜ì •
- [ ] ê°ì • ë¶„ì„ì´ AI ì˜ˆì¸¡ ê²°ê³¼ì— ì˜ì¡´í•˜ì§€ ì•Šë„ë¡ ìˆ˜ì •
- [ ] ìŠ¤ì¼€ì¤„ëŸ¬ ìˆœì„œ ì¡°ì • (ì˜µì…˜ 3 ê¸°ì¤€)
- [ ] `_run_analysis()` í•¨ìˆ˜ë¥¼ `_run_combined_analysis()`ë¡œ ë³€ê²½
- [ ] ê° ë¶„ì„ ì‘ì—…ì„ ë…ë¦½ì ì¸ í•¨ìˆ˜ë¡œ ë¶„ë¦¬
- [ ] í…ŒìŠ¤íŠ¸ ë° ê²€ì¦

---

**ì‘ì„±ì¼:** 2025-01-XX  
**ìƒíƒœ:** ê°œì„  ì œì•ˆ ì™„ë£Œ, êµ¬í˜„ ëŒ€ê¸°




