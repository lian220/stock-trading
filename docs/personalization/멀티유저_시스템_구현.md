# ë©€í‹° ìœ ì € ì‹œìŠ¤í…œ êµ¬í˜„ ê°€ì´ë“œ

## ğŸ“‹ ê°œìš”

í•œêµ­íˆ¬ìì¦ê¶Œ API ê¸°ë°˜ ë¯¸êµ­ ì£¼ì‹ ìë™ë§¤ë§¤ ì‹œìŠ¤í…œì˜ ë©€í‹° ìœ ì € ì§€ì› êµ¬í˜„ ê°€ì´ë“œì…ë‹ˆë‹¤.

## ğŸ¯ í•µì‹¬ ê°œë…

### ì‚¬ìš©ì ì»¨í…ìŠ¤íŠ¸ ê´€ë¦¬

ì‹œìŠ¤í…œì€ **ì‚¬ìš©ì ì»¨í…ìŠ¤íŠ¸(User Context)**ë¥¼ í†µí•´ í˜„ì¬ ì‘ì—… ì¤‘ì¸ ì‚¬ìš©ìë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.

```python
# app/utils/user_context.py

# ê¸°ë³¸ ì‚¬ìš©ì ID (Fallback)
def get_default_user_id() -> str:
    """í™˜ê²½ë³€ìˆ˜ DEFAULT_USER_ID ë˜ëŠ” 'lian' ë°˜í™˜"""

# í˜„ì¬ ì‚¬ìš©ì ID
def get_current_user_id() -> str:
    """ì „ì—­ ì»¨í…ìŠ¤íŠ¸ ë˜ëŠ” ê¸°ë³¸ê°’ ë°˜í™˜"""

# ì „ì—­ ì»¨í…ìŠ¤íŠ¸ ì„¤ì •
def set_global_user_context(user_id: str):
    """ìŠ¤ì¼€ì¤„ëŸ¬ë‚˜ API ìš”ì²­ì—ì„œ ì‚¬ìš©ì ì„¤ì •"""

# í™œì„± ì‚¬ìš©ì ëª©ë¡ ì¡°íšŒ
def get_active_users() -> List[str]:
    """ìë™ë§¤ë§¤ í™œì„±í™”ëœ ì‚¬ìš©ì ëª©ë¡ ì¡°íšŒ"""
```

### user_id ê²°ì • ìš°ì„ ìˆœìœ„

1. **ì „ì—­ ì‚¬ìš©ì ì»¨í…ìŠ¤íŠ¸** (ê°€ì¥ ë†’ìŒ)
   - `_global_user_context.user_id`
   - API ìš”ì²­ ì‹œ ë¯¸ë“¤ì›¨ì–´ì—ì„œ ì„¤ì •
   - ìŠ¤ì¼€ì¤„ëŸ¬ì—ì„œ `set_global_user_context()` í˜¸ì¶œ

2. **ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°**
   - `?user_id=lian`

3. **í—¤ë”**
   - `X-User-ID: lian`

4. **JWT í† í°** (í–¥í›„ êµ¬í˜„)
   - `Authorization: Bearer token`

5. **ê¸°ë³¸ ì‚¬ìš©ì ID** (Fallback)
   - `get_default_user_id()`
   - í™˜ê²½ë³€ìˆ˜ `DEFAULT_USER_ID` ë˜ëŠ” `"lian"`

## ğŸ—ï¸ ì•„í‚¤í…ì²˜

### ìŠ¤ì¼€ì¤„ëŸ¬ ë©€í‹° ìœ ì € ì§€ì›

#### ê°œì„  ì „ (ë‹¨ì¼ ì‚¬ìš©ì)

```python
async def _execute_auto_buy(self):
    user_id = get_current_user_id()  # â†’ "lian" (ê¸°ë³¸ê°’)
    trading_config = self.auto_trading_service.get_auto_trading_config(user_id=user_id)
    # ë§¤ìˆ˜ ì‹¤í–‰...
```

**ë¬¸ì œì **:
- âŒ ë‹¨ì¼ ì‚¬ìš©ìë§Œ ì²˜ë¦¬ (`DEFAULT_USER_ID`)
- âŒ ì—¬ëŸ¬ ì‚¬ìš©ìê°€ ìˆì–´ë„ í•œ ëª…ë§Œ ì²˜ë¦¬
- âŒ ê° ì‚¬ìš©ìë³„ ì„¤ì •ì„ ë¬´ì‹œ

#### ê°œì„  í›„ (ë©€í‹° ìœ ì €)

```python
async def _execute_auto_buy(self, send_slack_notification: bool = True):
    """ëª¨ë“  í™œì„± ì‚¬ìš©ì ëŒ€ìƒ"""
    active_users = get_active_users()  # MongoDBì—ì„œ ì¡°íšŒ
    
    for user_id in active_users:
        await self._execute_auto_buy_for_user(user_id, send_slack_notification)

async def _execute_auto_buy_for_user(self, user_id: str, send_slack_notification: bool = True):
    """íŠ¹ì • ì‚¬ìš©ìì— ëŒ€í•œ ìë™ ë§¤ìˆ˜ ì‹¤í–‰"""
    # ì‚¬ìš©ìë³„ ì»¨í…ìŠ¤íŠ¸ ì„¤ì •
    set_global_user_context(user_id)
    
    # ì‚¬ìš©ìë³„ ì„¤ì • ì¡°íšŒ
    trading_config = self.auto_trading_service.get_auto_trading_config(user_id=user_id)
    
    # ìë™ë§¤ë§¤ê°€ ë¹„í™œì„±í™”ëœ ì‚¬ìš©ìëŠ” ê±´ë„ˆëœ€
    if not trading_config.get("auto_trading_enabled", False):
        return
    
    # ì‚¬ìš©ìë³„ ë§¤ìˆ˜ ë¡œì§ ì‹¤í–‰
    # ...
```

**ê°œì„  ì‚¬í•­**:
- âœ… í™œì„± ì‚¬ìš©ì ëª©ë¡ ì¡°íšŒ
- âœ… ê° ì‚¬ìš©ìë³„ë¡œ ì‘ì—… ì‹¤í–‰
- âœ… ì‚¬ìš©ìë³„ ì»¨í…ìŠ¤íŠ¸ ì„¤ì •
- âœ… ì‚¬ìš©ìë³„ ì„¤ì • ì¡°íšŒ ë° ì ìš©

### ì‹¤í–‰ íë¦„

```
ìŠ¤ì¼€ì¤„ëŸ¬ ì‹œì‘
  â†’ í™œì„± ì‚¬ìš©ì ëª©ë¡ ì¡°íšŒ: ["lian", "user2", "user3"]
  
  â†’ lian ì²˜ë¦¬:
     - set_global_user_context("lian")
     - lianì˜ ì„¤ì • ì¡°íšŒ
     - lianì˜ ë§¤ìˆ˜/ë§¤ë„ ì‹¤í–‰
  
  â†’ user2 ì²˜ë¦¬:
     - set_global_user_context("user2")
     - user2ì˜ ì„¤ì • ì¡°íšŒ
     - user2ì˜ ë§¤ìˆ˜/ë§¤ë„ ì‹¤í–‰
  
  â†’ user3 ì²˜ë¦¬:
     - set_global_user_context("user3")
     - user3ì˜ ì„¤ì • ì¡°íšŒ
     - user3ì˜ ë§¤ìˆ˜/ë§¤ë„ ì‹¤í–‰
```

## ğŸ“ ì£¼ìš” êµ¬í˜„ ìœ„ì¹˜

### 1. ì‚¬ìš©ì ì»¨í…ìŠ¤íŠ¸ ê´€ë¦¬

**íŒŒì¼**: `app/utils/user_context.py`

- `get_default_user_id()`: ê¸°ë³¸ ì‚¬ìš©ì ID ë°˜í™˜ (í™˜ê²½ë³€ìˆ˜ ë˜ëŠ” "lian")
- `get_current_user_id()`: í˜„ì¬ ì‚¬ìš©ì ID ë°˜í™˜ (ì „ì—­ ì»¨í…ìŠ¤íŠ¸ ë˜ëŠ” ê¸°ë³¸ê°’)
- `set_global_user_context(user_id)`: ì „ì—­ ì‚¬ìš©ì ì»¨í…ìŠ¤íŠ¸ ì„¤ì •
- `get_active_users()`: ìë™ë§¤ë§¤ í™œì„±í™”ëœ ì‚¬ìš©ì ëª©ë¡ ì¡°íšŒ

### 2. ìŠ¤ì¼€ì¤„ëŸ¬ ë©€í‹° ìœ ì € ì§€ì›

**íŒŒì¼**: `app/utils/scheduler.py`

- `_execute_auto_buy()`: ëª¨ë“  í™œì„± ì‚¬ìš©ì ëŒ€ìƒ ë§¤ìˆ˜ ì‘ì—…
- `_execute_auto_buy_for_user(user_id)`: íŠ¹ì • ì‚¬ìš©ì ë§¤ìˆ˜ ì‘ì—…
- `_execute_auto_sell()`: ëª¨ë“  í™œì„± ì‚¬ìš©ì ëŒ€ìƒ ë§¤ë„ ì‘ì—…
- `_execute_auto_sell_for_user(user_id)`: íŠ¹ì • ì‚¬ìš©ì ë§¤ë„ ì‘ì—…

### 3. ì¸ì¦ ë¯¸ë“¤ì›¨ì–´

**íŒŒì¼**: `app/middleware/auth_middleware.py`

- ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ì—ì„œ `user_id` ì¶”ì¶œ
- í—¤ë”(`X-User-ID`)ì—ì„œ `user_id` ì¶”ì¶œ
- ê¸°ë³¸ ì‚¬ìš©ì ID ìë™ ì„¤ì •
- í–¥í›„ JWT í† í° ê²€ì¦ ì§€ì› (êµ¬í˜„ ì˜ˆì •)

### 4. ê¶Œí•œ ê²€ì¦

**íŒŒì¼**: `app/utils/auth.py`

- `verify_user_access(user_id)`: ì‚¬ìš©ì ì ‘ê·¼ ê¶Œí•œ ê²€ì¦
- `require_user_exists(user_id)`: ì‚¬ìš©ì ì¡´ì¬ ì—¬ë¶€ í™•ì¸
- `verify_data_ownership(user_id, resource)`: ë¦¬ì†ŒìŠ¤ ì†Œìœ ê¶Œ í™•ì¸

## ğŸ” ì¸ì¦ ë° ë³´ì•ˆ

### JWT ì ìš© ë²”ìœ„

| êµ¬ë¶„ | JWT í† í° | ì¸ì¦ ë°©ì‹ |
|------|---------|----------|
| **API ì—”ë“œí¬ì¸íŠ¸** | âœ… í•„ìš” (í–¥í›„) | JWT í† í°ì—ì„œ user_id ì¶”ì¶œ |
| **ìŠ¤ì¼€ì¤„ëŸ¬** | âŒ ë¶ˆí•„ìš” | í™˜ê²½ë³€ìˆ˜ `DEFAULT_USER_ID` ë˜ëŠ” í™œì„± ì‚¬ìš©ì ëª©ë¡ |

### API ìš”ì²­ íë¦„ (í–¥í›„ JWT êµ¬í˜„)

```
1. í´ë¼ì´ì–¸íŠ¸ ìš”ì²­
   GET /users/lian
   Authorization: Bearer eyJhbGci...

2. AuthMiddleware
   - JWT í† í° ì¶”ì¶œ
   - í† í° ê²€ì¦
   - user_id ì¶”ì¶œ (ì˜ˆ: "lian")
   - set_global_user_context("lian")

3. API ì—”ë“œí¬ì¸íŠ¸
   - get_current_user_id() â†’ "lian"
   - verify_user_access("lian") â†’ í†µê³¼
   - ì‚¬ìš©ì ë°ì´í„° ë°˜í™˜
```

### ìŠ¤ì¼€ì¤„ëŸ¬ ì‹¤í–‰ íë¦„

```
1. ì„œë²„ ì‹œì‘ ì‹œ
   - í™œì„± ì‚¬ìš©ì ëª©ë¡ ì¡°íšŒ
   - ê° ì‚¬ìš©ìë³„ë¡œ ìŠ¤ì¼€ì¤„ëŸ¬ ì‘ì—… ì‹¤í–‰

2. ìŠ¤ì¼€ì¤„ëŸ¬ ì‹œì‘
   - schedule.every().day.at("23:50").do(_execute_auto_buy)
   - ë°±ê·¸ë¼ìš´ë“œ ìŠ¤ë ˆë“œì—ì„œ ì‹¤í–‰

3. ìŠ¤ì¼€ì¤„ëŸ¬ ì‘ì—… ì‹¤í–‰
   - get_active_users() â†’ ["lian", "user2"]
   - ê° ì‚¬ìš©ìë³„ë¡œ:
     - set_global_user_context(user_id)
     - get_current_user_id() â†’ user_id
     - ì‚¬ìš©ì ì„¤ì • ì¡°íšŒ
     - ìë™ ë§¤ìˆ˜/ë§¤ë„ ì‹¤í–‰
```

## ğŸ’¡ ìŠ¤ì¼€ì¤„ëŸ¬ì—ì„œ `get_current_user_id()` ì‚¬ìš© ì´ìœ 

ìŠ¤ì¼€ì¤„ëŸ¬ëŠ” ì‚¬ìš©ìë³„ ë°ì´í„°ë¥¼ ì¡°íšŒí•˜ê±°ë‚˜ ì €ì¥í•˜ê¸° ìœ„í•´ `user_id`ê°€ í•„ìš”í•©ë‹ˆë‹¤.

### ì£¼ìš” ì‚¬ìš© ìœ„ì¹˜

1. **íŠ¸ë ˆì¼ë§ ìŠ¤í†± ì„œë¹„ìŠ¤**
   - ì‚¬ìš©ìë³„ íŠ¸ë ˆì¼ë§ ìŠ¤í†± ì„¤ì •/ë°ì´í„° ì¡°íšŒ

2. **ìë™ë§¤ë§¤ ì„¤ì • ì¡°íšŒ**
   - ì‚¬ìš©ìë³„ ìë™ë§¤ë§¤ ì„¤ì • í™•ì¸
   - ë³´ìœ  ì¤‘ì¸ ì¢…ëª© ë§¤ìˆ˜ í—ˆìš© ì—¬ë¶€
   - ë‹¨ì¼ ì¢…ëª© ìµœëŒ€ íˆ¬ì ë¹„ì¤‘

3. **ë¶€ë¶„ ìµì ˆ íˆìŠ¤í† ë¦¬**
   - ì‚¬ìš©ìë³„ ë¶€ë¶„ ìµì ˆ íˆìŠ¤í† ë¦¬ ì¡°íšŒ/ì €ì¥

4. **ì‹¤í˜„ ìˆ˜ìµë¥  ì—…ë°ì´íŠ¸**
   - ì‚¬ìš©ìë³„ ì‹¤í˜„ ìˆ˜ìµë¥  ê³„ì‚°/ì €ì¥

5. **í¬íŠ¸í´ë¦¬ì˜¤ ìˆ˜ìµë¥  ë¦¬í¬íŠ¸**
   - ì‚¬ìš©ìë³„ í¬íŠ¸í´ë¦¬ì˜¤ ìˆ˜ìµë¥  ê³„ì‚°

6. **ê±°ë˜ ì´ë ¥ ì €ì¥**
   - ì‚¬ìš©ìë³„ ê±°ë˜ ì´ë ¥ ì €ì¥ (`trading_logs`)

### ë°ì´í„° ë¬´ê²°ì„±

ëª¨ë“  ë°ì´í„°ì— `user_id`ë¥¼ í¬í•¨í•˜ì—¬ ì†Œìœ ìë¥¼ ëª…í™•íˆ í•©ë‹ˆë‹¤:

```python
# ì˜¬ë°”ë¥¸ ì˜ˆì‹œ
db.trading_logs.insert_one({
    "user_id": "lian",  # â† í•„ìˆ˜!
    "ticker": "AAPL",
    "action": "buy"
})
```

## ğŸ”§ êµ¬í˜„ ì„¸ë¶€ì‚¬í•­

### í™œì„± ì‚¬ìš©ì ì¡°íšŒ

```python
def get_active_users() -> List[str]:
    """
    ìë™ë§¤ë§¤ê°€ í™œì„±í™”ëœ ì‚¬ìš©ì ëª©ë¡ ì¡°íšŒ
    
    MongoDBì˜ users ì»¬ë ‰ì…˜ì—ì„œ
    trading_config.auto_trading_enabled=Trueì¸ ì‚¬ìš©ìë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.
    """
    db = get_db()
    if db is None:
        return [get_default_user_id()]
    
    # users ì»¬ë ‰ì…˜ì—ì„œ trading_config.auto_trading_enabled=Trueì¸ ì‚¬ìš©ì ì¡°íšŒ
    active_users = db.users.find({
        "trading_config.auto_trading_enabled": True
    })
    
    user_ids = [user.get("user_id") for user in active_users if user.get("user_id")]
    
    # í™œì„± ì‚¬ìš©ìê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ ì‚¬ìš©ìë§Œ ë°˜í™˜
    if not user_ids:
        return [get_default_user_id()]
    
    return user_ids
```

### ì‚¬ìš©ìë³„ ì‘ì—… ì‹¤í–‰

```python
async def _execute_auto_buy(self, send_slack_notification: bool = True):
    """ëª¨ë“  í™œì„± ì‚¬ìš©ì ëŒ€ìƒ"""
    active_users = get_active_users()
    
    for user_id in active_users:
        try:
            await self._execute_auto_buy_for_user(user_id, send_slack_notification)
        except Exception as e:
            logger.error(f"ì‚¬ìš©ì {user_id} ë§¤ìˆ˜ ì‘ì—… ì‹¤íŒ¨: {str(e)}")
            # í•œ ì‚¬ìš©ì ì‹¤íŒ¨í•´ë„ ë‹¤ë¥¸ ì‚¬ìš©ì ì‘ì—… ê³„ì† ì§„í–‰
            continue
```

### ì—ëŸ¬ ì²˜ë¦¬

- í•œ ì‚¬ìš©ì ì‹¤íŒ¨í•´ë„ ë‹¤ë¥¸ ì‚¬ìš©ì ì‘ì—…ì€ ê³„ì† ì§„í–‰
- ê° ì‚¬ìš©ì ì‘ì—…ì€ ë…ë¦½ì ìœ¼ë¡œ ì‹¤í–‰
- ì‚¬ìš©ìë³„ ì»¨í…ìŠ¤íŠ¸ê°€ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë¨

## ğŸ“Š MongoDB ë°ì´í„° êµ¬ì¡°

### users ì»¬ë ‰ì…˜

```javascript
{
  "user_id": "lian",
  "email": "lian.dy220@gmail.com",
  "display_name": "lian",
  "preferences": {
    "default_currency": "USD",
    "notification_enabled": true
  },
  "stocks": [
    {
      "ticker": "AAPL",
      "use_leverage": true,
      "is_active": true
    }
  ],
  "trading_config": {
    "auto_trading_enabled": true,
    "min_composite_score": 2.0,
    "max_stocks_to_buy": 5,
    "stop_loss_percent": -7.0,
    "take_profit_percent": 5.0
  },
  "created_at": ISODate("2024-01-01T00:00:00Z"),
  "updated_at": ISODate("2024-01-01T00:00:00Z")
}
```

### trading_logs ì»¬ë ‰ì…˜

```javascript
{
  "user_id": "lian",  // í•„ìˆ˜: ì–´ë–¤ ì‚¬ìš©ìì˜ ê±°ë˜ì¸ì§€
  "order_type": "buy",
  "ticker": "AAPL",
  "stock_name": "Apple Inc.",
  "price": 150.00,
  "quantity": 10,
  "status": "executed",
  "created_at": ISODate("2024-01-01T00:00:00Z")
}
```

## ğŸš€ í–¥í›„ í™•ì¥ ê³„íš

### Phase 1: í˜„ì¬ êµ¬í˜„ (ì™„ë£Œ)
- âœ… ì‚¬ìš©ì ì»¨í…ìŠ¤íŠ¸ ê´€ë¦¬
- âœ… ë©€í‹° ìœ ì € ìŠ¤ì¼€ì¤„ëŸ¬ ì§€ì›
- âœ… ê¶Œí•œ ê²€ì¦ ê¸°ë³¸ êµ¬ì¡°
- âœ… ë¯¸ë“¤ì›¨ì–´ ê¸°ë³¸ êµ¬ì¡°

### Phase 2: JWT í† í° ì¸ì¦ (ì„ íƒì‚¬í•­)
- [ ] JWT í† í° ë°œê¸‰
- [ ] JWT í† í° ê²€ì¦
- [ ] í† í° ê°±ì‹  ì—”ë“œí¬ì¸íŠ¸
- [ ] ë¯¸ë“¤ì›¨ì–´ì— JWT ê²€ì¦ ì¶”ê°€

### Phase 3: ë¡œê·¸ì¸ ì‹œìŠ¤í…œ (í–¥í›„)
- [ ] ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ API
- [ ] ë¹„ë°€ë²ˆí˜¸ í•´ì‹±
- [ ] ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •
- [ ] ì„¸ì…˜ ê´€ë¦¬

## âœ… ê²°ë¡ 

**ë©€í‹° ìœ ì € ì‹œìŠ¤í…œì˜ í•µì‹¬**:

1. âœ… **ì‚¬ìš©ì ì»¨í…ìŠ¤íŠ¸ ê´€ë¦¬**: ì „ì—­ ì»¨í…ìŠ¤íŠ¸ë¡œ í˜„ì¬ ì‚¬ìš©ì ì¶”ì 
2. âœ… **í™œì„± ì‚¬ìš©ì ì¡°íšŒ**: ìë™ë§¤ë§¤ í™œì„±í™”ëœ ì‚¬ìš©ì ëª©ë¡ ì¡°íšŒ
3. âœ… **ì‚¬ìš©ìë³„ ì‘ì—… ì‹¤í–‰**: ê° ì‚¬ìš©ìë³„ë¡œ ë…ë¦½ì ìœ¼ë¡œ ì‘ì—… ì‹¤í–‰
4. âœ… **ë°ì´í„° ë¬´ê²°ì„±**: ëª¨ë“  ë°ì´í„°ì— `user_id` í¬í•¨
5. âœ… **ê¶Œí•œ ê²€ì¦**: ì‚¬ìš©ìë³„ ë°ì´í„° ì ‘ê·¼ ê¶Œí•œ ê²€ì¦

**í˜„ì¬ ìƒíƒœ**:
- ë©€í‹° ìœ ì € ìŠ¤ì¼€ì¤„ëŸ¬ ì§€ì› ì™„ë£Œ
- API ì¸ì¦ì€ ê¸°ë³¸ êµ¬ì¡°ë§Œ êµ¬í˜„ (JWTëŠ” í–¥í›„)
- ì‚¬ìš©ìë³„ ë°ì´í„° ë¶„ë¦¬ ì™„ë£Œ
