# 개인화 시스템 구현 계획

## 현재 상태 분석

### 현재 개인화 수준

- ✅ 사용자별 자동매매 설정 (`trading_configs` 컬렉션)
- ✅ 사용자별 종목 설정 (`users.stocks` embedded - `use_leverage`, `tags`, `notes`)
- ❌ 추천 시스템은 전역만 지원 (`user_id: None` 고정)
- ❌ 사용자별 리스크 프로필 부재
- ❌ 사용자별 투자 스타일/선호도 부재
- ❌ 사용자별 과거 거래 이력 기반 학습 부재
- ❌ 사용자별 추천 점수 가중치 조정 불가

## 개인화 구현 영역

### 1. 사용자 프로필 확장

#### 1.1 UserPreferences 모델 확장

**파일**: `app/models/mongodb_models.py`

현재:

```python
class UserPreferences(BaseModel):
    default_currency: str = "USD"
    notification_enabled: bool = True
```

추가 필요:

- `risk_profile`: 리스크 프로필 (conservative, moderate, aggressive)
- `investment_style`: 투자 스타일 (growth, value, dividend, mixed)
- `preferred_sectors`: 선호 섹터 리스트 (예: ["Technology", "Healthcare"])
- `preferred_industries`: 선호 산업 리스트
- `investment_horizon`: 투자 기간 (short_term, medium_term, long_term)
- `min_investment_amount`: 최소 투자 금액 (USD)
- `max_investment_amount`: 최대 투자 금액 (USD)
- `rebalancing_frequency`: 리밸런싱 빈도 (weekly, monthly, quarterly)
- `recommendation_weight_ai`: AI 예측 가중치 (0.0-1.0)
- `recommendation_weight_technical`: 기술적 지표 가중치 (0.0-1.0)
- `recommendation_weight_sentiment`: 감정 분석 가중치 (0.0-1.0)

#### 1.2 사용자 거래 이력 추적

**새 컬렉션**: `user_trading_history`

```javascript
{
  user_id: String,
  ticker: String,
  action: String,  // "buy" | "sell"
  price: Number,
  quantity: Number,
  date: Date,
  profit_loss: Number,  // 실현 손익
  holding_period_days: Number,  // 보유 기간
  reason: String,  // "take_profit", "stop_loss", "technical", etc.
  success: Boolean  // 수익성이 있었는지 여부
}
```

**목적**: 사용자별 과거 거래 패턴 분석 및 학습

### 2. 추천 시스템 개인화

#### 2.1 StockRecommendationService 개인화

**파일**: `app/services/stock_recommendation_service.py`

**변경 사항**:

- `get_stock_recommendations()`: `user_id` 파라미터 추가, 사용자별 필터링
- `get_combined_recommendations_with_technical_and_sentiment()`: 사용자별 가중치 적용
- 사용자별 관심 종목 필터링 (`users.stocks.is_active=True`)
- 사용자별 선호 섹터/산업 가중치 적용
- 사용자별 리스크 프로필 기반 점수 조정

**점수 조정 로직**:

```python
# 기본 가중치
weights = {
    "ai": 0.3,
    "technical": 0.4,
    "sentiment": 0.3
}

# 사용자별 가중치 적용
if user_prefs:
    weights = {
        "ai": user_prefs.recommendation_weight_ai or 0.3,
        "technical": user_prefs.recommendation_weight_technical or 0.4,
        "sentiment": user_prefs.recommendation_weight_sentiment or 0.3
    }
    # 정규화 (합이 1.0이 되도록)
    total = sum(weights.values())
    weights = {k: v/total for k, v in weights.items()}
```

#### 2.2 사용자별 AI 분석 결과 생성

**파일**: `scripts/utils/predict.py` (예측 스크립트)

**변경 사항**:

- 전역 분석 (`user_id=None`)과 사용자별 분석 (`user_id=특정값`) 분리
- 사용자별 활성 종목만 분석 (`users.stocks.is_active=True`)
- 사용자별 설정 반영된 예측 모델 파라미터

#### 2.3 기술적 지표 추천 개인화

**파일**: `app/services/stock_recommendation_service.py`

**변경 사항**:

- `generate_technical_recommendations()`: `user_id` 파라미터 추가
- 사용자별 활성 종목만 분석
- `stock_recommendations` 컬렉션에 `user_id` 저장

### 3. 자동매매 전략 개인화

#### 3.1 AutoTradingService 개인화 강화

**파일**: `app/services/auto_trading_service.py`

**현재**: 사용자별 설정은 있으나 추천 시스템과 분리됨

**개선 사항**:

- 사용자별 관심 종목만 매수 (`users.stocks.is_active=True`)
- 사용자별 리스크 프로필에 따른 손절/익절 기준 자동 조정
  - Conservative: 손절 -5%, 익절 +3%
  - Moderate: 손절 -7%, 익절 +5% (기본값)
  - Aggressive: 손절 -10%, 익절 +8%
- 사용자별 선호 섹터 우선순위 반영
- 사용자별 과거 거래 성공률 기반 종목 필터링

#### 3.2 매수 후보 필터링 개인화

**파일**: `app/services/auto_trading_service.py` - `get_buy_candidates()`

**현재 로직**:

- 사용자별 레버리지 설정만 반영
- `use_leverage=True`인 종목만 매수

**개선 로직**:

1. 사용자별 활성 종목 필터링 (`users.stocks.is_active=True`)
2. 사용자별 선호 섹터 가중치 적용
3. 사용자별 과거 거래 이력 기반 가산점/감점
4. 사용자별 리스크 프로필에 따른 점수 조정
5. 사용자별 최소/최대 투자 금액 적용

### 4. 사용자 컨텍스트 강화

#### 4.1 UserContext 확장

**파일**: `app/utils/user_context.py`

**추가 필요**:

- 사용자 프로필 캐싱 (MongoDB 조회 최소화)
- 사용자별 설정 조회 헬퍼 메서드
- 다중 사용자 지원 (API 엔드포인트에서 사용자 ID 전달)

#### 4.2 API 라우터에 사용자 컨텍스트 주입

**파일**: `app/api/routes/auto_trading.py`, `app/api/routes/stock.py` 등

**변경 사항**:

- FastAPI Dependency Injection으로 사용자 컨텍스트 주입
- Optional user_id 파라미터 지원 (미제공 시 현재 사용자 ID 사용)

### 5. 데이터베이스 스키마 업데이트

#### 5.1 MongoDB 인덱스 추가

**파일**: `scripts/setup_mongodb_schema.py` 또는 새 스크립트

**필요한 인덱스**:

```javascript
// users 컬렉션
db.users.createIndex({ "user_id": 1 }, { unique: true })
db.users.createIndex({ "preferences.risk_profile": 1 })

// stock_recommendations 컬렉션 (기존 + 사용자별)
db.stock_recommendations.createIndex({ "user_id": 1, "date": -1 })
db.stock_recommendations.createIndex({ "user_id": 1, "ticker": 1, "date": -1 })

// stock_analysis 컬렉션 (기존 + 사용자별)
db.stock_analysis.createIndex({ "user_id": 1, "date": -1 })
db.stock_analysis.createIndex({ "user_id": 1, "ticker": 1, "date": -1 })

// user_trading_history 컬렉션 (신규)
db.user_trading_history.createIndex({ "user_id": 1, "date": -1 })
db.user_trading_history.createIndex({ "user_id": 1, "ticker": 1 })
db.user_trading_history.createIndex({ "user_id": 1, "success": 1 })
```

#### 5.2 기존 데이터 마이그레이션

- 전역 추천 데이터는 `user_id: None` 유지
- 사용자별 추천은 새로 생성 (기존 전역 추천 복사 후 사용자별 필터링 적용)

### 6. API 엔드포인트 개선

#### 6.1 추천 API에 사용자 필터링 추가

**파일**: `app/api/routes/stock.py` (예상)

**변경 사항**:

- `/recommendations` 엔드포인트에 `user_id` 쿼리 파라미터 추가 (Optional)
- 미제공 시 현재 사용자 ID 사용

#### 6.2 사용자 프로필 관리 API

**새 파일**: `app/api/routes/user_profile.py` 또는 `app/api/routes/users.py` 확장

**엔드포인트**:

- `GET /users/{user_id}/profile`: 사용자 프로필 조회
- `PUT /users/{user_id}/profile`: 사용자 프로필 업데이트
- `GET /users/{user_id}/preferences`: 사용자 선호 설정 조회
- `PUT /users/{user_id}/preferences`: 사용자 선호 설정 업데이트
- `GET /users/{user_id}/trading-history`: 거래 이력 조회

### 7. 스케줄러 개인화

#### 7.1 사용자별 스케줄링

**파일**: `app/utils/scheduler.py`

**변경 사항**:

- 각 사용자별로 독립적인 스케줄링 지원
- 사용자별 설정에 따른 실행 빈도 조정
- 사용자별 활성 종목만 분석/추천

### 8. 문서화

#### 8.1 개인화 가이드 문서 작성

**새 파일**: `docs/personalization/README.md`

**내용**:

- 개인화 기능 개요
- 사용자 프로필 설정 가이드
- 추천 시스템 개인화 원리
- API 사용 예시

## 구현 우선순위

### Phase 1: 기본 개인화 (필수)

1. ✅ UserPreferences 모델 확장
2. ✅ 추천 시스템에 user_id 파라미터 추가
3. ✅ 사용자별 활성 종목 필터링
4. ✅ 사용자별 가중치 적용

### Phase 2: 고급 개인화 (권장)

5. ✅ 사용자별 리스크 프로필 기반 전략 조정
6. ✅ 사용자별 선호 섹터/산업 가중치
7. ✅ 사용자 거래 이력 추적 및 학습

### Phase 3: 최적화 (선택)

8. ✅ 사용자별 AI 분석 결과 생성
9. ✅ 다중 사용자 지원 강화
10. ✅ 사용자별 스케줄링

## 주의사항

1. **하위 호환성**: 기존 전역 추천 (`user_id=None`)은 유지
2. **성능**: 사용자별 쿼리 증가 대비 인덱스 최적화 필수
3. **데이터 일관성**: 전역 추천과 사용자별 추천 동기화 방안 고려
4. **기본값**: 사용자 설정이 없을 때 기본값으로 동작 보장

## 구현 작업 목록

### 1. UserPreferences 모델 확장
- 리스크 프로필, 투자 스타일, 선호 섹터, 가중치 등 개인화 필드 추가

### 2. 사용자 거래 이력 추적
- `user_trading_history` 컬렉션 및 모델 생성 (거래 이력 추적용)

### 3. 추천 시스템 개인화
- `StockRecommendationService`의 추천 메서드들에 `user_id` 파라미터 추가 및 사용자별 필터링 구현

### 4. 사용자별 가중치 적용
- 사용자별 가중치를 반영한 종합 점수 계산 로직 구현

### 5. 활성 종목 필터링
- 사용자별 활성 종목(`users.stocks.is_active=True`)만 추천에 포함하는 필터링 로직 추가

### 6. 자동매매 전략 개인화
- `AutoTradingService`에 사용자별 리스크 프로필 기반 손절/익절 기준 자동 조정 로직 구현

### 7. 섹터/산업 가중치
- 사용자별 선호 섹터/산업에 따른 추천 점수 가중치 적용 로직 구현

### 8. 거래 이력 학습
- 사용자 거래 이력 분석 및 성공률 기반 종목 필터링 로직 구현

### 9. MongoDB 인덱스 업데이트
- 사용자별 조회를 위한 MongoDB 인덱스 추가 (`user_id` 기반 복합 인덱스)

### 10. API 엔드포인트 업데이트
- API 엔드포인트에 `user_id` 파라미터 추가 및 사용자 프로필 관리 API 구현

### 11. 스케줄러 개인화
- 스케줄러에 사용자별 스케줄링 지원 추가 (선택사항)

### 12. 데이터 마이그레이션
- 기존 전역 추천 데이터는 `user_id=None` 유지, 사용자별 추천은 새로 생성
