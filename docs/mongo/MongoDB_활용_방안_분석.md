# MongoDB í™œìš© ë°©ì•ˆ ë¶„ì„

## í˜„ì¬ ìƒí™© ë¶„ì„

### 1. í˜„ì¬ ë°ì´í„° êµ¬ì¡°

**daily_stock_data (ë‚ ì§œë³„ Wide Format)**
```javascript
{
  date: "2025-12-12",
  fred_indicators: {...},      // ê²½ì œ ì§€í‘œ
  yfinance_indicators: {...}, // ì‹œì¥ ì§€í‘œ
  stocks: {...},              // ì£¼ê°€ ë°ì´í„° (í‹°ì»¤ ê¸°ë°˜: {"AAPL": {"close_price": ê°€ê²©, "short_interest": {...}}})
  volumes: {...},             // ê±°ë˜ëŸ‰ ë°ì´í„°
  recommendations: {...},     // ê¸°ìˆ ì  ë¶„ì„ ì¶”ì²œ (í•˜ì´ë¸Œë¦¬ë“œ)
  sentiment: {...},           // ê°ì • ë¶„ì„ (í•˜ì´ë¸Œë¦¬ë“œ)
  predictions: {...},         // AI ì˜ˆì¸¡ ê²°ê³¼ (í•˜ì´ë¸Œë¦¬ë“œ)
  analysis: {...}             // AI ë¶„ì„ ê²°ê³¼ (í•˜ì´ë¸Œë¦¬ë“œ)
}
```
- **ì¡°íšŒ íŒ¨í„´**: ë‚ ì§œ ë²”ìœ„ ì¡°íšŒ (`$gte`, `$lte`)
- **ì‚¬ìš©ì²˜**: `mongodb_economic_repository.py` - ë‚ ì§œ ë²”ìœ„ë¡œ ê²½ì œ ë°ì´í„° ì¡°íšŒ
- **íŠ¹ì§•**: ë‚ ì§œë³„ë¡œ í•˜ë‚˜ì˜ ë¬¸ì„œ, ëª¨ë“  ì¢…ëª© ë°ì´í„° í¬í•¨

**stock_recommendations (ì¢…ëª©ë³„ Long Format)**
```javascript
{
  date: Date,
  ticker: "AAPL",
  technical_indicators: {...},
  is_recommended: Boolean
}
```
- **ì¡°íšŒ íŒ¨í„´**: ì¢…ëª©ë³„ ì‹œê³„ì—´ ì¡°íšŒ (`ticker`, `date`)
- **ì‚¬ìš©ì²˜**: ì¶”ì²œ ì¢…ëª© ì¡°íšŒ, ì¢…ëª©ë³„ ì¶”ì²œ ì´ë ¥ ë¶„ì„
- **íŠ¹ì§•**: ì¢…ëª©ë³„ë¡œ ë³„ë„ ë¬¸ì„œ, ì‹œê³„ì—´ ë¶„ì„ì— ìœ ë¦¬

---

## ì œì•ˆëœ ë°©ì•ˆ ë¶„ì„

### ë°©ì•ˆ 1: daily_stock_dataì— recommendations í•„ë“œ ì¶”ê°€

```javascript
daily_stock_data: {
  date: "2025-12-12",
  fred_indicators: {...},
  yfinance_indicators: {...},
  stocks: {...},
  recommendations: {  // âœ¨ ì¶”ê°€
    "AAPL": {...},
    "MSFT": {...}
  }
}
```

#### âœ… ì¥ì 

1. **ë‚ ì§œë³„ í†µí•© ì¡°íšŒ íš¨ìœ¨ì **
   - íŠ¹ì • ë‚ ì§œì˜ ëª¨ë“  ì •ë³´(ì£¼ê°€ + ì¶”ì²œ)ë¥¼ í•œ ë²ˆì— ì¡°íšŒ
   - API ì‘ë‹µ ì‹œê°„ ë‹¨ì¶• (1ë²ˆì˜ ì¿¼ë¦¬ë¡œ ëª¨ë“  ë°ì´í„°)

2. **ë°ì´í„° ì¼ê´€ì„±**
   - ê°™ì€ ë‚ ì§œì˜ ëª¨ë“  ë°ì´í„°ê°€ í•œ ë¬¸ì„œì—
   - íŠ¸ëœì­ì…˜ ì²˜ë¦¬ ìš©ì´

3. **MongoDBì˜ ìœ ì—°ì„± í™œìš©**
   - ìŠ¤í‚¤ë§ˆ ë³€ê²½ ì—†ì´ í•„ë“œ ì¶”ê°€ ê°€ëŠ¥
   - ë¬¸ì„œ ê¸°ë°˜ êµ¬ì¡°ì˜ ì¥ì  í™œìš©

#### âŒ ë‹¨ì 

1. **ì¢…ëª©ë³„ ì‹œê³„ì—´ ì¡°íšŒ ë¹„íš¨ìœ¨**
   ```python
   # íŠ¹ì • ì¢…ëª©ì˜ ì¶”ì²œ ì´ë ¥ì„ ì¡°íšŒí•˜ë ¤ë©´?
   # ëª¨ë“  ë‚ ì§œ ë¬¸ì„œë¥¼ ìŠ¤ìº”í•´ì•¼ í•¨
   pipeline = [
       {"$match": {"date": {"$gte": start, "$lte": end}}},
       {"$project": {"recommendations.AAPL": 1}},  # í•˜ë‚˜ì˜ ì¢…ëª©ë§Œ
       {"$unwind": ...}  # ë³µì¡í•œ ì§‘ê³„ í•„ìš”
   ]
   ```
   - ì¢…ëª©ë³„ ì‹œê³„ì—´ ë¶„ì„ ì‹œ ëª¨ë“  ë¬¸ì„œ ìŠ¤ìº” í•„ìš”
   - ì§‘ê³„ íŒŒì´í”„ë¼ì¸ì´ ë³µì¡í•´ì§

2. **ë¬¸ì„œ í¬ê¸° ì¦ê°€**
   - ì¶”ì²œ ì¢…ëª©ì´ ë§ì„ìˆ˜ë¡ ë¬¸ì„œ í¬ê¸° ì¦ê°€
   - MongoDB 16MB ì œí•œì€ ì¶©ë¶„í•˜ì§€ë§Œ, ë„¤íŠ¸ì›Œí¬ ì „ì†¡ ë¹„ìš© ì¦ê°€

3. **ì—…ë°ì´íŠ¸ ë¹„íš¨ìœ¨**
   - í•œ ì¢…ëª©ì˜ ì¶”ì²œ ì •ë³´ë§Œ ì—…ë°ì´íŠ¸í•´ë„ ì „ì²´ ë¬¸ì„œ ì—…ë°ì´íŠ¸
   - ë™ì‹œì„± ë¬¸ì œ ê°€ëŠ¥ì„±

4. **ì¸ë±ì‹± ì œí•œ**
   - Nested í•„ë“œ(`recommendations.AAPL`) ì¸ë±ì‹± ë³µì¡
   - ì¢…ëª©ë³„ ì¿¼ë¦¬ ìµœì í™” ì–´ë ¤ì›€

---

### ë°©ì•ˆ 2: stock_recommendations ì»¬ë ‰ì…˜ ìœ ì§€ (í˜„ì¬ ë°©ì‹)

#### âœ… ì¥ì 

1. **ì¢…ëª©ë³„ ì‹œê³„ì—´ ì¡°íšŒ íš¨ìœ¨ì **
   ```python
   # íŠ¹ì • ì¢…ëª©ì˜ ì¶”ì²œ ì´ë ¥ ì¡°íšŒ
   db.stock_recommendations.find({
       "ticker": "AAPL",
       "date": {"$gte": start, "$lte": end}
   }).sort("date", 1)
   ```
   - ì¸ë±ìŠ¤ í™œìš©ìœ¼ë¡œ ë¹ ë¥¸ ì¡°íšŒ
   - ì‹œê³„ì—´ ë¶„ì„ì— ìµœì í™”

2. **ë¶€ë¶„ ì—…ë°ì´íŠ¸ íš¨ìœ¨ì **
   - í•œ ì¢…ëª©ë§Œ ì—…ë°ì´íŠ¸í•´ë„ í•´ë‹¹ ë¬¸ì„œë§Œ ìˆ˜ì •
   - ë™ì‹œì„± ë¬¸ì œ ìµœì†Œí™”

3. **ì¸ë±ì‹± ìµœì í™” ìš©ì´**
   ```python
   # ë³µí•© ì¸ë±ìŠ¤ë¡œ ìµœì í™”
   db.stock_recommendations.create_index([
       ("ticker", 1), ("date", -1)
   ])
   ```

#### âŒ ë‹¨ì 

1. **ë‚ ì§œë³„ í†µí•© ì¡°íšŒ ë¹„íš¨ìœ¨**
   ```python
   # íŠ¹ì • ë‚ ì§œì˜ ëª¨ë“  ì¶”ì²œ ì¢…ëª© ì¡°íšŒ
   # ì—¬ëŸ¬ ì¿¼ë¦¬ í•„ìš” ë˜ëŠ” ë³µì¡í•œ ì§‘ê³„
   db.stock_recommendations.find({"date": target_date})
   ```
   - ë‚ ì§œë³„ë¡œ ëª¨ë“  ì¢…ëª© ì¡°íšŒ ì‹œ ì—¬ëŸ¬ ë¬¸ì„œ ì¡°íšŒ
   - ì£¼ê°€ ë°ì´í„°ì™€ ë³„ë„ ì¡°íšŒ í•„ìš”

2. **ë°ì´í„° ë¶„ì‚°**
   - ì£¼ê°€ ë°ì´í„°ì™€ ì¶”ì²œ ë°ì´í„°ê°€ ë¶„ë¦¬
   - í†µí•© ë¶„ì„ ì‹œ JOIN í•„ìš”

---

### ë°©ì•ˆ 3: í•˜ì´ë¸Œë¦¬ë“œ ì ‘ê·¼ë²• (ì¶”ì²œ â­)

**ë‘ ê°€ì§€ ëª¨ë‘ ìœ ì§€í•˜ë˜, ìš©ë„ì— ë”°ë¼ ë¶„ë¦¬**

1. **daily_stock_data.recommendations**: ë‚ ì§œë³„ í†µí•© ì¡°íšŒìš©
2. **stock_recommendations**: ì¢…ëª©ë³„ ì‹œê³„ì—´ ì¡°íšŒìš©

#### êµ¬ì¡°

```javascript
// daily_stock_data (ë‚ ì§œë³„ í†µí•© ì¡°íšŒìš©)
{
  date: "2025-12-12",
  stocks: {  // í‹°ì»¤ ê¸°ë°˜ êµ¬ì¡°
    "AAPL": {
      close_price: 274.11,
      short_interest: {
        sharesShort: 129458559,
        sharesShortPriorMonth: 115557836,
        shortRatio: 2.64,
        shortPercentOfFloat: 0.0088
      }
    },
    "MSFT": {
      close_price: 474.82,
      short_interest: {...}
    }
  },
  recommendations: {  // ê¸°ìˆ ì  ë¶„ì„ ì¶”ì²œ
    "AAPL": {
      is_recommended: true,
      recommendation_score: 2.5
    }
  },
  sentiment: {  // ê°ì • ë¶„ì„
    "AAPL": {
      sentiment_score: 0.75,
      positive_count: 10
    }
  },
  predictions: {  // AI ì˜ˆì¸¡ ê²°ê³¼
    "AAPL": {
      predicted_price: 287.26,
      actual_price: 277.18,
      forecast_horizon: 14
    }
  },
  analysis: {  // AI ë¶„ì„ ê²°ê³¼
    "AAPL": {
      metrics: { mae: 10.08, accuracy: 96.4 },
      recommendation: "Buy",
      analysis: "ê°•í•œ ìƒìŠ¹ ì‹ í˜¸..."
    }
  }
}

// stock_recommendations (ìƒì„¸ ë¶„ì„ìš©)
{
  date: Date,
  ticker: "AAPL",
  technical_indicators: {...},  // ìƒì„¸ ì§€í‘œ
  is_recommended: true
}
```

#### ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤

**ì‹œë‚˜ë¦¬ì˜¤ 1: ëŒ€ì‹œë³´ë“œ - ì˜¤ëŠ˜ì˜ ì¶”ì²œ ì¢…ëª© ë° ì˜ˆì¸¡**
```python
# daily_stock_data ì‚¬ìš© (1ë²ˆì˜ ì¿¼ë¦¬ë¡œ ëª¨ë“  ì •ë³´ ì¡°íšŒ)
data = db.daily_stock_data.find_one({"date": today})
recommended = [
    ticker for ticker, rec in data["recommendations"].items()
    if rec["is_recommended"]
]
predictions = data.get("predictions", {})
analysis = data.get("analysis", {})
# í•œ ë²ˆì˜ ì¿¼ë¦¬ë¡œ ì¶”ì²œ, ì˜ˆì¸¡, ë¶„ì„ ê²°ê³¼ ëª¨ë‘ ì¡°íšŒ ê°€ëŠ¥
```

**ì‹œë‚˜ë¦¬ì˜¤ 2: ì¢…ëª© ë¶„ì„ - AAPLì˜ ì¶”ì²œ ì´ë ¥**
```python
# stock_recommendations ì‚¬ìš© (ì¸ë±ìŠ¤ í™œìš©)
history = db.stock_recommendations.find({
    "ticker": "AAPL",
    "date": {"$gte": start, "$lte": end}
}).sort("date", 1)
```

**ì‹œë‚˜ë¦¬ì˜¤ 3: í†µê³„ ë¶„ì„ - ì¢…ëª©ë³„ ì¶”ì²œ ë¹ˆë„**
```python
# stock_recommendations ì‚¬ìš© (ì§‘ê³„ íŒŒì´í”„ë¼ì¸)
pipeline = [
    {"$match": {"is_recommended": True}},
    {"$group": {
        "_id": "$ticker",
        "count": {"$sum": 1}
    }}
]
```

#### âœ… ì¥ì 

1. **ê° ìš©ë„ì— ìµœì í™”ëœ êµ¬ì¡°**
   - ë‚ ì§œë³„ ì¡°íšŒ: daily_stock_data
   - ì¢…ëª©ë³„ ì¡°íšŒ: stock_recommendations

2. **ì„±ëŠ¥ ìµœì í™”**
   - ìì£¼ ì‚¬ìš©í•˜ëŠ” ì¿¼ë¦¬ íŒ¨í„´ì— ë§ì¶˜ êµ¬ì¡°
   - ì¸ë±ìŠ¤ í™œìš© ìµœëŒ€í™”

3. **ìœ ì—°ì„±**
   - í•„ìš”ì— ë”°ë¼ ì ì ˆí•œ ì»¬ë ‰ì…˜ ì„ íƒ
   - í™•ì¥ ìš©ì´

#### âŒ ë‹¨ì 

1. **ë°ì´í„° ì¤‘ë³µ**
   - ë‘ ê³³ì— ì €ì¥í•˜ë¯€ë¡œ ë™ê¸°í™” í•„ìš”
   - ì €ì¥ ê³µê°„ ì•½ê°„ ì¦ê°€

2. **ë³µì¡ë„ ì¦ê°€**
   - ë‘ ì»¬ë ‰ì…˜ ê´€ë¦¬ í•„ìš”
   - ì—…ë°ì´íŠ¸ ë¡œì§ ë³µì¡

---

## ì‹¤ì œ ì‚¬ìš© íŒ¨í„´ ë¶„ì„

### í˜„ì¬ ì½”ë“œì—ì„œì˜ ì‚¬ìš© íŒ¨í„´

1. **economic_service.py**
   - `daily_stock_data`ë¥¼ ë‚ ì§œ ë²”ìœ„ë¡œ ì¡°íšŒ
   - ì£¼ê°€ ë°ì´í„°ì™€ ê²½ì œ ì§€í‘œë¥¼ í•¨ê»˜ ì¡°íšŒ

2. **stock_recommendation_service.py**
   - `stock_recommendations`ë¥¼ ì¢…ëª©ë³„ë¡œ ì¡°íšŒí•˜ëŠ” ë¡œì§ì€ ì•„ì§ ì—†ìŒ
   - ì£¼ë¡œ Supabaseì˜ `stock_recommendations` í…Œì´ë¸” ì‚¬ìš©

3. **ì¿¼ë¦¬ íŒ¨í„´**
   - ë‚ ì§œë³„ ì¡°íšŒ: âœ… ìì£¼ ì‚¬ìš©
   - ì¢…ëª©ë³„ ì‹œê³„ì—´ ì¡°íšŒ: â“ í˜„ì¬ëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠìŒ

---

## ìµœì¢… ì¶”ì²œ ë°©ì•ˆ

### ğŸ¯ ì¶”ì²œ: **ë°©ì•ˆ 3 (í•˜ì´ë¸Œë¦¬ë“œ) - ë‹¨ê³„ì  ì ‘ê·¼**

#### Phase 1: daily_stock_dataì— recommendations ì¶”ê°€ (í˜„ì¬ êµ¬í˜„)

**ì´ìœ :**
- í˜„ì¬ ì‚¬ìš© íŒ¨í„´ì´ ë‚ ì§œë³„ ì¡°íšŒ ì¤‘ì‹¬
- ëŒ€ì‹œë³´ë“œ/API ì‘ë‹µ ìµœì í™”
- êµ¬í˜„ì´ ê°„ë‹¨í•˜ê³  ì¦‰ì‹œ íš¨ê³¼

**êµ¬í˜„:**
- `daily_stock_data.recommendations`ì— ìš”ì•½ ì •ë³´ ì €ì¥
- `stock_recommendations` ì»¬ë ‰ì…˜ë„ ìœ ì§€ (í–¥í›„ í™•ì¥ ëŒ€ë¹„)

#### Phase 2: ì‚¬ìš© íŒ¨í„´ ëª¨ë‹ˆí„°ë§

**í™•ì¸ ì‚¬í•­:**
- ì¢…ëª©ë³„ ì‹œê³„ì—´ ì¡°íšŒê°€ í•„ìš”í•œì§€?
- ë‚ ì§œë³„ í†µí•© ì¡°íšŒê°€ ì£¼ë¡œ ì‚¬ìš©ë˜ëŠ”ì§€?
- ì„±ëŠ¥ ì´ìŠˆê°€ ìˆëŠ”ì§€?

#### Phase 3: ìµœì í™”

**í•„ìš” ì‹œ:**
- ì¢…ëª©ë³„ ì‹œê³„ì—´ ì¡°íšŒê°€ ë§ìœ¼ë©´ `stock_recommendations` ì¸ë±ìŠ¤ ìµœì í™”
- ë‚ ì§œë³„ ì¡°íšŒê°€ ë§ìœ¼ë©´ `daily_stock_data` êµ¬ì¡° ìœ ì§€

---

## ëŒ€ì•ˆ: MongoDB Materialized View íŒ¨í„´

### ë°©ì•ˆ 4: ì§‘ê³„ ì»¬ë ‰ì…˜ ìƒì„±

```javascript
// daily_recommendations_summary (ì§‘ê³„ ê²°ê³¼ ì €ì¥)
{
  date: "2025-12-12",
  recommended_tickers: ["AAPL", "MSFT"],
  recommendation_stats: {
    total: 50,
    recommended: 10,
    avg_score: 2.3
  }
}
```

**ì¥ì :**
- ì¡°íšŒ ì„±ëŠ¥ ìµœì í™”
- ì›ë³¸ ë°ì´í„°ì™€ ë¶„ë¦¬

**ë‹¨ì :**
- ì¶”ê°€ ê´€ë¦¬ í•„ìš”
- ì‹¤ì‹œê°„ì„± ë–¨ì–´ì§

---

## ê²°ë¡ 

### âœ… ì¶”ì²œ: **í•˜ì´ë¸Œë¦¬ë“œ ì ‘ê·¼ë²• (ë°©ì•ˆ 3)**

**ì´ìœ :**
1. í˜„ì¬ ì‚¬ìš© íŒ¨í„´(ë‚ ì§œë³„ ì¡°íšŒ)ì— ìµœì í™”
2. í–¥í›„ í™•ì¥ì„± ê³ ë ¤ (ì¢…ëª©ë³„ ì¡°íšŒ ëŒ€ë¹„)
3. MongoDBì˜ ì¥ì  í™œìš© (ìœ ì—°í•œ ìŠ¤í‚¤ë§ˆ)
4. ë‹¨ê³„ì  êµ¬í˜„ ê°€ëŠ¥

**êµ¬í˜„ ì „ëµ:**
1. âœ… `daily_stock_data.recommendations` ì¶”ê°€ (ì™„ë£Œ)
2. âœ… `stock_recommendations` ì»¬ë ‰ì…˜ ìœ ì§€ (ì™„ë£Œ)
3. ğŸ“Š ì‚¬ìš© íŒ¨í„´ ëª¨ë‹ˆí„°ë§
4. ğŸ”§ í•„ìš” ì‹œ ìµœì í™”

**ì£¼ì˜ì‚¬í•­:**
- ë‘ ì»¬ë ‰ì…˜ ë™ê¸°í™” ìœ ì§€
- ë¬¸ì„œ í¬ê¸° ëª¨ë‹ˆí„°ë§ (16MB ì œí•œ)
- ì¸ë±ìŠ¤ ìµœì í™” ì§€ì†

---

## ì¶”ê°€ ê°œì„  ë°©ì•ˆ

### 1. MongoDB Aggregation í™œìš©

```python
# ë‚ ì§œë³„ ì¶”ì²œ ì¢…ëª© ì§‘ê³„ (ì‹¤ì‹œê°„)
pipeline = [
    {"$match": {"date": target_date, "is_recommended": True}},
    {"$group": {
        "_id": "$date",
        "tickers": {"$push": "$ticker"},
        "count": {"$sum": 1}
    }}
]
```

### 2. ìºì‹± ì „ëµ

```python
# ìì£¼ ì¡°íšŒí•˜ëŠ” ë‚ ì§œëŠ” Redis ìºì‹±
@cache(ttl=3600)
def get_daily_recommendations(date_str):
    return db.daily_stock_data.find_one({"date": date_str})
```

### 3. í”„ë¡œì ì…˜ í™œìš©

```python
# í•„ìš”í•œ í•„ë“œë§Œ ì¡°íšŒ
db.daily_stock_data.find_one(
    {"date": date_str},
    {"recommendations": 1, "stocks": 1}  # í•„ìš”í•œ í•„ë“œë§Œ
)
```

